<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="users.css">
</head>

<body>
    <div class="container">
        <!-- Left Sidebar - User Details -->
        <div class="user-sidebar">
            <div class="user-header">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-info">
                    <h4 id="userName"></h4>
                </div>
            </div>

            <div class="user-menu">
                <a href="/index.html" class="menu-item" id="dashboardBtn">
                    <span class="material-icons">dashboard</span>
                    Dashboard
                </a>
                <a href="/past-conversations.html" class="menu-item" id="pastAnalysisBtn">
                    <span class="material-icons">history</span>
                    Past Analysis
                </a>
                <a href="/users.html" class="menu-item active" id="usersBtn">
                    <span class="material-icons">people</span>
                    Users
                </a>
                <a href="#" class="menu-item" id="logoutBtn">
                    <span class="material-icons">logout</span>
                    Logout
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="/index.html">Dashboard</a>
                <span class="material-icons">chevron_right</span>
                <span>User Management</span>
            </div>

            <!-- Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">User Management</h1>
                    <p class="page-subtitle">Manage users, roles, and permissions</p>
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1);">
                        <span class="material-icons" style="color: #8b5cf6;">people</span>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="totalUsers">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1);">
                        <span class="material-icons" style="color: #10b981;">check_circle</span>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="activeUsers">-</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1);">
                        <span class="material-icons" style="color: #f59e0b;">admin_panel_settings</span>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="adminUsers">-</div>
                        <div class="stat-label">Admin Users</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: rgba(6, 182, 212, 0.1);">
                        <span class="material-icons" style="color: #06b6d4;">person</span>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number" id="regularUsers">-</div>
                        <div class="stat-label">Regular Users</div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="users-section">
                <div class="section-header">
                    <div class="table-header-title">
                        <h2 class="section-title">All Users</h2>
                        <span class="users-count" id="usersCount">0</span>
                    </div>
                    <div class="header-actions">
                        <div class="filter-group">
                            <span class="material-icons filter-icon">filter_list</span>
                            <select id="dateFilter" class="filter-select">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="createUserBtn">
                            <span class="material-icons">add</span>
                            Create User
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="users-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New User</h3>
                <button class="close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-row">
                        <div class="form-group required">
                            <label for="firstName">First Name</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group required">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>

                    <div class="form-group required">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group required">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required minlength="8">
                    </div>

                    <div class="form-group required">
                        <label for="role">Role</label>
                        <select id="role" name="role" required>
                            <option value="">Select a role</option>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn" form="createUserForm">Create User</button>
            </div>
        </div>
    </div>

    <script type="module">
        class UsersPage {
            constructor() {
                this.allUsers = [];
                this.initializeAuth();
                this.initializeEventListeners();
                this.loadStats();
                this.loadUsers();
            }

            async initializeAuth() {
                try {
                    const isAuthenticated = localStorage.getItem('authenticated');
                    const accessToken = localStorage.getItem('accessToken');

                    if (!isAuthenticated || !accessToken) {
                        window.location.href = '/login.html';
                        return;
                    }

                    const response = await fetch('/auth/check', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        localStorage.clear();
                        window.location.href = '/login.html';
                        return;
                    }

                    const data = await response.json();
                    this.loadUserData(data.user);
                } catch (error) {
                    console.error('Auth check failed:', error);
                    localStorage.clear();
                    window.location.href = '/login.html';
                }
            }

            initializeEventListeners() {
                document.getElementById('dashboardBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/index.html';
                });

                document.getElementById('logoutBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleLogout();
                });

                document.getElementById('pastAnalysisBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/past-conversations.html';
                });

                // Date filter listener
                document.getElementById('dateFilter').addEventListener('change', (e) => {
                    this.filterUsersByDate(e.target.value);
                });

                // Modal event listeners
                document.getElementById('createUserBtn').addEventListener('click', () => {
                    this.openCreateUserModal();
                });

                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeCreateUserModal();
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    this.closeCreateUserModal();
                });

                document.getElementById('createUserModal').addEventListener('click', (e) => {
                    if (e.target.id === 'createUserModal') {
                        this.closeCreateUserModal();
                    }
                });

                document.getElementById('createUserForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCreateUser();
                });
            }

            loadUserData(user) {
                const email = user.email || 'User';
                const name = `${user.first_name || ''} ${user.last_name || ''}`.trim() || email.split('@')[0];
                const avatar = name.substring(0, 2).toUpperCase();

                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = avatar;

                // Check if user is admin
                const userRole = user.role || localStorage.getItem('userRole');
                if (userRole !== 'admin') {
                    this.showStatus('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 2000);
                    return;
                }
            }

            async getAccessToken() {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    window.location.href = '/login.html';
                    return '';
                }
                return token;
            }

            // Load user statistics
            async loadStats() {
                try {
                    const accessToken = await this.getAccessToken();
                    const response = await fetch('/api/db/users/stats', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById('totalUsers').textContent = stats.total_users;
                        document.getElementById('activeUsers').textContent = stats.active_users;
                        document.getElementById('adminUsers').textContent = stats.admin_users;
                        document.getElementById('regularUsers').textContent = stats.regular_users;
                    } else {
                        throw new Error(data.error || 'Failed to load stats');
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                    this.showStatus('Error loading statistics: ' + error.message, 'error');
                }
            }

            // Load all users
            async loadUsers() {
                try {
                    const accessToken = await this.getAccessToken();
                    const response = await fetch('/api/db/users/get_all', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {
                        this.allUsers = data.users;
                        this.renderUsersTable(this.allUsers);
                    } else {
                        throw new Error(data.error || 'Failed to load users');
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.showStatus('Error loading users: ' + error.message, 'error');
                }
            }

            // Filter users by date
            filterUsersByDate(filter) {
                if (!this.allUsers || this.allUsers.length === 0) {
                    return;
                }

                let filteredUsers = [...this.allUsers];
                const now = new Date();
                
                switch(filter) {
                    case 'today':
                        filteredUsers = filteredUsers.filter(user => {
                            const createdDate = new Date(user.created_at);
                            return createdDate.toDateString() === now.toDateString();
                        });
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredUsers = filteredUsers.filter(user => {
                            const createdDate = new Date(user.created_at);
                            return createdDate >= weekAgo;
                        });
                        break;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredUsers = filteredUsers.filter(user => {
                            const createdDate = new Date(user.created_at);
                            return createdDate >= monthAgo;
                        });
                        break;
                    case 'all':
                    default:
                        break;
                }

                // Sort by created_at (newest first)
                filteredUsers.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                this.renderUsersTable(filteredUsers);
            }

            // Render users table
            renderUsersTable(users) {
                const tbody = document.getElementById('usersTableBody');
                
                // Update user count badge
                document.getElementById('usersCount').textContent = users.length;

                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 60px 20px;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                                    <span class="material-icons" style="font-size: 48px; color: #cbd5e1;">person_off</span>
                                    <div style="color: #64748b; font-size: 16px; font-weight: 500;">No users found</div>
                                    <div style="color: #94a3b8; font-size: 14px;">Try adjusting your filters or create a new user</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                
                                <div>
                                    <strong>${user.first_name || ''} ${user.last_name || ''}</strong>
                                    ${!user.first_name && !user.last_name ? '<em style="color: #94a3b8;">No name</em>' : ''}
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            <span class="role-badge role-${user.role}">
                                ${user.role}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-${user.is_active ? 'active' : 'inactive'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="color: #64748b;">
                            ${user.last_login ? new Date(user.last_login).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Never'}
                        </td>
                        <td style="color: #64748b;">
                            ${new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                        </td>
                    </tr>
                `).join('');
            }

            // Show status message
            showStatus(message, type = 'success') {
                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;
                statusDiv.style.position = 'fixed';
                statusDiv.style.top = '20px';
                statusDiv.style.right = '20px';
                statusDiv.style.zIndex = '10000';
                statusDiv.style.display = 'block';
                statusDiv.style.minWidth = '300px';

                document.body.appendChild(statusDiv);

                setTimeout(() => {
                    statusDiv.remove();
                }, 5000);
            }

            openCreateUserModal() {
                document.getElementById('createUserModal').style.display = 'block';
                document.getElementById('firstName').focus();
            }

            closeCreateUserModal() {
                document.getElementById('createUserModal').style.display = 'none';
                document.getElementById('createUserForm').reset();
            }

            async handleCreateUser() {
                try {
                    const form = document.getElementById('createUserForm');
                    const formData = new FormData(form);

                    const userData = {
                        first_name: formData.get('firstName'),
                        last_name: formData.get('lastName'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        role: formData.get('role')
                    };

                    // Validate form
                    if (!userData.first_name || !userData.last_name || !userData.email || !userData.password || !userData.role) {
                        this.showStatus('Please fill in all required fields', 'error');
                        return;
                    }

                    // Disable submit button and show loading
                    const submitBtn = document.getElementById('submitBtn');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';

                    const accessToken = await this.getAccessToken();
                    const response = await fetch('/api/db/users/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(userData)
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.showStatus('User created successfully!', 'success');
                        this.closeCreateUserModal();

                        // Refresh the users table and stats
                        await this.loadUsers();
                        await this.loadStats();
                    } else {
                        this.showStatus(data.error || 'Failed to create user', 'error');
                    }

                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;

                } catch (error) {
                    console.error('Error creating user:', error);
                    this.showStatus('Error creating user: ' + error.message, 'error');

                    // Re-enable submit button
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create User';
                }
            }

            async handleLogout() {
                try {
                    localStorage.removeItem('authenticated');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('accessToken');

                    window.location.href = '/login.html';
                } catch (error) {
                    console.error('Logout failed:', error);
                    window.location.href = '/login.html';
                }
            }
        }

        let usersPage;

        document.addEventListener('DOMContentLoaded', function () {
            usersPage = new UsersPage();
        });
    </script>
</body>

</html>