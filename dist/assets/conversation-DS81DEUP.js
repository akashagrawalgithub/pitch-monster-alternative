import"./modulepreload-polyfill-B5Qt9EMX.js";function Pe(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function Le(){const e=document.createElement("div");e.id="rulesOverlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10000",e.style.pointerEvents="auto";const t=document.createElement("div");t.style.background="#ffffff",t.style.borderRadius="16px",t.style.padding="32px",t.style.maxWidth="500px",t.style.width="90%",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.border="1px solid #e2e8f0",t.style.position="relative";const o=document.createElement("h2");o.innerHTML="Hey 👋 Please take a look at the rules for role-play done right.",o.style.fontSize="20px",o.style.fontWeight="700",o.style.color="#1e293b",o.style.marginBottom="24px",o.style.lineHeight="1.4";const r=document.createElement("ul");r.style.listStyle="none",r.style.padding="0",r.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile 😊","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(w=>{const f=document.createElement("li");f.style.display="flex",f.style.alignItems="flex-start",f.style.gap="12px",f.style.marginBottom="16px",f.style.fontSize="15px",f.style.lineHeight="1.6",f.style.color="#475569";const m=document.createElement("span");m.innerHTML="•",m.style.color="#8b5cf6",m.style.fontWeight="bold",m.style.fontSize="18px",m.style.lineHeight="1.2";const u=document.createElement("span");u.textContent=w,f.appendChild(m),f.appendChild(u),r.appendChild(f)});const s=document.createElement("p");s.innerHTML="Let's go 🚀",s.style.fontSize="16px",s.style.fontWeight="700",s.style.color="#1e293b",s.style.marginBottom="24px",s.style.marginTop="0";const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="12px",i.style.marginBottom="24px",i.style.padding="16px",i.style.background="#f8fafc",i.style.borderRadius="8px",i.style.border="1px solid #e2e8f0";const l=document.createElement("input");l.type="checkbox",l.id="rulesCheckbox",l.style.width="18px",l.style.height="18px",l.style.cursor="pointer",l.style.accentColor="#8b5cf6";const a=document.createElement("label");a.htmlFor="rulesCheckbox",a.textContent="I have read and understood the rules above",a.style.fontSize="14px",a.style.fontWeight="500",a.style.color="#475569",a.style.cursor="pointer",a.style.flex="1",i.appendChild(l),i.appendChild(a);const c=document.createElement("button");c.textContent="I agree",c.id="agreeButton",c.style.background="#e2e8f0",c.style.color="#64748b",c.style.border="none",c.style.borderRadius="12px",c.style.padding="14px 24px",c.style.fontSize="16px",c.style.fontWeight="600",c.style.cursor="not-allowed",c.style.width="100%",c.style.transition="all 0.2s",c.disabled=!0,t.appendChild(o),t.appendChild(r),t.appendChild(s),t.appendChild(i),t.appendChild(c),e.appendChild(t),document.body.appendChild(e);const d=()=>{l.checked?(c.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",c.style.color="white",c.style.cursor="pointer",c.disabled=!1,c.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(c.style.background="#e2e8f0",c.style.color="#64748b",c.style.cursor="not-allowed",c.disabled=!0,c.style.boxShadow="none")};l.addEventListener("change",d),c.addEventListener("click",()=>{c.disabled||e.remove()}),e.addEventListener("click",w=>{w.target})}function Me(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",Le();const e=document.createElement("div");e.className="top-bar",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="50px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="15px",e.style.padding="0 18px",e.style.background="rgba(255,255,255,0.25)",e.style.backdropFilter="blur(12px)",e.style.zIndex="100",e.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",e.style.overflow="visible";const t=document.createElement("button");t.innerHTML="← Back to details",t.style.position="fixed",t.style.top="8px",t.style.left="18px",t.style.background="rgba(255,255,255,0.9)",t.style.border="1px solid rgba(0,0,0,0.1)",t.style.borderRadius="8px",t.style.padding="6px 12px",t.style.fontSize="13px",t.style.fontWeight="500",t.style.color="#374151",t.style.cursor="pointer",t.style.transition="all 0.2s",t.style.zIndex="200",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.onclick=()=>window.location.href="/agent-info.html",t.onmouseover=()=>{t.style.background="rgba(255,255,255,0.95)",t.style.transform="translateY(-1px)"},t.onmouseout=()=>{t.style.background="rgba(255,255,255,0.9)",t.style.transform="translateY(0)"};const o=localStorage.getItem("selectedAgentType")||"payment-followup",r={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},n=document.createElement("div");n.textContent=r[o]||"Sales Training",n.style.fontSize="18px",n.style.fontWeight="500",n.style.letterSpacing="0.5px",n.style.color="#23272f",n.style.opacity="0.92",n.style.whiteSpace="nowrap";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px",s.style.fontSize="1.1rem",s.style.color="#23272f",s.style.fontWeight="500",s.style.opacity="0.85",s.style.whiteSpace="nowrap";const i=document.createElement("span");i.id="timer",i.textContent="00:00";const l=document.createElement("span");l.id="recordingDot",l.textContent="•",l.style.fontSize="1.5em",l.style.color="#e11d48",l.style.opacity="0",l.style.transition="opacity 0.3s",s.appendChild(i),s.appendChild(l),e.appendChild(t),e.appendChild(n),e.appendChild(s),document.body.appendChild(e);const a=document.createElement("div");a.id="customerName",a.style.position="fixed",a.style.left="50%",a.style.top="50px",a.style.transform="translateX(-50%)",a.style.zIndex="10",a.style.color="#1e293b",a.style.fontSize="16px",a.style.fontWeight="600",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.pointerEvents="none",a.style.background="rgba(255, 255, 255, 0.9)",a.style.padding="8px 16px",a.style.marginTop="36px",a.style.borderRadius="20px",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",a.style.border="1px solid rgba(226, 232, 240, 0.8)";const c=localStorage.getItem("selectedAgentName")||"Customer";a.textContent=`Customer Name: ${c}`,document.body.appendChild(a);const d=document.createElement("div");d.className="voice-wave-area",d.id="voiceWaveArea",d.style.position="fixed",d.style.top="50px",d.style.left="0",d.style.width="100vw",d.style.height="calc(100vh - 50px)",d.style.display="flex",d.style.flexDirection="column",d.style.justifyContent="center",d.style.alignItems="center",d.style.zIndex="1",d.style.background="transparent";const w=document.createElement("div");w.className="voice-wave-container",w.id="voiceWaveContainer",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.gap="4px",w.style.height="60px";for(let q=0;q<20;q++){const R=document.createElement("div");R.className="voice-wave-bar",R.style.width="3px",R.style.height="4px",R.style.background="rgba(37,99,235,0.3)",R.style.borderRadius="2px",R.style.transition="height 0.1s ease",w.appendChild(R)}d.appendChild(w),document.body.appendChild(d);const f=document.createElement("div");f.id="hiddenTranscript",f.style.display="none",document.body.appendChild(f);const m=document.createElement("div");m.className="mic-wrap",m.style.position="fixed",m.style.left="50%",m.style.bottom="48px",m.style.transform="translateX(-50%)",m.style.zIndex="20",m.style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",m.style.gap="24px";const u=document.createElement("div");u.className="ocean-animation",u.style.position="absolute",u.style.left="50%",u.style.top="50%",u.style.transform="translate(-50%, -50%)",u.style.zIndex="-1",u.style.pointerEvents="none",u.style.width="160px",u.style.height="160px";const y=document.createElement("button");y.className="voice-btn mic-btn",y.id="micBtn",y.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>',y.style.minWidth="180px",y.style.height="50px",y.style.borderRadius="25px",y.style.background="#8b5cf6",y.style.color="#fff",y.style.border="none",y.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.padding="0 24px",y.style.cursor="pointer",y.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",y.style.position="relative",y.style.outline="none",y.style.visibility="visible",m.appendChild(y),m.appendChild(u),document.body.appendChild(m);const P=document.createElement("link");P.rel="stylesheet",P.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(P);const T=document.createElement("style");T.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(T);function Y(q){if(u.innerHTML="",q)for(let R=0;R<2;R++){const L=document.createElement("div");L.className="wave"+(R===1?" wave2":""),L.style.width="0px",L.style.height="0px",L.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",L.style.position="absolute",L.style.left="50%",L.style.top="50%",L.style.transform="translate(-50%, -50%)",u.appendChild(L)}}window.showOceanAnimation=Y}Pe()?Me():window.location.href="/login.html";let g=null,b=!1,v=!1,ie=null,X=0,C=[],k=!1,K=!1,p=null,ee=!1,F=[],E=!1,h=null,U=[],W=!1,G="",me=null,fe=!1,ge=!1,B=!1,j=!1,S=!1,D=null,z=[],te=!1,le=null,ye=0,A=null,N=null;const x=document.getElementById("micBtn"),Se=document.getElementById("timer"),We=document.getElementById("voiceWaveContainer"),xe=document.getElementById("hiddenTranscript");let I="";function ue(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}function Ne(){X=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),Se.textContent=ue(X),ie=window.setInterval(()=>{X++,Se.textContent=ue(X)},1e3)}function Te(){ie&&(clearInterval(ie),ie=null)}function $(e,t){const o=ue(X);C.push({sender:e,text:t,time:o});const r=document.createElement("div");r.className="transcript-item "+(e==="AI"?"ai":"you"),r.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content">${t}</div>
        <div class="transcript-meta">${e}  ${o}</div>
    `,xe.appendChild(r)}function Oe(){C=[],we=-1,xe.innerHTML="",pe()}function Ee(){if(b||v||k)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){alert("Your browser does not support Web Speech API.");return}if(g=new e,g.lang="en-US",g.interimResults=!0,g.maxAlternatives=1,g.continuous=!0,"webkitSpeechRecognition"in window){g.continuous=!0,g.interimResults=!0,g.maxAlternatives=1;try{g.serviceURI="https://www.google.com/speech-api/v2/recognize"}catch{}}b=!0,v=!1;let t="";I="";let o=null,r=null;g.onresult=s=>{pe(),(B||ee||E||j)&&(he(),p&&p.state!=="closed"&&p.suspend().then(()=>{p.resume()}).catch(a=>console.log("Audio context suspend/resume error:",a)));let i="",l=!1;for(let a=s.resultIndex;a<s.results.length;a++){const c=s.results[a][0].transcript;s.results[a].isFinal?(t+=c,I+=c,l=!0):i+=c}if(i&&!l){(B||ee||E||j)&&(he(),p&&p.state!=="closed"&&p.suspend().then(()=>{p.resume()}).catch(c=>console.log("Audio context suspend/resume error:",c))),o||(o=De("You"));const a=(I+" "+i).trim();o.update(a),de(!0),S=!0,r&&(clearTimeout(r),r=null)}l&&t.trim()&&(r=window.setTimeout(()=>{if(t.trim().length>0){const a=t.trim();if(t="",a.length>=3){typeof performance<"u"?performance.now():Date.now(),setTimeout(()=>{C.slice(),Ye(a)},200),I="";const c=document.querySelector(".transcript-item.you .transcript-content");c&&(c.textContent="")}else I+=" "+a}r=null,S=!1},500))},g.onerror=s=>{console.error("Speech recognition error:",s.error),s.error==="network"?(console.warn("Network error in speech recognition, attempting restart..."),setTimeout(()=>{b&&!k&&(g==null||g.start())},1e3)):s.error==="aborted"?(console.log("Speech recognition was aborted"),b=!1,v=!1,k=!1):s.error==="audio-capture"?(console.error("Audio capture error - microphone issue"),b=!1,v=!1,k=!1,alert("Microphone access error. Please check your microphone permissions and try again.")):s.error==="not-allowed"?(console.error("Speech recognition not allowed"),b=!1,v=!1,k=!1,alert("Speech recognition permission denied. Please allow microphone access and reload the page.")):(console.warn(`Speech recognition error: ${s.error}, attempting restart...`),k=!1,setTimeout(()=>{b&&!k&&J("error-recovery")},2e3))},g.onstart=()=>{k=!0},g.onend=()=>{if(k=!1,b&&!v&&!k&&b){const s=o?o.getText():"",i=t,l=I;setTimeout(()=>{b&&!k&&(i&&(t=i),l&&(I=l),J("natural-end"),s&&o&&setTimeout(()=>{o&&o.update(s)},150))},100)}},g.start(),g.startTime=Date.now(),ve();const n=setInterval(()=>{if(!b){clearInterval(n);return}const s=Date.now();if(g&&g.startTime&&s-g.startTime>2*60*1e3){g.startTime=s,J("mandatory-2min-restart");return}if(b&&!k&&!v&&!K){J("critical-restart");return}if(b&&!k&&s-((g==null?void 0:g.startTime)||0)>3e4){J("long-inactive-restart");return}if(b&&!O&&!H){re().catch(i=>{console.error("Reconnection failed:",i),setTimeout(()=>{b&&re()},1e3)});return}},1e3)}function he(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),h){try{h.stop(),h.disconnect()}catch(e){console.log("Error stopping current source:",e)}h=null}if(p&&p.state!=="closed")try{const e=p.currentTime;p.suspend().then(()=>{p.resume()}).catch(t=>console.log("Audio context suspend/resume error:",t))}catch(e){console.log("Audio context error:",e)}if(F=[],Q=[],ee=!1,E=!1,W=!1,U=[],B=!1,M=0,j=!1,_&&O)try{const e={type:"response.cancel"};_.send(JSON.stringify(e))}catch(e){console.log("Error stopping realtime response:",e)}}function Fe(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),h){try{h.stop(),h.disconnect()}catch{}h=null}F=[],ee=!1,E=!1,U=[],W=!1}function J(e="manual"){if(!(K||!b)){K=!0;try{g&&k&&g.stop(),setTimeout(()=>{if(b&&!k)try{g==null||g.start()}catch(t){console.error("Restart failed:",t),Ee()}K=!1},100)}catch(t){console.error("Error in safe restart:",t),K=!1}}}function $e(){if(b=!1,v=!1,k=!1,K=!1,pe(),g)try{g.stop()}catch{}if(I.trim()||G.trim()){const t=[];I&&I.trim()&&t.push(I.trim()),G&&G.trim()&&t.push(G.trim());const o=document.querySelector(".transcript-item.you .transcript-content");if(o&&o.textContent&&o.textContent.trim()){const r=o.textContent.trim();r.length>0&&t.push(r)}}G="",I="";const e=document.querySelector(".transcript-item.you .transcript-content");e&&(e.textContent="")}async function Ue(e){try{const t=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();await He(o.audio_data,"pcm_f32le",o.sample_rate)}catch(t){if(console.error("Cartesia TTS error:",t),window.speechSynthesis){const o=new SpeechSynthesisUtterance(e);o.rate=.9,o.pitch=1,window.speechSynthesis.speak(o)}}}async function He(e,t="pcm_f32le",o=44100){const r=Uint8Array.from(atob(e),n=>n.charCodeAt(0));await Re(r.buffer,o)}async function Je(e){try{const t=je(e),o=new FormData;o.append("file",t,"ai_response.wav"),o.append("model","whisper-1"),o.append("language","en");const r=await ze(),n=await fetch("/api/db/transcribe_audio",{method:"POST",headers:{Authorization:`Bearer ${r}`},body:o});if(n.ok){const s=await n.json(),i=s.text||s.transcript||"AI response transcribed";$("AI",i)}else{const s=await n.text();console.error("Audio transcription failed:",n.status,s);const i=C.filter(a=>a.sender==="You").pop();let l="[AI provided audio response]";if(i){const a=i.text.toLowerCase();a.includes("sales skill")||a.includes("practice")?l="I'd be happy to help you practice your sales skills! What specific area would you like to work on?":a.includes("close")||a.includes("deal")?l="Great! Let's work on your closing techniques. What type of deals are you looking to close?":a.includes("name")?l="I'm your AI sales training coach. I'm here to help you improve your sales skills!":l="I understand. Let me help you with that. Can you tell me more about what you'd like to work on?"}$("AI",l)}}catch(t){console.error("Error transcribing AI audio:",t),$("AI","[AI Response - Audio Only]")}}function je(e){const t=e.length,o=e.sampleRate,r=new ArrayBuffer(44+t*2),n=new DataView(r),s=(a,c)=>{for(let d=0;d<c.length;d++)n.setUint8(a+d,c.charCodeAt(d))};s(0,"RIFF"),n.setUint32(4,36+t*2,!0),s(8,"WAVE"),s(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,o,!0),n.setUint32(28,o*2,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),s(36,"data"),n.setUint32(40,t*2,!0);const i=e.getChannelData(0);let l=44;for(let a=0;a<t;a++){const c=Math.max(-1,Math.min(1,i[a]));n.setInt16(l,c<0?c*32768:c*32767,!0),l+=2}return new Blob([r],{type:"audio/wav"})}async function Re(e,t){if(S){console.log("User is speaking, skipping audio playback");return}if(p||(p=new(window.AudioContext||window.webkitAudioContext)),p.state==="suspended")try{await p.resume()}catch(o){console.error("Failed to resume audio context:",o);return}try{const o=p.createBuffer(1,e.byteLength/4,t),r=o.getChannelData(0),n=new Float32Array(e);r.set(n),h&&(h.stop(),h.disconnect()),h=p.createBufferSource(),h.buffer=o,h.addEventListener("ended",()=>{S&&console.log("Audio playback ended due to user speech")});const s=()=>{if(S&&h)try{h.stop(),h.disconnect(),h=null}catch(l){console.log("Error stopping audio on user speech:",l)}},i=setInterval(()=>{S&&(s(),clearInterval(i))},50);h.addEventListener("ended",()=>{clearInterval(i)}),h.connect(p.destination),A&&te&&h.connect(A),!ge&&me!=null&&(ge=!0),h.start()}catch(o){console.error("Error playing raw PCM audio:",o)}}function Ye(e,t){if(v||B)return;he(),v=!0,B=!0,$("You",e);const o=De("AI");let r="",n="";me=typeof performance<"u"?performance.now():Date.now(),fe=!1,ge=!1,j=!1;const s=setTimeout(()=>{v&&(v=!1,B=!1)},15e3);Ze(e,i=>{if(!fe&&me!=null?(fe=!0,r+=i,o.update(r),n+=i):(r+=i,o.update(r),n+=i),qe(n)){const l=ke(n);l.length>0&&(U.push(...l),n="",W||(typeof performance<"u"?performance.now():Date.now(),Ie()))}}).then(()=>{if(n.trim()){const i=ke(n.trim());U.push(...i),W||(typeof performance<"u"?performance.now():Date.now(),Ie())}r.trim()&&$("AI",r.trim()),r="",n="",v=!1,B=!1,clearTimeout(s),setTimeout(()=>{b&&!k&&!v&&(J("after-ai-response"),ve())},0),rt(),window.gc&&window.gc()}).catch(i=>{console.error("AI response error:",i.message),r="",n="",v=!1,B=!1,clearTimeout(s),setTimeout(()=>{b&&!k&&!v&&J("after-ai-error")},1e3),window.gc&&window.gc()})}function qe(e){return!!(/[.!?]\s*$/.test(e)||/, \s*$/.test(e)||e.length>150)}function ke(e){const t=e.trim();if(!t)return[];if(/[.!?]\s*$/.test(t))return[t];if(/, \s*$/.test(t))return[t];if(t.length>150){const o=t.match(/.*[.!?]\s*$/);if(o)return[o[0].trim()]}return[]}async function Ve(){if(!(F.length===0||E)){for(E=!0;F.length>0&&!S;){const e=F.shift();try{await Re(e,44100),h&&!S&&await new Promise(t=>{const o=()=>{S&&console.log("Queue playback stopped due to user speech"),t()};h.onended=o})}catch(t){console.error("Error playing audio from queue:",t)}if(S){console.log("Stopping queue playback due to user speech");break}}E=!1,S||setTimeout(()=>{Ge()},0)}}async function Ie(){if(!W){for(W=!0;U.length>0&&!S;){const e=U.splice(0,2);for(let t=0;t<e.length;t++){const o=e[t];if(S){console.log("Stopping audio buffering due to user speech");break}try{const r=await Qe(o);F.push(r),!E&&!S&&Ve()}catch(r){console.error("Cartesia TTS error:",r);try{S||await Ue(o)}catch(n){console.error("Fallback TTS error:",n)}}}}W=!1}}function Ge(){!W&&F.length}async function Qe(e){return new Promise((t,o)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(r=>{var c;if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const n=(c=r.body)==null?void 0:c.getReader(),s=new TextDecoder("utf-8");let i="",l=[];async function a(){try{const{done:d,value:w}=await n.read();if(d){if(l.length>0){const m=new Uint8Array(l.reduce((y,P)=>y+P.length,0));let u=0;for(const y of l)m.set(y,u),u+=y.length;l=[],window.gc&&window.gc(),t(m.buffer)}else o(new Error("No audio data received"));return}i+=s.decode(w,{stream:!0});let f=i.split(/\r?\n/);i=f.pop()||"";for(const m of f)if(m.startsWith("data: "))try{const u=JSON.parse(m.slice(6));if(u.audio_chunk){const y=Uint8Array.from(atob(u.audio_chunk),P=>P.charCodeAt(0));l.push(y)}else u.status==="complete"||u.error&&o(new Error(u.error))}catch{}a()}catch(d){o(d)}}a()}).catch(o)})}function De(e){const t=ue(X),o=document.createElement("div");o.className="transcript-item "+(e==="AI"?"ai":"you"),o.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${e}  ${t}</div>
    `;const r=o.querySelector(".transcript-content");return xe.appendChild(o),{update:n=>{r.textContent=n},remove:()=>{r.textContent=""},getText:()=>r.textContent||""}}let _=null,O=!1,H=!1,V=null,Q=[],Ae=24e3,se="",M=0,Z="",we=-1,ce=null;function pe(){ce&&(clearTimeout(ce),ce=null)}function ve(){pe(),ce=window.setTimeout(()=>{b&&!B&&!ee&&!E&&!j&&!S&&!v&&(console.log("System idle for 5 seconds, prompting user..."),Xe())},5e3)}function Xe(){if(!(!b||B||ee||E||j||S||v)){if(console.log('Sending idle prompt: "are you there"'),$("AI","are you there"),_&&O)try{const e={type:"conversation.item.create",item:{type:"message",role:"assistant",content:[{type:"output_text",text:"are you there"}]}};_.send(JSON.stringify(e))}catch(e){console.log("Error sending idle prompt:",e)}ve()}}async function Ke(){const e=localStorage.getItem("selectedAgentType")||"discovery-call";try{const t=await fetch(`/api/get_agent_prompt?agent_type=${e}`);if(t.ok){const o=await t.json();o.success&&o.prompt?Z=o.prompt:(console.error("Invalid response format:",o),Z="You are a helpful sales training coach. Speak naturally and concisely.")}else{const o=await t.text();console.error("Failed to fetch agent prompt:",t.status,o),Z="You are a helpful sales training coach. Speak naturally and concisely."}}catch(t){console.error("Error fetching agent prompt:",t),Z="You are a helpful sales training coach. Speak naturally and concisely."}}async function re(e){return new Promise(async(t,o)=>{if(O&&_){V=e||null,t();return}if(H){const n=setInterval(()=>{O&&(clearInterval(n),V=e||null,t())},100);return}let r;try{const n=await fetch("/api/openai-realtime-token",{method:"GET"});if(!n.ok)throw new Error("Failed to get OpenAI token");const i=(await n.json()).token,a=`wss://api.openai.com/v1/realtime?model=${encodeURIComponent("gpt-4o-realtime-preview-2024-12-17")}`;H=!0,V=e||null;const c=["realtime",`openai-insecure-api-key.${i}`];r=new WebSocket(a,c),_=r;const d=setTimeout(()=>{r.readyState===WebSocket.CONNECTING&&(console.error("WebSocket connection timeout"),r.close(),o(new Error("WebSocket connection timeout after 10 seconds")))},1e4);r.addEventListener("open",()=>{clearTimeout(d)})}catch(n){console.error("Connection establishment error:",n),o(new Error("Failed to establish connection: "+n.message));return}r.onopen=()=>{O=!0,H=!1;const n=Z||"You are a helpful sales training coach.";console.log("Instructions:",n);const s={type:"session.update",session:{type:"realtime",model:"gpt-4o-realtime-preview",instructions:n,tools:[],tool_choice:"none"}};r.send(JSON.stringify(s)),setTimeout(()=>{const i={type:"response.create",response:{instructions:"Start the conversation by saying: 'Hey, who's this?'",modalities:["audio"],voice:"alloy"}};r.send(JSON.stringify(i))},200),t()},r.onerror=n=>{H=!1,console.error("Realtime WebSocket error:",n),console.error("WebSocket readyState:",r.readyState),console.error("WebSocket URL:",r.url),o(new Error("Realtime WebSocket error: "+JSON.stringify(n)))},r.onclose=n=>{O=!1,H=!1,_=null,V=null,Q=[],console.error("WebSocket closed:",n.code,n.reason),console.error("Close event details:",n),b&&setTimeout(()=>{b&&!O&&!H&&re()},2e3)},r.onmessage=async n=>{try{const s=JSON.parse(n.data),i=s.type;if(i==="response.output_text.delta"){const l=s.delta;if(l&&l.includes("tool_uses"))return;s.delta&&(se+=s.delta),V&&s.delta&&V(s.delta)}else if(i!=="response.output_text.done")if(i==="response.output_audio.delta"){if(S||I.trim()){console.log("User is speaking, skipping AI audio chunk");return}j=!0;const l=s.delta;if(l){const a=atob(l),c=new Int16Array(a.length/2);for(let u=0;u<a.length;u+=2)c[u/2]=a.charCodeAt(u)|a.charCodeAt(u+1)<<8;Q.push(c);const d=new Float32Array(c.length);for(let u=0;u<c.length;u++)d[u]=Math.max(-1,Math.min(1,c[u]/32768));p||(p=new(window.AudioContext||window.webkitAudioContext)),p.state==="suspended"&&await p.resume();const w=p.createBuffer(1,d.length,Ae);w.copyToChannel(d,0);const f=p.createBufferSource();f.buffer=w,f.connect(p.destination),A&&te&&f.connect(A);const m=w.duration;(M===0||M<p.currentTime)&&(M=p.currentTime),f.start(M),M+=m,h=f,f.addEventListener("ended",()=>{S&&console.log("AI audio chunk ended due to user speech")})}}else if(i==="response.output_audio.done"){const l=Q.reduce((f,m)=>f+m.length,0),a=new Int16Array(l);let c=0;for(const f of Q)a.set(f,c),c+=f.length;const d=new Float32Array(a.length);for(let f=0;f<a.length;f++)d[f]=Math.max(-1,Math.min(1,a[f]/32768));p||(p=new(window.AudioContext||window.webkitAudioContext));const w=p.createBuffer(1,d.length,Ae);w.copyToChannel(d,0),window.lastAIAudioBuffer=w,window.lastAIAudioTime=Date.now(),Q=[],M=0}else if(i==="response.created")se="",M=0;else if(i==="response.done"){let l=se.trim();l.includes("tool_uses")&&(l=l.replace(/\{"tool_uses":\[.*?\]\}/g,"").trim()),l?$("AI",l):window.lastAIAudioBuffer?Je(window.lastAIAudioBuffer):$("AI","[AI provided audio response]"),se=""}else i==="session.updated"||i==="error"&&(console.error("Realtime error:",s),console.error("Error details:",JSON.stringify(s.error,null,2)))}catch{}}})}async function Ze(e,t){if(await re(t),!_)return;for(let n=we+1;n<C.length;n++){const s=C[n],i={type:"conversation.item.create",item:{type:"message",role:s.sender==="You"?"user":"assistant",content:[{type:"output_text",text:s.text}]}};_.send(JSON.stringify(i))}we=C.length-1;const o={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:e}]}};_.send(JSON.stringify(o));const r={type:"response.create"};_.send(JSON.stringify(r))}function et(e){const t=document.getElementById("recordingDot");t&&t.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(e)}function de(e){We.querySelectorAll(".voice-wave-bar").forEach(o=>{e?o.classList.add("active"):o.classList.remove("active")})}async function tt(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});le=e,p||(p=new(window.AudioContext||window.webkitAudioContext)),A=p.createMediaStreamDestination(),N=p.createMediaStreamSource(e),N.connect(A);let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm"),MediaRecorder.isTypeSupported(t)||(t="audio/mp4"),MediaRecorder.isTypeSupported(t)||(t="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(t)||(t="audio/wav"),D=new MediaRecorder(A.stream,{mimeType:t}),z=[],te=!0,ye=Date.now(),D.ondataavailable=o=>{o.data.size>0&&z.push(o.data)},D.onstop=()=>{if(z.length>0){const o=new Blob(z,{type:t}),r=new FileReader;r.onload=()=>{const n=r.result;window.conversationRecordingData=n,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const s=(Date.now()-ye)/1e3;sessionStorage.setItem("recordingDuration",s.toString())},r.readAsDataURL(o)}N&&(N.disconnect(),N=null),A&&(A.disconnect(),A=null),e&&e.getTracks().forEach(o=>o.stop())},D.start(1e3)}catch(e){console.error("Error starting audio recording:",e),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function ot(){return new Promise((e,t)=>{if(!D||!te){e();return}te=!1;const o=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),ae(),t(new Error("Audio recording stop timeout"))},1e4);D.onstop=()=>{if(clearTimeout(o),z.length>0){const r=new Blob(z,{type:(D==null?void 0:D.mimeType)||"audio/webm"}),n=new FileReader;n.onload=()=>{const s=n.result;window.conversationRecordingData=s,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const i=(Date.now()-ye)/1e3;sessionStorage.setItem("recordingDuration",i.toString()),ae(),e()},n.readAsDataURL(r)}else ae(),e()};try{D.stop()}catch(r){clearTimeout(o),console.error("Error stopping media recorder:",r),ae(),t(r)}})}function ae(){N&&(N.disconnect(),N=null),A&&(A.disconnect(),A=null),le&&(le.getTracks().forEach(e=>e.stop()),le=null),D=null,z=[]}async function nt(){try{x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">save</span><span style="font-size:15px;font-weight:600;">Saving...</span>',x.style.background="rgba(34,197,94,0.95)",await new Promise(T=>setTimeout(T,100));const e=sessionStorage.getItem("hasRecording"),t=window.conversationRecordingData,o=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(!e||e!=="true"||!t){await new Promise(q=>setTimeout(q,500));const T=sessionStorage.getItem("hasRecording"),Y=window.conversationRecordingData;(!T||T!=="true"||!Y)&&console.error("Still no audio recording after retry")}sessionStorage.setItem("chatTranscript",JSON.stringify(C));const n=localStorage.getItem("selectedAgentId"),s=localStorage.getItem("selectedAgentType"),i=localStorage.getItem("selectedAgentTitle"),l=it(),a=l.length/1024/1024;let c=null,d=l;if(a>5)try{const T=await Ce("/api/db/upload_audio",{method:"POST",body:JSON.stringify({audio_data:l,filename:`conversation_${Date.now()}.webm`})});T.ok?(c=(await T.json()).audio_url,d=btoa(`stored_in_supabase_storage:${c}`)):d=btoa(`upload_failed_${a.toFixed(2)}MB`)}catch(T){console.error("Audio upload error:",T),d=btoa(`upload_error_${a.toFixed(2)}MB`)}const w={title:`${i}`,agent_id:n,duration_seconds:be(),total_exchanges:C.length,full_conversation:at(),transcript:C,audio_data:d,audio_url:c,audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:lt(),user_agent:navigator.userAgent,ip_address:await ct(),status:"completed",tags:["sales_call","training",s||"general"],notes:`Sales training conversation using ${i||"general"} agent `},f=new Promise((T,Y)=>setTimeout(()=>Y(new Error("Database save timeout after 30 seconds")),3e4)),m=Ce("/api/db/save_conversation",{method:"POST",body:JSON.stringify(w)}),u=await Promise.race([m,f]);if(!u.ok){const T=await u.text();throw console.error("Conversation save error:",T),new Error(`Failed to save conversation: ${u.status} - ${T}`)}const y=await u.json();if(!y.success)throw new Error(`Failed to save conversation: ${y.error}`);const P=y.conversation_id;sessionStorage.setItem("conversationId",P),await new Promise(T=>setTimeout(T,500)),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">check_circle</span><span style="font-size:15px;font-weight:600;">Success!</span>',x.style.background="rgba(34,197,94,0.95)",window.location.href="/success.html"}catch(e){console.error("Error saving conversation:",e);const t=e.message.toLowerCase();if(t.includes("timeout")||t.includes("too large")){alert("Conversation was too long for database storage. The transcript has been saved locally, but audio recording was not saved due to size limits.");const o={timestamp:new Date().toISOString(),duration:be(),transcript:C,agent_type:localStorage.getItem("selectedAgentType")};localStorage.setItem("lastConversationBackup",JSON.stringify(o)),window.location.href="/success.html"}else alert("Failed to save conversation. Please try again."),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",ne=!0}}function _e(){U=[],I="",G="",z=[],window.gc&&window.gc()}function rt(){const e=window.conversationRecordingData?window.conversationRecordingData.length:0,t=U.join("").length;e+t>10*1024*1024&&_e()}function st(){["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(t=>{sessionStorage.getItem(t)&&sessionStorage.removeItem(t)}),z.length>0&&(z=[]),window.conversationRecordingData=null,_e()}function be(){const e=sessionStorage.getItem("callStartTime");if(!e)return 0;const t=new Date(e).getTime(),o=new Date().getTime();return Math.floor((o-t)/1e3)}function at(){return C.map((e,t)=>({user:e.sender==="You"?e.text:"",assistant:e.sender==="AI"?e.text:"",timestamp:new Date().toISOString()}))}function it(){const e=window.conversationRecordingData,t=sessionStorage.getItem("hasRecording"),o=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(e&&t==="true"&&o&&r&&e.length>1e3&&!e.includes("audio_data_placeholder")){const n=parseInt(r);if(Date.now()-n<2*60*60*1e3)return e}return btoa("audio_data_placeholder")}function lt(){const e=sessionStorage.getItem("recordingDuration"),t=sessionStorage.getItem("hasRecording"),o=window.conversationRecordingData;if(e&&t==="true"&&o){const n=parseFloat(e);if(n>0&&n<7200)return n}return be()}async function ct(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(e){return console.error("Error getting client IP:",e),"127.0.0.1"}}async function Be(){const e=localStorage.getItem("refreshToken");if(!e)return console.error("No refresh token found"),null;try{const t=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(t.ok){const o=await t.json();return localStorage.setItem("accessToken",o.access_token),localStorage.setItem("refreshToken",o.refresh_token),localStorage.setItem("tokenExpiresAt",o.expires_at),o.access_token}else return console.error("Failed to refresh token"),null}catch(t){return console.error("Error refreshing token:",t),null}}function dt(){const e=localStorage.getItem("tokenExpiresAt");if(!e)return!0;const t=new Date(e).getTime();return new Date().getTime()>=t-5*60*1e3}async function ze(){if(dt()){const t=await Be();return t||(console.error("Failed to refresh token"),localStorage.clear(),window.location.href="/login.html","")}const e=localStorage.getItem("accessToken");return e||(console.error("No access token found"),window.location.href="/login.html","")}async function Ce(e,t={}){const o=await ze(),r=await fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(r.status===401){const n=await Be();if(n)return fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return r}let ne=!1;x.onclick=async()=>{if(ne){x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">hourglass_empty</span><span style="font-size:15px;font-weight:600;">Processing...</span>',x.style.background="rgba(107,114,128,0.95)",x.disabled=!0,x.style.cursor="not-allowed",Fe(),$e(),Te(),de(!1);try{te&&await ot(),C.length>0?await nt():window.location.href="/success.html"}catch(e){console.error("Error during disconnect process:",e),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",ne=!0,alert("Error disconnecting. Please try again.")}}else{await st(),Z||await Ke(),Oe(),Ne(),de(!0);try{await re()}catch{alert("Failed to establish realtime connection. Please check your network connection and try again."),de(!1),Te();return}tt(),Ee(),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",ne=!0}};x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>';x.style.background="#8b5cf6";ne=!1;et(!1);let oe=0;setInterval(()=>{!W&&F.length===0&&!E&&(v||(oe=0)),v&&(oe===0?oe=Date.now():Date.now()-oe>12e4&&(console.error("isProcessing stuck for 2+ minutes"),v=!1,oe=0))},3e3);document.addEventListener("click",async()=>{if(p&&p.state==="suspended")try{await p.resume()}catch(e){console.error("Failed to resume AudioContext:",e)}},{once:!0});
