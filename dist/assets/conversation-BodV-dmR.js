import"./modulepreload-polyfill-B5Qt9EMX.js";function re(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function ae(){const e=document.createElement("div");e.id="rulesOverlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10000",e.style.pointerEvents="auto";const t=document.createElement("div");t.style.background="#ffffff",t.style.borderRadius="16px",t.style.padding="32px",t.style.maxWidth="500px",t.style.width="90%",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.border="1px solid #e2e8f0",t.style.position="relative";const o=document.createElement("h2");o.innerHTML="Hey 👋 Please take a look at the rules for role-play done right.",o.style.fontSize="20px",o.style.fontWeight="700",o.style.color="#1e293b",o.style.marginBottom="24px",o.style.lineHeight="1.4";const n=document.createElement("ul");n.style.listStyle="none",n.style.padding="0",n.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile 😊","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(c=>{const a=document.createElement("li");a.style.display="flex",a.style.alignItems="flex-start",a.style.gap="12px",a.style.marginBottom="16px",a.style.fontSize="15px",a.style.lineHeight="1.6",a.style.color="#475569";const u=document.createElement("span");u.innerHTML="•",u.style.color="#8b5cf6",u.style.fontWeight="bold",u.style.fontSize="18px",u.style.lineHeight="1.2";const m=document.createElement("span");m.textContent=c,a.appendChild(u),a.appendChild(m),n.appendChild(a)});const r=document.createElement("p");r.innerHTML="Let's go 🚀",r.style.fontSize="16px",r.style.fontWeight="700",r.style.color="#1e293b",r.style.marginBottom="24px",r.style.marginTop="0";const s=document.createElement("button");s.textContent="I agree",s.id="agreeButton",s.style.background="#e2e8f0",s.style.color="#64748b",s.style.border="none",s.style.borderRadius="12px",s.style.padding="14px 24px",s.style.fontSize="16px",s.style.fontWeight="600",s.style.cursor="not-allowed",s.style.width="100%",s.style.transition="all 0.2s",s.disabled=!0,t.appendChild(o),t.appendChild(n),t.appendChild(r),t.appendChild(s),e.appendChild(t),document.body.appendChild(e),setTimeout(()=>{s.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",s.style.color="white",s.style.cursor="pointer",s.disabled=!1,s.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"},1e4),s.addEventListener("click",()=>{s.disabled||e.remove()}),e.addEventListener("click",c=>{c.target})}function ce(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",ae();const e=document.createElement("div");e.className="top-bar",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="50px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="15px",e.style.padding="0 18px",e.style.background="rgba(255,255,255,0.25)",e.style.backdropFilter="blur(12px)",e.style.zIndex="100",e.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",e.style.overflow="visible";const t=document.createElement("button");t.innerHTML="← Back to details",t.style.position="fixed",t.style.top="8px",t.style.left="18px",t.style.background="rgba(255,255,255,0.9)",t.style.border="1px solid rgba(0,0,0,0.1)",t.style.borderRadius="8px",t.style.padding="6px 12px",t.style.fontSize="13px",t.style.fontWeight="500",t.style.color="#374151",t.style.cursor="pointer",t.style.transition="all 0.2s",t.style.zIndex="200",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.onclick=()=>window.location.href="/agent-info.html",t.onmouseover=()=>{t.style.background="rgba(255,255,255,0.95)",t.style.transform="translateY(-1px)"},t.onmouseout=()=>{t.style.background="rgba(255,255,255,0.9)",t.style.transform="translateY(0)"};const o=localStorage.getItem("selectedAgentType")||"payment-followup",n={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},i=document.createElement("div");i.textContent=n[o]||"Sales Training",i.style.fontSize="18px",i.style.fontWeight="500",i.style.letterSpacing="0.5px",i.style.color="#23272f",i.style.opacity="0.92",i.style.whiteSpace="nowrap";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.fontSize="1.1rem",r.style.color="#23272f",r.style.fontWeight="500",r.style.opacity="0.85",r.style.whiteSpace="nowrap";const s=document.createElement("span");s.id="timer",s.textContent="00:00";const c=document.createElement("span");c.id="recordingDot",c.textContent="•",c.style.fontSize="1.5em",c.style.color="#e11d48",c.style.opacity="0",c.style.transition="opacity 0.3s",r.appendChild(s),r.appendChild(c),e.appendChild(t),e.appendChild(i),e.appendChild(r),document.body.appendChild(e);const a=document.createElement("div");a.className="voice-wave-area",a.id="voiceWaveArea",a.style.position="fixed",a.style.top="50px",a.style.left="0",a.style.width="100vw",a.style.height="calc(100vh - 50px)",a.style.display="flex",a.style.flexDirection="column",a.style.justifyContent="center",a.style.alignItems="center",a.style.zIndex="1",a.style.background="transparent";const u=document.createElement("div");u.className="voice-wave-container",u.id="voiceWaveContainer",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.gap="4px",u.style.height="60px";for(let $=0;$<20;$++){const b=document.createElement("div");b.className="voice-wave-bar",b.style.width="3px",b.style.height="4px",b.style.background="rgba(37,99,235,0.3)",b.style.borderRadius="2px",b.style.transition="height 0.1s ease",u.appendChild(b)}a.appendChild(u),document.body.appendChild(a);const m=document.createElement("div");m.id="hiddenTranscript",m.style.display="none",document.body.appendChild(m);const d=document.createElement("div");d.className="mic-wrap",d.style.position="fixed",d.style.left="50%",d.style.bottom="48px",d.style.transform="translateX(-50%)",d.style.zIndex="20",d.style.display="flex",d.style.flexDirection="row",d.style.alignItems="center",d.style.gap="24px";const g=document.createElement("div");g.className="ocean-animation",g.style.position="absolute",g.style.left="50%",g.style.top="50%",g.style.transform="translate(-50%, -50%)",g.style.zIndex="-1",g.style.pointerEvents="none",g.style.width="160px",g.style.height="160px";const l=document.createElement("button");l.className="voice-btn mic-btn",l.id="micBtn",l.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;">mic</span>',l.style.width="50px",l.style.height="50px",l.style.borderRadius="50%",l.style.background="rgba(37,99,235,0.95)",l.style.color="#fff",l.style.border="none",l.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.fontWeight="700",l.style.fontSize="1.3rem",l.style.cursor="pointer",l.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",l.style.position="relative",l.style.outline="none",l.style.visibility="visible",d.appendChild(l),d.appendChild(g),document.body.appendChild(d);const y=document.createElement("link");y.rel="stylesheet",y.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(y);const w=document.createElement("style");w.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(w);function A($){if(g.innerHTML="",$)for(let b=0;b<2;b++){const C=document.createElement("div");C.className="wave"+(b===1?" wave2":""),C.style.width="0px",C.style.height="0px",C.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",C.style.position="absolute",C.style.left="50%",C.style.top="50%",C.style.transform="translate(-50%, -50%)",g.appendChild(C)}}window.showOceanAnimation=A}re()?ce():window.location.href="/login.html";let p=null,_=!1,k=!1,F=null,N=0,M=[],P=!1,h=null,R=[],D=!1,f=null,W=[],B=!1,O="",v=null,I=[],L=!1,H=null,q=0,x=null,E=null;const T=document.getElementById("micBtn"),Q=document.getElementById("timer"),le=document.getElementById("voiceWaveContainer"),V=document.getElementById("hiddenTranscript");let S="";function j(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}function de(){N=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),Q.textContent=j(N),F=window.setInterval(()=>{N++,Q.textContent=j(N)},1e3)}function ue(){F&&(clearInterval(F),F=null)}function J(e,t){const o=j(N);M.push({sender:e,text:t,time:o});const n=document.createElement("div");n.className="transcript-item "+(e==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content">${t}</div>
        <div class="transcript-meta">${e}  ${o}</div>
    `,V.appendChild(n)}function pe(){M=[],V.innerHTML=""}function ge(){if(_||k||P)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){alert("Your browser does not support Web Speech API.");return}p=new e,p.lang="en-US",p.interimResults=!0,p.maxAlternatives=1,p.continuous=!0,"webkitSpeechRecognition"in window&&(p.continuous=!0,p.interimResults=!0,p.maxAlternatives=1),_=!0,k=!1;let t="";S="";let o=null,n=null;p.onresult=i=>{fe(),me();let r="",s=!1;for(let c=i.resultIndex;c<i.results.length;c++){const a=i.results[c][0].transcript;i.results[c].isFinal?(t+=a,S+=a,s=!0):r+=a}if(r&&!s){o||(o=te("You"));const c=(S+" "+r).trim();o.update(c),Y(!0),n&&(clearTimeout(n),n=null)}s&&t.trim()&&(n=window.setTimeout(()=>{if(t.trim().length>0){const c=t.trim();if(t="",c.length>0){ee(c),S="";const a=document.querySelector(".transcript-item.you .transcript-content");a&&(a.textContent="")}}n=null},1e3))},p.onerror=i=>{_=!1,k=!1,P=!1,p==null||p.stop(),alert("Speech recognition error: "+i.error)},p.onstart=()=>{P=!0},p.onend=()=>{if(P=!1,_&&!k&&!P&&_){const i=o?o.getText():"",r=t,s=S;setTimeout(()=>{_&&!P&&(p==null||p.start(),i&&o&&setTimeout(()=>{o&&o.update(i)},50),r&&(t=r),s&&(S=s))},50)}},p.start()}function fe(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),f){try{f.stop(),f.disconnect()}catch{console.log("Audio source already stopped")}f=null}R=[],D=!1,console.log("Audio playback cleared")}function me(){console.log("User interrupted AI, continuing recording")}function ye(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),f){try{f.stop(),f.disconnect()}catch{console.log("Audio source already stopped")}f=null}R=[],D=!1,W=[],B=!1,console.log("All outstanding audio cleared")}function he(){if(console.log("Stopping listening..."),_=!1,k=!1,P=!1,p)try{p.stop()}catch(o){console.log("Error stopping recognition:",o)}let e="";if(S.trim()||O.trim()){const o=[];S&&S.trim()&&o.push(S.trim()),O&&O.trim()&&o.push(O.trim());const n=document.querySelector(".transcript-item.you .transcript-content");if(n&&n.textContent&&n.textContent.trim()){const i=n.textContent.trim();i.length>0&&o.push(i)}o.length>0&&(e=o.filter((r,s)=>o.indexOf(r)===s).join(" ").replace(/\s+/g," ").trim(),console.log("Processing complete speech on stop:",e),e.length>0&&ee(e))}O="",S="";const t=document.querySelector(".transcript-item.you .transcript-content");t&&(t.textContent=""),console.log("Listening stopped")}async function K(e){try{const t=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();await we(o.audio_data,"pcm_f32le",o.sample_rate)}catch(t){if(console.error("Cartesia TTS error:",t),window.speechSynthesis){const o=new SpeechSynthesisUtterance(e);o.rate=.9,o.pitch=1,L&&console.log("Using browser speech synthesis - audio will be captured via microphone"),window.speechSynthesis.speak(o)}}}async function we(e,t="pcm_f32le",o=44100){const n=Uint8Array.from(atob(e),i=>i.charCodeAt(0));await Z(n.buffer,o)}async function Z(e,t){if(h||(h=new(window.AudioContext||window.webkitAudioContext)),h.state==="suspended")try{await h.resume()}catch(o){console.error("Failed to resume audio context:",o);return}try{const o=h.createBuffer(1,e.byteLength/4,t),n=o.getChannelData(0),i=new Float32Array(e);n.set(i),f&&(f.stop(),f.disconnect()),f=h.createBufferSource(),f.buffer=o,f.connect(h.destination),x&&L&&f.connect(x),f.start(),console.log("Raw PCM audio playback started successfully")}catch(o){console.error("Error playing raw PCM audio:",o)}}function ee(e){if(k)return;k=!0,J("You",e);const t=te("AI");let o="",n="";Te(e,i=>{if(o+=i,t.update(o),n+=i,be(n)){const r=G(n);r.length>0&&(W.push(...r),n="",B||X())}}).then(()=>{if(n.trim()){const i=G(n.trim());W.push(...i),B||X()}o.trim()&&J("AI",o.trim()),k=!1}).catch(i=>{t.update("Error: "+i.message),k=!1})}function be(e){return!!(/[.!?]\s*$/.test(e)||/, \s*$/.test(e)||e.length>150)}function G(e){const t=e.trim();if(!t)return[];if(/[.!?]\s*$/.test(t))return[t];if(/, \s*$/.test(t))return[t];if(t.length>150){const o=t.match(/.*[.!?]\s*$/);if(o)return[o[0].trim()]}return[]}async function ve(){if(!(R.length===0||D)){for(D=!0;R.length>0;){const e=R.shift();try{await Z(e,44100),f&&await new Promise(t=>{f.onended=()=>t()})}catch(t){console.error("Error playing audio from queue:",t)}}D=!1,setTimeout(()=>{xe()},500)}}async function X(){if(!B){for(B=!0;W.length>0;){const e=W.splice(0,2);for(let t=0;t<e.length;t++){const o=e[t];try{const n=await Se(o);R.push(n),D||ve()}catch(n){console.error("Cartesia TTS error:",n);try{await K(o)}catch(i){console.error("Fallback TTS error:",i)}}}}B=!1}}function xe(){!B&&R.length===0&&!D&&console.log("AI finished speaking, recording continues")}async function Se(e){return new Promise((t,o)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(n=>{var u;if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=(u=n.body)==null?void 0:u.getReader(),r=new TextDecoder("utf-8");let s="",c=[];async function a(){try{const{done:m,value:d}=await i.read();if(m){if(c.length>0){const l=new Uint8Array(c.reduce((w,A)=>w+A.length,0));let y=0;for(const w of c)l.set(w,y),y+=w.length;t(l.buffer)}else o(new Error("No audio data received"));return}s+=r.decode(d,{stream:!0});let g=s.split(/\r?\n/);s=g.pop()||"";for(const l of g)if(l.startsWith("data: "))try{const y=JSON.parse(l.slice(6));if(y.audio_chunk){const w=Uint8Array.from(atob(y.audio_chunk),A=>A.charCodeAt(0));c.push(w)}else y.status==="complete"||y.error&&o(new Error(y.error))}catch{}a()}catch(m){o(m)}}a()}).catch(o)})}function te(e){const t=j(N),o=document.createElement("div");o.className="transcript-item "+(e==="AI"?"ai":"you"),o.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${e}  ${t}</div>
    `;const n=o.querySelector(".transcript-content");return V.appendChild(o),{update:i=>{n.textContent=i},remove:()=>{n.textContent=""},getText:()=>n.textContent||""}}function Te(e,t){return new Promise((o,n)=>{const i=new AbortController,r=localStorage.getItem("selectedAgentType")||"discovery-call",s=localStorage.getItem("currentSessionId")||oe();localStorage.setItem("currentSessionId",s),fetch("/chat_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,agent_type:r,session_id:s}),signal:i.signal}).then(c=>{if(!c.body)throw new Error("No response body");const a=c.body.getReader(),u=new TextDecoder("utf-8");let m="";function d(){a.read().then(({done:g,value:l})=>{if(g){o();return}m+=u.decode(l,{stream:!0});let y=m.split(/\r?\n/);m=y.pop()||"";for(const w of y)if(w.startsWith("data: "))try{const A=JSON.parse(w.slice(6));A.reply&&t(A.reply)}catch{}d()}).catch(n)}d()}).catch(n)})}function Ie(e){const t=document.getElementById("recordingDot");t&&t.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(e)}function Y(e){le.querySelectorAll(".voice-wave-bar").forEach(o=>{e?o.classList.add("active"):o.classList.remove("active")})}async function ke(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});H=e,h||(h=new(window.AudioContext||window.webkitAudioContext)),x=h.createMediaStreamDestination(),E=h.createMediaStreamSource(e),E.connect(x);let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm"),MediaRecorder.isTypeSupported(t)||(t="audio/mp4"),MediaRecorder.isTypeSupported(t)||(t="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(t)||(t="audio/wav"),console.log("Using MIME type for recording:",t),v=new MediaRecorder(x.stream,{mimeType:t}),I=[],L=!0,q=Date.now(),v.ondataavailable=o=>{o.data.size>0&&(I.push(o.data),console.log(`Audio chunk received: ${o.data.size} bytes, total chunks: ${I.length}`))},v.onstop=()=>{if(console.log("MediaRecorder stopped, processing final audio..."),I.length>0){const o=new Blob(I,{type:t});console.log("Final audio blob created:",o.size,"bytes");const n=new FileReader;n.onload=()=>{const i=n.result;sessionStorage.setItem("conversationRecording",i),sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const r=(Date.now()-q)/1e3;sessionStorage.setItem("recordingDuration",r.toString()),console.log("✅ Complete audio recording saved successfully")},n.readAsDataURL(o)}E&&(E.disconnect(),E=null),x&&(x.disconnect(),x=null),e&&e.getTracks().forEach(o=>o.stop())},v.start(1e3),console.log("Audio recording started - will capture both user and AI audio")}catch(e){console.error("Error starting audio recording:",e),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function Ae(){return new Promise((e,t)=>{if(!v||!L){e();return}L=!1;const o=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),z(),t(new Error("Audio recording stop timeout"))},1e4);v.onstop=()=>{if(clearTimeout(o),console.log("Processing final audio recording..."),I.length>0){const n=new Blob(I,{type:(v==null?void 0:v.mimeType)||"audio/webm"});console.log("Final audio blob created:",n.size,"bytes");const i=new FileReader;i.onload=()=>{const r=i.result;sessionStorage.setItem("conversationRecording",r),sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const s=(Date.now()-q)/1e3;sessionStorage.setItem("recordingDuration",s.toString()),console.log("✅ Audio recording processed and saved to sessionStorage, duration:",s),z(),e()},i.readAsDataURL(n)}else console.warn("No audio chunks available"),z(),e()};try{v.stop(),console.log("Audio recording stop initiated")}catch(n){clearTimeout(o),console.error("Error stopping media recorder:",n),z(),t(n)}})}function z(){E&&(E.disconnect(),E=null),x&&(x.disconnect(),x=null),H&&(H.getTracks().forEach(e=>e.stop()),H=null),v=null,I=[]}async function Ce(){try{console.log("=== Step 1: Verifying audio recording is complete ==="),await new Promise(d=>setTimeout(d,500));const e=sessionStorage.getItem("hasRecording"),t=sessionStorage.getItem("conversationRecording"),o=sessionStorage.getItem("recordingDuration"),n=sessionStorage.getItem("recordingTimestamp");if(console.log("Audio verification - hasRecording:",e),console.log("Audio verification - recordedAudio exists:",!!t),console.log("Audio verification - recordingDuration:",o),console.log("Audio verification - recordingTimestamp:",n),!e||e!=="true"||!t){console.warn("⚠️ No fresh audio recording found, waiting for processing..."),await new Promise(l=>setTimeout(l,2e3));const d=sessionStorage.getItem("hasRecording"),g=sessionStorage.getItem("conversationRecording");!d||d!=="true"||!g?console.error("❌ Still no audio recording after retry - proceeding with placeholder"):console.log("✅ Audio recording found after retry")}else console.log("✅ Fresh audio recording verified");console.log("=== Step 2: Saving conversation to database ==="),sessionStorage.setItem("chatTranscript",JSON.stringify(M));const i=localStorage.getItem("selectedAgentId"),r=localStorage.getItem("selectedAgentType"),s=localStorage.getItem("selectedAgentTitle"),c={title:`${s}`,agent_id:i,duration_seconds:ne(),total_exchanges:M.length,full_conversation:De(),transcript:M,audio_data:Be(),audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:_e(),user_agent:navigator.userAgent,ip_address:await Pe(),status:"completed",tags:["sales_call","training",r||"general"],notes:`Sales training conversation using ${s||"general"} agent `};console.log("Sending conversation data to database...");const a=await Le("/api/db/save_conversation",{method:"POST",body:JSON.stringify(c)});if(console.log("Conversation save response status:",a.status),!a.ok){const d=await a.text();throw console.error("Conversation save error:",d),new Error(`Failed to save conversation: ${a.status} - ${d}`)}const u=await a.json();if(console.log("Conversation save result:",u),!u.success)throw new Error(`Failed to save conversation: ${u.error}`);const m=u.conversation_id;sessionStorage.setItem("conversationId",m),console.log("✅ Step 2 Complete: Conversation saved successfully:",m),console.log("Waiting 2 seconds for database write to complete..."),await new Promise(d=>setTimeout(d,2e3)),console.log("=== Step 3: Navigating to success page for analysis ==="),window.location.href="/success.html"}catch(e){console.error("Error saving conversation:",e),alert("Failed to save conversation. Please try again.")}}function oe(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async function Ee(){try{const e=localStorage.getItem("currentSessionId");e&&(await fetch("/clear_conversation_history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e})}),console.log("✅ Conversation history cleared on backend"))}catch(e){console.error("❌ Failed to clear conversation history:",e)}}async function Re(){console.log("🧹 Clearing previous analysis data for fresh conversation..."),await Ee(),["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","conversationRecording","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(o=>{sessionStorage.getItem(o)&&(sessionStorage.removeItem(o),console.log(`Cleared: ${o}`))}),I.length>0&&(I=[],console.log("Cleared: audioChunks array"));const t=oe();localStorage.setItem("currentSessionId",t),console.log("✅ Previous analysis data cleared and new session started:",t)}function ne(){const e=sessionStorage.getItem("callStartTime");if(!e)return 0;const t=new Date(e).getTime(),o=new Date().getTime();return Math.floor((o-t)/1e3)}function De(){return M.map((e,t)=>({user:e.sender==="You"?e.text:"",assistant:e.sender==="AI"?e.text:"",timestamp:new Date().toISOString()}))}function Be(){const e=sessionStorage.getItem("conversationRecording"),t=sessionStorage.getItem("hasRecording"),o=sessionStorage.getItem("recordingDuration"),n=sessionStorage.getItem("recordingTimestamp");if(console.log("getBase64Audio - hasRecording:",t),console.log("getBase64Audio - recordedAudio exists:",!!e),console.log("getBase64Audio - recordingDuration:",o),console.log("getBase64Audio - recordingTimestamp:",n),e&&t==="true"&&o&&n)if(e.length>1e3&&!e.includes("audio_data_placeholder")){const i=parseInt(n),r=Date.now(),s=r-i<2*60*60*1e3;if(s)return console.log("✅ Returning actual recorded audio data (length:",e.length,", recent:",s,")"),e;console.warn("⚠️ Audio recording is too old (timestamp:",i,"now:",r,")")}else console.warn("⚠️ Audio data appears to be placeholder or too small");return console.log("❌ No valid recorded audio found, using placeholder"),btoa("audio_data_placeholder")}function _e(){const e=sessionStorage.getItem("recordingDuration"),t=sessionStorage.getItem("hasRecording"),o=sessionStorage.getItem("conversationRecording");if(console.log("getAudioDuration - hasRecording:",t),console.log("getAudioDuration - recordedDuration:",e),console.log("getAudioDuration - recordedAudio exists:",!!o),e&&t==="true"&&o){const i=parseFloat(e);if(i>0&&i<7200)return console.log("✅ Using actual recording duration:",i),i;console.warn("⚠️ Recording duration seems invalid:",i)}const n=ne();return console.log("❌ No valid recording duration found, using call duration:",n),n}async function Pe(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(e){return console.error("Error getting client IP:",e),"127.0.0.1"}}async function ie(){const e=localStorage.getItem("refreshToken");if(!e)return console.error("No refresh token found"),null;try{const t=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(t.ok){const o=await t.json();return localStorage.setItem("accessToken",o.access_token),localStorage.setItem("refreshToken",o.refresh_token),localStorage.setItem("tokenExpiresAt",o.expires_at),console.log("Token refreshed successfully"),o.access_token}else return console.error("Failed to refresh token"),null}catch(t){return console.error("Error refreshing token:",t),null}}function Me(){const e=localStorage.getItem("tokenExpiresAt");if(!e)return!0;const t=new Date(e).getTime();return new Date().getTime()>=t-5*60*1e3}async function Ne(){if(Me()){console.log("Token is expired, attempting to refresh...");const t=await ie();return t||(console.error("Failed to refresh token, redirecting to login"),localStorage.clear(),window.location.href="/login.html","")}const e=localStorage.getItem("accessToken");return e?(console.log("Found access token:",e.substring(0,20)+"..."),e):(console.error("No access token found! User must be logged in."),console.log("Available localStorage keys:",Object.keys(localStorage)),window.location.href="/login.html","")}async function Le(e,t={}){const o=await Ne(),n=await fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(n.status===401){console.log("Received 401, attempting token refresh...");const i=await ie();if(i)return console.log("Token refreshed, retrying request..."),fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return n}let U=!1;const se='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic</span>',Oe='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic_off</span>';T.onclick=async()=>{if(U){if(ye(),he(),ue(),Y(!1),L){console.log("User stopped conversation, stopping audio recording");try{await Ae(),console.log("✅ Audio recording stopped and processed successfully")}catch(e){console.error("❌ Error stopping audio recording:",e)}}T.innerHTML=se,T.style.background="rgba(37,99,235,0.95)",U=!1,M.length>0?(console.log("User ended call, saving conversation..."),T.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">hourglass_empty</span>',T.style.background="rgba(107,114,128,0.95)",T.disabled=!0,Ce()):(console.log("No transcript history, navigating directly"),window.location.href="/success.html")}else{await Re(),pe(),de(),Y(!0),ke();const e="Hey, who's this?";J("AI",e),K(e),ge(),T.innerHTML=Oe,T.style.background="rgba(229,39,76,0.92)",U=!0}};T.innerHTML=se;T.style.background="rgba(37,99,235,0.95)";U=!1;Ie(!1);setInterval(()=>{!B&&R.length===0&&!D&&(k||console.log("Periodic check: AI finished speaking, recording continues"))},3e3);document.addEventListener("click",async()=>{if(h&&h.state==="suspended")try{await h.resume(),console.log("AudioContext resumed on user interaction")}catch(e){console.error("Failed to resume AudioContext:",e)}},{once:!0});
