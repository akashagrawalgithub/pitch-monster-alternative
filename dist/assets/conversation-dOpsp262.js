import"./modulepreload-polyfill-B5Qt9EMX.js";function _e(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function Be(){const e=document.createElement("div");e.id="rulesOverlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10000",e.style.pointerEvents="auto";const t=document.createElement("div");t.style.background="#ffffff",t.style.borderRadius="16px",t.style.padding="32px",t.style.maxWidth="500px",t.style.width="90%",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.border="1px solid #e2e8f0",t.style.position="relative";const n=document.createElement("h2");n.innerHTML="Hey ðŸ‘‹ Please take a look at the rules for role-play done right.",n.style.fontSize="20px",n.style.fontWeight="700",n.style.color="#1e293b",n.style.marginBottom="24px",n.style.lineHeight="1.4";const r=document.createElement("ul");r.style.listStyle="none",r.style.padding="0",r.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile ðŸ˜Š","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(w=>{const f=document.createElement("li");f.style.display="flex",f.style.alignItems="flex-start",f.style.gap="12px",f.style.marginBottom="16px",f.style.fontSize="15px",f.style.lineHeight="1.6",f.style.color="#475569";const m=document.createElement("span");m.innerHTML="â€¢",m.style.color="#8b5cf6",m.style.fontWeight="bold",m.style.fontSize="18px",m.style.lineHeight="1.2";const u=document.createElement("span");u.textContent=w,f.appendChild(m),f.appendChild(u),r.appendChild(f)});const s=document.createElement("p");s.innerHTML="Let's go ðŸš€",s.style.fontSize="16px",s.style.fontWeight="700",s.style.color="#1e293b",s.style.marginBottom="24px",s.style.marginTop="0";const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="12px",i.style.marginBottom="24px",i.style.padding="16px",i.style.background="#f8fafc",i.style.borderRadius="8px",i.style.border="1px solid #e2e8f0";const l=document.createElement("input");l.type="checkbox",l.id="rulesCheckbox",l.style.width="18px",l.style.height="18px",l.style.cursor="pointer",l.style.accentColor="#8b5cf6";const a=document.createElement("label");a.htmlFor="rulesCheckbox",a.textContent="I have read and understood the rules above",a.style.fontSize="14px",a.style.fontWeight="500",a.style.color="#475569",a.style.cursor="pointer",a.style.flex="1",i.appendChild(l),i.appendChild(a);const c=document.createElement("button");c.textContent="I agree",c.id="agreeButton",c.style.background="#e2e8f0",c.style.color="#64748b",c.style.border="none",c.style.borderRadius="12px",c.style.padding="14px 24px",c.style.fontSize="16px",c.style.fontWeight="600",c.style.cursor="not-allowed",c.style.width="100%",c.style.transition="all 0.2s",c.disabled=!0,t.appendChild(n),t.appendChild(r),t.appendChild(s),t.appendChild(i),t.appendChild(c),e.appendChild(t),document.body.appendChild(e);const d=()=>{l.checked?(c.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",c.style.color="white",c.style.cursor="pointer",c.disabled=!1,c.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(c.style.background="#e2e8f0",c.style.color="#64748b",c.style.cursor="not-allowed",c.disabled=!0,c.style.boxShadow="none")};l.addEventListener("change",d),c.addEventListener("click",()=>{c.disabled||e.remove()}),e.addEventListener("click",w=>{w.target})}function ze(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",Be();const e=document.createElement("div");e.className="top-bar",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="50px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="15px",e.style.padding="0 18px",e.style.background="rgba(255,255,255,0.25)",e.style.backdropFilter="blur(12px)",e.style.zIndex="100",e.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",e.style.overflow="visible";const t=document.createElement("button");t.innerHTML="â† Back to details",t.style.position="fixed",t.style.top="8px",t.style.left="18px",t.style.background="rgba(255,255,255,0.9)",t.style.border="1px solid rgba(0,0,0,0.1)",t.style.borderRadius="8px",t.style.padding="6px 12px",t.style.fontSize="13px",t.style.fontWeight="500",t.style.color="#374151",t.style.cursor="pointer",t.style.transition="all 0.2s",t.style.zIndex="200",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.onclick=()=>window.location.href="/agent-info.html",t.onmouseover=()=>{t.style.background="rgba(255,255,255,0.95)",t.style.transform="translateY(-1px)"},t.onmouseout=()=>{t.style.background="rgba(255,255,255,0.9)",t.style.transform="translateY(0)"};const n=localStorage.getItem("selectedAgentType")||"payment-followup",r={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},o=document.createElement("div");o.textContent=r[n]||"Sales Training",o.style.fontSize="18px",o.style.fontWeight="500",o.style.letterSpacing="0.5px",o.style.color="#23272f",o.style.opacity="0.92",o.style.whiteSpace="nowrap";const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px",s.style.fontSize="1.1rem",s.style.color="#23272f",s.style.fontWeight="500",s.style.opacity="0.85",s.style.whiteSpace="nowrap";const i=document.createElement("span");i.id="timer",i.textContent="00:00";const l=document.createElement("span");l.id="recordingDot",l.textContent="â€¢",l.style.fontSize="1.5em",l.style.color="#e11d48",l.style.opacity="0",l.style.transition="opacity 0.3s",s.appendChild(i),s.appendChild(l),e.appendChild(t),e.appendChild(o),e.appendChild(s),document.body.appendChild(e);const a=document.createElement("div");a.id="customerName",a.style.position="fixed",a.style.left="50%",a.style.top="50px",a.style.transform="translateX(-50%)",a.style.zIndex="10",a.style.color="#1e293b",a.style.fontSize="16px",a.style.fontWeight="600",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.pointerEvents="none",a.style.background="rgba(255, 255, 255, 0.9)",a.style.padding="8px 16px",a.style.marginTop="36px",a.style.borderRadius="20px",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",a.style.border="1px solid rgba(226, 232, 240, 0.8)";const c=localStorage.getItem("selectedAgentName")||"Customer";a.textContent=`Customer Name: ${c}`,document.body.appendChild(a);const d=document.createElement("div");d.className="voice-wave-area",d.id="voiceWaveArea",d.style.position="fixed",d.style.top="50px",d.style.left="0",d.style.width="100vw",d.style.height="calc(100vh - 50px)",d.style.display="flex",d.style.flexDirection="column",d.style.justifyContent="center",d.style.alignItems="center",d.style.zIndex="1",d.style.background="transparent";const w=document.createElement("div");w.className="voice-wave-container",w.id="voiceWaveContainer",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.gap="4px",w.style.height="60px";for(let Y=0;Y<20;Y++){const E=document.createElement("div");E.className="voice-wave-bar",E.style.width="3px",E.style.height="4px",E.style.background="rgba(37,99,235,0.3)",E.style.borderRadius="2px",E.style.transition="height 0.1s ease",w.appendChild(E)}d.appendChild(w),document.body.appendChild(d);const f=document.createElement("div");f.id="hiddenTranscript",f.style.display="none",document.body.appendChild(f);const m=document.createElement("div");m.className="mic-wrap",m.style.position="fixed",m.style.left="50%",m.style.bottom="48px",m.style.transform="translateX(-50%)",m.style.zIndex="20",m.style.display="flex",m.style.flexDirection="row",m.style.alignItems="center",m.style.gap="24px";const u=document.createElement("div");u.className="ocean-animation",u.style.position="absolute",u.style.left="50%",u.style.top="50%",u.style.transform="translate(-50%, -50%)",u.style.zIndex="-1",u.style.pointerEvents="none",u.style.width="160px",u.style.height="160px";const y=document.createElement("button");y.className="voice-btn mic-btn",y.id="micBtn",y.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>',y.style.minWidth="180px",y.style.height="50px",y.style.borderRadius="25px",y.style.background="#8b5cf6",y.style.color="#fff",y.style.border="none",y.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.padding="0 24px",y.style.cursor="pointer",y.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",y.style.position="relative",y.style.outline="none",y.style.visibility="visible",m.appendChild(y),m.appendChild(u),document.body.appendChild(m);const B=document.createElement("link");B.rel="stylesheet",B.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(B);const S=document.createElement("style");S.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(S);function j(Y){if(u.innerHTML="",Y)for(let E=0;E<2;E++){const z=document.createElement("div");z.className="wave"+(E===1?" wave2":""),z.style.width="0px",z.style.height="0px",z.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",z.style.position="absolute",z.style.left="50%",z.style.top="50%",z.style.transform="translate(-50%, -50%)",u.appendChild(z)}}window.showOceanAnimation=j}_e()?ze():window.location.href="/login.html";let g=null,b=!1,v=!1,ae=null,Q=0,C=[],T=!1,X=!1,p=null,ce=!1,O=[],_=!1,h=null,F=[],M=!1,V="",pe=null,ue=!1,fe=!1,W=!1,ne=!1,k=!1,R=null,D=[],Z=!1,ie=null,me=0,I=null,N=null;const x=document.getElementById("micBtn"),be=document.getElementById("timer"),Pe=document.getElementById("voiceWaveContainer"),we=document.getElementById("hiddenTranscript");let A="";function de(e){const t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");return`${t}:${n}`}function Le(){Q=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),be.textContent=de(Q),ae=window.setInterval(()=>{Q++,be.textContent=de(Q)},1e3)}function xe(){ae&&(clearInterval(ae),ae=null)}function J(e,t){const n=de(Q);C.push({sender:e,text:t,time:n});const r=document.createElement("div");r.className="transcript-item "+(e==="AI"?"ai":"you"),r.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"ðŸ¤–":"ðŸ§‘"}</div>
        <div class="transcript-content">${t}</div>
        <div class="transcript-meta">${e}  ${n}</div>
    `,we.appendChild(r)}function Me(){C=[],ye=-1,we.innerHTML=""}function Ae(){if(b||v||T)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){alert("Your browser does not support Web Speech API.");return}if(g=new e,g.lang="en-US",g.interimResults=!0,g.maxAlternatives=1,g.continuous=!0,"webkitSpeechRecognition"in window){g.continuous=!0,g.interimResults=!0,g.maxAlternatives=1;try{g.serviceURI="https://www.google.com/speech-api/v2/recognize"}catch{}}b=!0,v=!1;let t="";A="";let n=null,r=null;g.onresult=s=>{(W||ce||_||ne)&&(ge(),p&&p.state!=="closed"&&p.suspend().then(()=>{p.resume()}).catch(a=>console.log("Audio context suspend/resume error:",a)));let i="",l=!1;for(let a=s.resultIndex;a<s.results.length;a++){const c=s.results[a][0].transcript;s.results[a].isFinal?(t+=c,A+=c,l=!0):i+=c}if(i&&!l){(W||ce||_||ne)&&(ge(),p&&p.state!=="closed"&&p.suspend().then(()=>{p.resume()}).catch(c=>console.log("Audio context suspend/resume error:",c))),n||(n=Ce("You"));const a=(A+" "+i).trim();n.update(a),le(!0),k=!0,r&&(clearTimeout(r),r=null)}l&&t.trim()&&(r=window.setTimeout(()=>{if(t.trim().length>0){const a=t.trim();if(t="",a.length>=3){typeof performance<"u"?performance.now():Date.now(),setTimeout(()=>{C.slice(),He(a)},200),A="";const c=document.querySelector(".transcript-item.you .transcript-content");c&&(c.textContent="")}else A+=" "+a}r=null,k=!1},500))},g.onerror=s=>{console.error("Speech recognition error:",s.error),s.error==="network"?(console.warn("Network error in speech recognition, attempting restart..."),setTimeout(()=>{b&&!T&&(g==null||g.start())},1e3)):s.error==="aborted"?(console.log("Speech recognition was aborted"),b=!1,v=!1,T=!1):s.error==="audio-capture"?(console.error("Audio capture error - microphone issue"),b=!1,v=!1,T=!1,alert("Microphone access error. Please check your microphone permissions and try again.")):s.error==="not-allowed"?(console.error("Speech recognition not allowed"),b=!1,v=!1,T=!1,alert("Speech recognition permission denied. Please allow microphone access and reload the page.")):(console.warn(`Speech recognition error: ${s.error}, attempting restart...`),T=!1,setTimeout(()=>{b&&!T&&U("error-recovery")},2e3))},g.onstart=()=>{T=!0},g.onend=()=>{if(T=!1,b&&!v&&!T&&b){const s=n?n.getText():"",i=t,l=A;setTimeout(()=>{b&&!T&&(i&&(t=i),l&&(A=l),U("natural-end"),s&&n&&setTimeout(()=>{n&&n.update(s)},150))},100)}},g.start(),g.startTime=Date.now();const o=setInterval(()=>{if(!b){clearInterval(o);return}const s=Date.now();if(g&&g.startTime&&s-g.startTime>2*60*1e3){g.startTime=s,U("mandatory-2min-restart");return}if(b&&!T&&!v&&!X){U("critical-restart");return}if(b&&!T&&s-((g==null?void 0:g.startTime)||0)>3e4){U("long-inactive-restart");return}if(b&&!H&&!$){oe().catch(i=>{console.error("Reconnection failed:",i),setTimeout(()=>{b&&oe()},1e3)});return}},1e3)}function ge(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),h){try{h.stop(),h.disconnect()}catch(e){console.log("Error stopping current source:",e)}h=null}if(p&&p.state!=="closed")try{const e=p.currentTime;p.suspend().then(()=>{p.resume()}).catch(t=>console.log("Audio context suspend/resume error:",t))}catch(e){console.log("Audio context error:",e)}if(O=[],G=[],ce=!1,_=!1,M=!1,F=[],W=!1,P=0,ne=!1,L&&H)try{const e={type:"response.cancel"};L.send(JSON.stringify(e))}catch(e){console.log("Error stopping realtime response:",e)}}function We(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),h){try{h.stop(),h.disconnect()}catch{}h=null}O=[],ce=!1,_=!1,F=[],M=!1}function U(e="manual"){if(!(X||!b)){X=!0;try{g&&T&&g.stop(),setTimeout(()=>{if(b&&!T)try{g==null||g.start()}catch(t){console.error("Restart failed:",t),Ae()}X=!1},100)}catch(t){console.error("Error in safe restart:",t),X=!1}}}function Ne(){if(b=!1,v=!1,T=!1,X=!1,g)try{g.stop()}catch{}if(A.trim()||V.trim()){const t=[];A&&A.trim()&&t.push(A.trim()),V&&V.trim()&&t.push(V.trim());const n=document.querySelector(".transcript-item.you .transcript-content");if(n&&n.textContent&&n.textContent.trim()){const r=n.textContent.trim();r.length>0&&t.push(r)}}V="",A="";const e=document.querySelector(".transcript-item.you .transcript-content");e&&(e.textContent="")}async function Oe(e){try{const t=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json();await Fe(n.audio_data,"pcm_f32le",n.sample_rate)}catch(t){if(console.error("Cartesia TTS error:",t),window.speechSynthesis){const n=new SpeechSynthesisUtterance(e);n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}}}async function Fe(e,t="pcm_f32le",n=44100){const r=Uint8Array.from(atob(e),o=>o.charCodeAt(0));await Ie(r.buffer,n)}async function $e(e){try{const t=Ue(e),n=new FormData;n.append("file",t,"ai_response.wav"),n.append("model","whisper-1"),n.append("language","en");const r=await De(),o=await fetch("/api/db/transcribe_audio",{method:"POST",headers:{Authorization:`Bearer ${r}`},body:n});if(o.ok){const s=await o.json(),i=s.text||s.transcript||"AI response transcribed";J("AI",i)}else{const s=await o.text();console.error("Audio transcription failed:",o.status,s);const i=C.filter(a=>a.sender==="You").pop();let l="[AI provided audio response]";if(i){const a=i.text.toLowerCase();a.includes("sales skill")||a.includes("practice")?l="I'd be happy to help you practice your sales skills! What specific area would you like to work on?":a.includes("close")||a.includes("deal")?l="Great! Let's work on your closing techniques. What type of deals are you looking to close?":a.includes("name")?l="I'm your AI sales training coach. I'm here to help you improve your sales skills!":l="I understand. Let me help you with that. Can you tell me more about what you'd like to work on?"}J("AI",l)}}catch(t){console.error("Error transcribing AI audio:",t),J("AI","[AI Response - Audio Only]")}}function Ue(e){const t=e.length,n=e.sampleRate,r=new ArrayBuffer(44+t*2),o=new DataView(r),s=(a,c)=>{for(let d=0;d<c.length;d++)o.setUint8(a+d,c.charCodeAt(d))};s(0,"RIFF"),o.setUint32(4,36+t*2,!0),s(8,"WAVE"),s(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,n,!0),o.setUint32(28,n*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0),s(36,"data"),o.setUint32(40,t*2,!0);const i=e.getChannelData(0);let l=44;for(let a=0;a<t;a++){const c=Math.max(-1,Math.min(1,i[a]));o.setInt16(l,c<0?c*32768:c*32767,!0),l+=2}return new Blob([r],{type:"audio/wav"})}async function Ie(e,t){if(k){console.log("User is speaking, skipping audio playback");return}if(p||(p=new(window.AudioContext||window.webkitAudioContext)),p.state==="suspended")try{await p.resume()}catch(n){console.error("Failed to resume audio context:",n);return}try{const n=p.createBuffer(1,e.byteLength/4,t),r=n.getChannelData(0),o=new Float32Array(e);r.set(o),h&&(h.stop(),h.disconnect()),h=p.createBufferSource(),h.buffer=n,h.addEventListener("ended",()=>{k&&console.log("Audio playback ended due to user speech")});const s=()=>{if(k&&h)try{h.stop(),h.disconnect(),h=null}catch(l){console.log("Error stopping audio on user speech:",l)}},i=setInterval(()=>{k&&(s(),clearInterval(i))},50);h.addEventListener("ended",()=>{clearInterval(i)}),h.connect(p.destination),I&&Z&&h.connect(I),!fe&&pe!=null&&(fe=!0),h.start()}catch(n){console.error("Error playing raw PCM audio:",n)}}function He(e,t){if(v||W)return;ge(),v=!0,W=!0,J("You",e);const n=Ce("AI");let r="",o="";pe=typeof performance<"u"?performance.now():Date.now(),ue=!1,fe=!1,ne=!1;const s=setTimeout(()=>{v&&(v=!1,W=!1)},15e3);Ge(e,i=>{if(!ue&&pe!=null?(ue=!0,r+=i,n.update(r),o+=i):(r+=i,n.update(r),o+=i),Je(o)){const l=ve(o);l.length>0&&(F.push(...l),o="",M||(typeof performance<"u"?performance.now():Date.now(),Se()))}}).then(()=>{if(o.trim()){const i=ve(o.trim());F.push(...i),M||(typeof performance<"u"?performance.now():Date.now(),Se())}r.trim()&&J("AI",r.trim()),r="",o="",v=!1,W=!1,clearTimeout(s),setTimeout(()=>{b&&!T&&!v&&U("after-ai-response")},0),et(),window.gc&&window.gc()}).catch(i=>{console.error("AI response error:",i.message),r="",o="",v=!1,W=!1,clearTimeout(s),setTimeout(()=>{b&&!T&&!v&&U("after-ai-error")},1e3),window.gc&&window.gc()})}function Je(e){return!!(/[.!?]\s*$/.test(e)||/, \s*$/.test(e)||e.length>150)}function ve(e){const t=e.trim();if(!t)return[];if(/[.!?]\s*$/.test(t))return[t];if(/, \s*$/.test(t))return[t];if(t.length>150){const n=t.match(/.*[.!?]\s*$/);if(n)return[n[0].trim()]}return[]}async function je(){if(!(O.length===0||_)){for(_=!0;O.length>0&&!k;){const e=O.shift();try{await Ie(e,44100),h&&!k&&await new Promise(t=>{const n=()=>{k&&console.log("Queue playback stopped due to user speech"),t()};h.onended=n})}catch(t){console.error("Error playing audio from queue:",t)}if(k){console.log("Stopping queue playback due to user speech");break}}_=!1,k||setTimeout(()=>{Ye()},0)}}async function Se(){if(!M){for(M=!0;F.length>0&&!k;){const e=F.splice(0,2);for(let t=0;t<e.length;t++){const n=e[t];if(k){console.log("Stopping audio buffering due to user speech");break}try{const r=await qe(n);O.push(r),!_&&!k&&je()}catch(r){console.error("Cartesia TTS error:",r);try{k||await Oe(n)}catch(o){console.error("Fallback TTS error:",o)}}}}M=!1}}function Ye(){!M&&O.length}async function qe(e){return new Promise((t,n)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(r=>{var c;if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const o=(c=r.body)==null?void 0:c.getReader(),s=new TextDecoder("utf-8");let i="",l=[];async function a(){try{const{done:d,value:w}=await o.read();if(d){if(l.length>0){const m=new Uint8Array(l.reduce((y,B)=>y+B.length,0));let u=0;for(const y of l)m.set(y,u),u+=y.length;l=[],window.gc&&window.gc(),t(m.buffer)}else n(new Error("No audio data received"));return}i+=s.decode(w,{stream:!0});let f=i.split(/\r?\n/);i=f.pop()||"";for(const m of f)if(m.startsWith("data: "))try{const u=JSON.parse(m.slice(6));if(u.audio_chunk){const y=Uint8Array.from(atob(u.audio_chunk),B=>B.charCodeAt(0));l.push(y)}else u.status==="complete"||u.error&&n(new Error(u.error))}catch{}a()}catch(d){n(d)}}a()}).catch(n)})}function Ce(e){const t=de(Q),n=document.createElement("div");n.className="transcript-item "+(e==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"ðŸ¤–":"ðŸ§‘"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${e}  ${t}</div>
    `;const r=n.querySelector(".transcript-content");return we.appendChild(n),{update:o=>{r.textContent=o},remove:()=>{r.textContent=""},getText:()=>r.textContent||""}}let L=null,H=!1,$=!1,q=null,G=[],Te=24e3,re="",P=0,K="",ye=-1;async function Ve(){const e=localStorage.getItem("selectedAgentType")||"discovery-call";try{const t=await fetch(`/api/get_agent_prompt?agent_type=${e}`);if(t.ok){const n=await t.json();n.success&&n.prompt?K=n.prompt:(console.error("Invalid response format:",n),K="You are a helpful sales training coach. Speak naturally and concisely.")}else{const n=await t.text();console.error("Failed to fetch agent prompt:",t.status,n),K="You are a helpful sales training coach. Speak naturally and concisely."}}catch(t){console.error("Error fetching agent prompt:",t),K="You are a helpful sales training coach. Speak naturally and concisely."}}async function oe(e){return new Promise(async(t,n)=>{if(H&&L){q=e||null,t();return}if($){const o=setInterval(()=>{H&&(clearInterval(o),q=e||null,t())},100);return}let r;try{const o=await fetch("/api/openai-realtime-token",{method:"GET"});if(!o.ok)throw new Error("Failed to get OpenAI token");const i=(await o.json()).token,a=`wss://api.openai.com/v1/realtime?model=${encodeURIComponent("gpt-4o-realtime-preview-2024-12-17")}`;$=!0,q=e||null;const c=["realtime",`openai-insecure-api-key.${i}`];r=new WebSocket(a,c),L=r;const d=setTimeout(()=>{r.readyState===WebSocket.CONNECTING&&(console.error("WebSocket connection timeout"),r.close(),n(new Error("WebSocket connection timeout after 10 seconds")))},1e4);r.addEventListener("open",()=>{clearTimeout(d)})}catch(o){console.error("Connection establishment error:",o),n(new Error("Failed to establish connection: "+o.message));return}r.onopen=()=>{H=!0,$=!1;const s={type:"session.update",session:{type:"realtime",model:"gpt-4o-realtime-preview",instructions:K||"You are a helpful sales training coach.",voice:"alloy",tools:[],tool_choice:"none"}};r.send(JSON.stringify(s)),setTimeout(()=>{const i={type:"response.create",response:{instructions:"Start the conversation by saying: 'Hey, who's this?'"}};r.send(JSON.stringify(i))},200),t()},r.onerror=o=>{$=!1,console.error("Realtime WebSocket error:",o),console.error("WebSocket readyState:",r.readyState),console.error("WebSocket URL:",r.url),n(new Error("Realtime WebSocket error: "+JSON.stringify(o)))},r.onclose=o=>{H=!1,$=!1,L=null,q=null,G=[],console.error("WebSocket closed:",o.code,o.reason),console.error("Close event details:",o),b&&setTimeout(()=>{b&&!H&&!$&&oe()},2e3)},r.onmessage=async o=>{try{const s=JSON.parse(o.data),i=s.type;if(i==="response.output_text.delta"){const l=s.delta;if(l&&l.includes("tool_uses"))return;s.delta&&(re+=s.delta),q&&s.delta&&q(s.delta)}else if(i!=="response.output_text.done")if(i==="response.output_audio.delta"){if(k||A.trim()){console.log("User is speaking, skipping AI audio chunk");return}ne=!0;const l=s.delta;if(l){const a=atob(l),c=new Int16Array(a.length/2);for(let u=0;u<a.length;u+=2)c[u/2]=a.charCodeAt(u)|a.charCodeAt(u+1)<<8;G.push(c);const d=new Float32Array(c.length);for(let u=0;u<c.length;u++)d[u]=Math.max(-1,Math.min(1,c[u]/32768));p||(p=new(window.AudioContext||window.webkitAudioContext)),p.state==="suspended"&&await p.resume();const w=p.createBuffer(1,d.length,Te);w.copyToChannel(d,0);const f=p.createBufferSource();f.buffer=w,f.connect(p.destination),I&&Z&&f.connect(I);const m=w.duration;(P===0||P<p.currentTime)&&(P=p.currentTime),f.start(P),P+=m,h=f,f.addEventListener("ended",()=>{k&&console.log("AI audio chunk ended due to user speech")})}}else if(i==="response.output_audio.done"){const l=G.reduce((f,m)=>f+m.length,0),a=new Int16Array(l);let c=0;for(const f of G)a.set(f,c),c+=f.length;const d=new Float32Array(a.length);for(let f=0;f<a.length;f++)d[f]=Math.max(-1,Math.min(1,a[f]/32768));p||(p=new(window.AudioContext||window.webkitAudioContext));const w=p.createBuffer(1,d.length,Te);w.copyToChannel(d,0),window.lastAIAudioBuffer=w,window.lastAIAudioTime=Date.now(),G=[],P=0}else if(i==="response.created")re="",P=0;else if(i==="response.done"){let l=re.trim();l.includes("tool_uses")&&(l=l.replace(/\{"tool_uses":\[.*?\]\}/g,"").trim()),l?J("AI",l):window.lastAIAudioBuffer?$e(window.lastAIAudioBuffer):J("AI","[AI provided audio response]"),re=""}else i==="session.updated"||i==="error"&&(console.error("Realtime error:",s),console.error("Error details:",JSON.stringify(s.error,null,2)))}catch{}}})}async function Ge(e,t){if(await oe(t),!L)return;for(let o=ye+1;o<C.length;o++){const s=C[o],i={type:"conversation.item.create",item:{type:"message",role:s.sender==="You"?"user":"assistant",content:[{type:"input_text",text:s.text}]}};L.send(JSON.stringify(i))}ye=C.length-1;const n={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:e}]}};L.send(JSON.stringify(n));const r={type:"response.create"};L.send(JSON.stringify(r))}function Qe(e){const t=document.getElementById("recordingDot");t&&t.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(e)}function le(e){Pe.querySelectorAll(".voice-wave-bar").forEach(n=>{e?n.classList.add("active"):n.classList.remove("active")})}async function Xe(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});ie=e,p||(p=new(window.AudioContext||window.webkitAudioContext)),I=p.createMediaStreamDestination(),N=p.createMediaStreamSource(e),N.connect(I);let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm"),MediaRecorder.isTypeSupported(t)||(t="audio/mp4"),MediaRecorder.isTypeSupported(t)||(t="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(t)||(t="audio/wav"),R=new MediaRecorder(I.stream,{mimeType:t}),D=[],Z=!0,me=Date.now(),R.ondataavailable=n=>{n.data.size>0&&D.push(n.data)},R.onstop=()=>{if(D.length>0){const n=new Blob(D,{type:t}),r=new FileReader;r.onload=()=>{const o=r.result;window.conversationRecordingData=o,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const s=(Date.now()-me)/1e3;sessionStorage.setItem("recordingDuration",s.toString())},r.readAsDataURL(n)}N&&(N.disconnect(),N=null),I&&(I.disconnect(),I=null),e&&e.getTracks().forEach(n=>n.stop())},R.start(1e3)}catch(e){console.error("Error starting audio recording:",e),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function Ke(){return new Promise((e,t)=>{if(!R||!Z){e();return}Z=!1;const n=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),se(),t(new Error("Audio recording stop timeout"))},1e4);R.onstop=()=>{if(clearTimeout(n),D.length>0){const r=new Blob(D,{type:(R==null?void 0:R.mimeType)||"audio/webm"}),o=new FileReader;o.onload=()=>{const s=o.result;window.conversationRecordingData=s,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const i=(Date.now()-me)/1e3;sessionStorage.setItem("recordingDuration",i.toString()),se(),e()},o.readAsDataURL(r)}else se(),e()};try{R.stop()}catch(r){clearTimeout(n),console.error("Error stopping media recorder:",r),se(),t(r)}})}function se(){N&&(N.disconnect(),N=null),I&&(I.disconnect(),I=null),ie&&(ie.getTracks().forEach(e=>e.stop()),ie=null),R=null,D=[]}async function Ze(){try{x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">save</span><span style="font-size:15px;font-weight:600;">Saving...</span>',x.style.background="rgba(34,197,94,0.95)",await new Promise(S=>setTimeout(S,100));const e=sessionStorage.getItem("hasRecording"),t=window.conversationRecordingData,n=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(!e||e!=="true"||!t){await new Promise(Y=>setTimeout(Y,500));const S=sessionStorage.getItem("hasRecording"),j=window.conversationRecordingData;(!S||S!=="true"||!j)&&console.error("Still no audio recording after retry")}sessionStorage.setItem("chatTranscript",JSON.stringify(C));const o=localStorage.getItem("selectedAgentId"),s=localStorage.getItem("selectedAgentType"),i=localStorage.getItem("selectedAgentTitle"),l=ot(),a=l.length/1024/1024;let c=null,d=l;if(a>5)try{const S=await ke("/api/db/upload_audio",{method:"POST",body:JSON.stringify({audio_data:l,filename:`conversation_${Date.now()}.webm`})});S.ok?(c=(await S.json()).audio_url,d=btoa(`stored_in_supabase_storage:${c}`)):d=btoa(`upload_failed_${a.toFixed(2)}MB`)}catch(S){console.error("Audio upload error:",S),d=btoa(`upload_error_${a.toFixed(2)}MB`)}const w={title:`${i}`,agent_id:o,duration_seconds:he(),total_exchanges:C.length,full_conversation:nt(),transcript:C,audio_data:d,audio_url:c,audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:rt(),user_agent:navigator.userAgent,ip_address:await st(),status:"completed",tags:["sales_call","training",s||"general"],notes:`Sales training conversation using ${i||"general"} agent `},f=new Promise((S,j)=>setTimeout(()=>j(new Error("Database save timeout after 30 seconds")),3e4)),m=ke("/api/db/save_conversation",{method:"POST",body:JSON.stringify(w)}),u=await Promise.race([m,f]);if(!u.ok){const S=await u.text();throw console.error("Conversation save error:",S),new Error(`Failed to save conversation: ${u.status} - ${S}`)}const y=await u.json();if(!y.success)throw new Error(`Failed to save conversation: ${y.error}`);const B=y.conversation_id;sessionStorage.setItem("conversationId",B),await new Promise(S=>setTimeout(S,500)),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">check_circle</span><span style="font-size:15px;font-weight:600;">Success!</span>',x.style.background="rgba(34,197,94,0.95)",window.location.href="/success.html"}catch(e){console.error("Error saving conversation:",e);const t=e.message.toLowerCase();if(t.includes("timeout")||t.includes("too large")){alert("Conversation was too long for database storage. The transcript has been saved locally, but audio recording was not saved due to size limits.");const n={timestamp:new Date().toISOString(),duration:he(),transcript:C,agent_type:localStorage.getItem("selectedAgentType")};localStorage.setItem("lastConversationBackup",JSON.stringify(n)),window.location.href="/success.html"}else alert("Failed to save conversation. Please try again."),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",te=!0}}function Ee(){F=[],A="",V="",D=[],window.gc&&window.gc()}function et(){const e=window.conversationRecordingData?window.conversationRecordingData.length:0,t=F.join("").length;e+t>10*1024*1024&&Ee()}function tt(){["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(t=>{sessionStorage.getItem(t)&&sessionStorage.removeItem(t)}),D.length>0&&(D=[]),window.conversationRecordingData=null,Ee()}function he(){const e=sessionStorage.getItem("callStartTime");if(!e)return 0;const t=new Date(e).getTime(),n=new Date().getTime();return Math.floor((n-t)/1e3)}function nt(){return C.map((e,t)=>({user:e.sender==="You"?e.text:"",assistant:e.sender==="AI"?e.text:"",timestamp:new Date().toISOString()}))}function ot(){const e=window.conversationRecordingData,t=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(e&&t==="true"&&n&&r&&e.length>1e3&&!e.includes("audio_data_placeholder")){const o=parseInt(r);if(Date.now()-o<2*60*60*1e3)return e}return btoa("audio_data_placeholder")}function rt(){const e=sessionStorage.getItem("recordingDuration"),t=sessionStorage.getItem("hasRecording"),n=window.conversationRecordingData;if(e&&t==="true"&&n){const o=parseFloat(e);if(o>0&&o<7200)return o}return he()}async function st(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(e){return console.error("Error getting client IP:",e),"127.0.0.1"}}async function Re(){const e=localStorage.getItem("refreshToken");if(!e)return console.error("No refresh token found"),null;try{const t=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(t.ok){const n=await t.json();return localStorage.setItem("accessToken",n.access_token),localStorage.setItem("refreshToken",n.refresh_token),localStorage.setItem("tokenExpiresAt",n.expires_at),n.access_token}else return console.error("Failed to refresh token"),null}catch(t){return console.error("Error refreshing token:",t),null}}function at(){const e=localStorage.getItem("tokenExpiresAt");if(!e)return!0;const t=new Date(e).getTime();return new Date().getTime()>=t-5*60*1e3}async function De(){if(at()){const t=await Re();return t||(console.error("Failed to refresh token"),localStorage.clear(),window.location.href="/login.html","")}const e=localStorage.getItem("accessToken");return e||(console.error("No access token found"),window.location.href="/login.html","")}async function ke(e,t={}){const n=await De(),r=await fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(r.status===401){const o=await Re();if(o)return fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return r}let te=!1;x.onclick=async()=>{if(te){x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">hourglass_empty</span><span style="font-size:15px;font-weight:600;">Processing...</span>',x.style.background="rgba(107,114,128,0.95)",x.disabled=!0,x.style.cursor="not-allowed",We(),Ne(),xe(),le(!1);try{Z&&await Ke(),C.length>0?await Ze():window.location.href="/success.html"}catch(e){console.error("Error during disconnect process:",e),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",te=!0,alert("Error disconnecting. Please try again.")}}else{await tt(),K||await Ve(),Me(),Le(),le(!0);try{await oe()}catch{alert("Failed to establish realtime connection. Please check your network connection and try again."),le(!1),xe();return}Xe(),Ae(),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",te=!0}};x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>';x.style.background="#8b5cf6";te=!1;Qe(!1);let ee=0;setInterval(()=>{!M&&O.length===0&&!_&&(v||(ee=0)),v&&(ee===0?ee=Date.now():Date.now()-ee>12e4&&(console.error("isProcessing stuck for 2+ minutes"),v=!1,ee=0))},3e3);document.addEventListener("click",async()=>{if(p&&p.state==="suspended")try{await p.resume()}catch(e){console.error("Failed to resume AudioContext:",e)}},{once:!0});
