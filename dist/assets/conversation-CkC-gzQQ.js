import"./modulepreload-polyfill-B5Qt9EMX.js";function fe(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function me(){const e=document.createElement("div");e.id="rulesOverlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10000",e.style.pointerEvents="auto";const t=document.createElement("div");t.style.background="#ffffff",t.style.borderRadius="16px",t.style.padding="32px",t.style.maxWidth="500px",t.style.width="90%",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.border="1px solid #e2e8f0",t.style.position="relative";const o=document.createElement("h2");o.innerHTML="Hey ðŸ‘‹ Please take a look at the rules for role-play done right.",o.style.fontSize="20px",o.style.fontWeight="700",o.style.color="#1e293b",o.style.marginBottom="24px",o.style.lineHeight="1.4";const n=document.createElement("ul");n.style.listStyle="none",n.style.padding="0",n.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile ðŸ˜Š","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(y=>{const h=document.createElement("li");h.style.display="flex",h.style.alignItems="flex-start",h.style.gap="12px",h.style.marginBottom="16px",h.style.fontSize="15px",h.style.lineHeight="1.6",h.style.color="#475569";const u=document.createElement("span");u.innerHTML="â€¢",u.style.color="#8b5cf6",u.style.fontWeight="bold",u.style.fontSize="18px",u.style.lineHeight="1.2";const f=document.createElement("span");f.textContent=y,h.appendChild(u),h.appendChild(f),n.appendChild(h)});const r=document.createElement("p");r.innerHTML="Let's go ðŸš€",r.style.fontSize="16px",r.style.fontWeight="700",r.style.color="#1e293b",r.style.marginBottom="24px",r.style.marginTop="0";const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.gap="12px",c.style.marginBottom="24px",c.style.padding="16px",c.style.background="#f8fafc",c.style.borderRadius="8px",c.style.border="1px solid #e2e8f0";const l=document.createElement("input");l.type="checkbox",l.id="rulesCheckbox",l.style.width="18px",l.style.height="18px",l.style.cursor="pointer",l.style.accentColor="#8b5cf6";const a=document.createElement("label");a.htmlFor="rulesCheckbox",a.textContent="I have read and understood the rules above",a.style.fontSize="14px",a.style.fontWeight="500",a.style.color="#475569",a.style.cursor="pointer",a.style.flex="1",c.appendChild(l),c.appendChild(a);const s=document.createElement("button");s.textContent="I agree",s.id="agreeButton",s.style.background="#e2e8f0",s.style.color="#64748b",s.style.border="none",s.style.borderRadius="12px",s.style.padding="14px 24px",s.style.fontSize="16px",s.style.fontWeight="600",s.style.cursor="not-allowed",s.style.width="100%",s.style.transition="all 0.2s",s.disabled=!0,t.appendChild(o),t.appendChild(n),t.appendChild(r),t.appendChild(c),t.appendChild(s),e.appendChild(t),document.body.appendChild(e);const g=()=>{l.checked?(s.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",s.style.color="white",s.style.cursor="pointer",s.disabled=!1,s.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(s.style.background="#e2e8f0",s.style.color="#64748b",s.style.cursor="not-allowed",s.disabled=!0,s.style.boxShadow="none")};l.addEventListener("change",g),s.addEventListener("click",()=>{s.disabled||e.remove()}),e.addEventListener("click",y=>{y.target})}function ge(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",me();const e=document.createElement("div");e.className="top-bar",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="50px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="15px",e.style.padding="0 18px",e.style.background="rgba(255,255,255,0.25)",e.style.backdropFilter="blur(12px)",e.style.zIndex="100",e.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",e.style.overflow="visible";const t=document.createElement("button");t.innerHTML="â† Back to details",t.style.position="fixed",t.style.top="8px",t.style.left="18px",t.style.background="rgba(255,255,255,0.9)",t.style.border="1px solid rgba(0,0,0,0.1)",t.style.borderRadius="8px",t.style.padding="6px 12px",t.style.fontSize="13px",t.style.fontWeight="500",t.style.color="#374151",t.style.cursor="pointer",t.style.transition="all 0.2s",t.style.zIndex="200",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.onclick=()=>window.location.href="/agent-info.html",t.onmouseover=()=>{t.style.background="rgba(255,255,255,0.95)",t.style.transform="translateY(-1px)"},t.onmouseout=()=>{t.style.background="rgba(255,255,255,0.9)",t.style.transform="translateY(0)"};const o=localStorage.getItem("selectedAgentType")||"payment-followup",n={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},i=document.createElement("div");i.textContent=n[o]||"Sales Training",i.style.fontSize="18px",i.style.fontWeight="500",i.style.letterSpacing="0.5px",i.style.color="#23272f",i.style.opacity="0.92",i.style.whiteSpace="nowrap";const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",r.style.fontSize="1.1rem",r.style.color="#23272f",r.style.fontWeight="500",r.style.opacity="0.85",r.style.whiteSpace="nowrap";const c=document.createElement("span");c.id="timer",c.textContent="00:00";const l=document.createElement("span");l.id="recordingDot",l.textContent="â€¢",l.style.fontSize="1.5em",l.style.color="#e11d48",l.style.opacity="0",l.style.transition="opacity 0.3s",r.appendChild(c),r.appendChild(l),e.appendChild(t),e.appendChild(i),e.appendChild(r),document.body.appendChild(e);const a=document.createElement("div");a.id="customerName",a.style.position="fixed",a.style.left="50%",a.style.top="50px",a.style.transform="translateX(-50%)",a.style.zIndex="10",a.style.color="#1e293b",a.style.fontSize="16px",a.style.fontWeight="600",a.style.textAlign="center",a.style.whiteSpace="nowrap",a.style.pointerEvents="none",a.style.background="rgba(255, 255, 255, 0.9)",a.style.padding="8px 16px",a.style.marginTop="36px",a.style.borderRadius="20px",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",a.style.border="1px solid rgba(226, 232, 240, 0.8)";const s=localStorage.getItem("selectedAgentName")||"Customer";a.textContent=`Customer Name: ${s}`,document.body.appendChild(a);const g=document.createElement("div");g.className="voice-wave-area",g.id="voiceWaveArea",g.style.position="fixed",g.style.top="50px",g.style.left="0",g.style.width="100vw",g.style.height="calc(100vh - 50px)",g.style.display="flex",g.style.flexDirection="column",g.style.justifyContent="center",g.style.alignItems="center",g.style.zIndex="1",g.style.background="transparent";const y=document.createElement("div");y.className="voice-wave-container",y.id="voiceWaveContainer",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.gap="4px",y.style.height="60px";for(let A=0;A<20;A++){const C=document.createElement("div");C.className="voice-wave-bar",C.style.width="3px",C.style.height="4px",C.style.background="rgba(37,99,235,0.3)",C.style.borderRadius="2px",C.style.transition="height 0.1s ease",y.appendChild(C)}g.appendChild(y),document.body.appendChild(g);const h=document.createElement("div");h.id="hiddenTranscript",h.style.display="none",document.body.appendChild(h);const u=document.createElement("div");u.className="mic-wrap",u.style.position="fixed",u.style.left="50%",u.style.bottom="48px",u.style.transform="translateX(-50%)",u.style.zIndex="20",u.style.display="flex",u.style.flexDirection="row",u.style.alignItems="center",u.style.gap="24px";const f=document.createElement("div");f.className="ocean-animation",f.style.position="absolute",f.style.left="50%",f.style.top="50%",f.style.transform="translate(-50%, -50%)",f.style.zIndex="-1",f.style.pointerEvents="none",f.style.width="160px",f.style.height="160px";const d=document.createElement("button");d.className="voice-btn mic-btn",d.id="micBtn",d.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;">mic</span>',d.style.width="50px",d.style.height="50px",d.style.borderRadius="50%",d.style.background="rgba(37,99,235,0.95)",d.style.color="#fff",d.style.border="none",d.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.style.fontWeight="700",d.style.fontSize="1.3rem",d.style.cursor="pointer",d.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",d.style.position="relative",d.style.outline="none",d.style.visibility="visible";const m=document.createElement("div");m.id="buttonText",m.textContent="Start Recording",m.style.position="absolute",m.style.top="-40px",m.style.left="50%",m.style.transform="translateX(-50%)",m.style.color="#1e293b",m.style.fontSize="14px",m.style.fontWeight="600",m.style.whiteSpace="nowrap",m.style.pointerEvents="auto",m.style.transition="color 0.2s",m.onclick=()=>{if(b&&!x){console.log("ðŸ”§ Manual restart triggered by user"),m.style.color="#f59e0b",m.textContent="Restarting...";try{p==null||p.start()}catch(A){console.error("Manual restart failed:",A),ne()}}},m.style.cursor="pointer",m.style.userSelect="none",u.appendChild(m),u.appendChild(d),u.appendChild(f),document.body.appendChild(u);const B=document.createElement("link");B.rel="stylesheet",B.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(B);const O=document.createElement("style");O.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(O);function S(A){if(f.innerHTML="",A)for(let C=0;C<2;C++){const _=document.createElement("div");_.className="wave"+(C===1?" wave2":""),_.style.width="0px",_.style.height="0px",_.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",_.style.position="absolute",_.style.left="50%",_.style.top="50%",_.style.transform="translate(-50%, -50%)",f.appendChild(_)}}window.showOceanAnimation=S}fe()?ge():window.location.href="/login.html";let p=null,b=!1,T=!1,V=null,F=0,P=[],x=!1,H=!1,k=null,z=[],$=!1,v=null,N=[],L=!1,W="",E=null,R=[],q=!1,Q=null,G=0,D=null,M=null;const w=document.getElementById("micBtn"),re=document.getElementById("timer"),ye=document.getElementById("voiceWaveContainer"),oe=document.getElementById("hiddenTranscript");let I="";function X(e){const t=Math.floor(e/60).toString().padStart(2,"0"),o=(e%60).toString().padStart(2,"0");return`${t}:${o}`}function he(){F=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),re.textContent=X(F),V=window.setInterval(()=>{F++,re.textContent=X(F)},1e3)}function we(){V&&(clearInterval(V),V=null)}function K(e,t){const o=X(F);P.push({sender:e,text:t,time:o});const n=document.createElement("div");n.className="transcript-item "+(e==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"ðŸ¤–":"ðŸ§‘"}</div>
        <div class="transcript-content">${t}</div>
        <div class="transcript-meta">${e}  ${o}</div>
    `,oe.appendChild(n)}function be(){P=[],oe.innerHTML=""}function ne(){if(b||T||x)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){alert("Your browser does not support Web Speech API.");return}p=new e,p.lang="en-US",p.interimResults=!0,p.maxAlternatives=1,p.continuous=!0,"webkitSpeechRecognition"in window&&(p.continuous=!0,p.interimResults=!0,p.maxAlternatives=1),b=!0,T=!1;let t="";I="";let o=null,n=null;p.onresult=r=>{xe();let c="",l=!1;for(let a=r.resultIndex;a<r.results.length;a++){const s=r.results[a][0].transcript;r.results[a].isFinal?(t+=s,I+=s,l=!0):c+=s}if(c&&!l){o||(o=de("You"));const a=(I+" "+c).trim();o.update(a),Z(!0),n&&(clearTimeout(n),n=null)}l&&t.trim()&&(n=window.setTimeout(()=>{if(t.trim().length>0){const a=t.trim();if(t="",a.length>0){ke(a),I="";const s=document.querySelector(".transcript-item.you .transcript-content");s&&(s.textContent="")}}n=null},300))},p.onerror=r=>{console.error("Speech recognition error:",r.error),r.error==="network"?(console.warn("Network error in speech recognition, attempting restart..."),setTimeout(()=>{b&&!x&&(p==null||p.start())},1e3)):r.error==="aborted"?(console.log("Speech recognition was aborted"),b=!1,T=!1,x=!1):r.error==="audio-capture"?(console.error("Audio capture error - microphone issue"),b=!1,T=!1,x=!1,alert("Microphone access error. Please check your microphone permissions and try again.")):r.error==="not-allowed"?(console.error("Speech recognition not allowed"),b=!1,T=!1,x=!1,alert("Speech recognition permission denied. Please allow microphone access and reload the page.")):(console.warn(`Speech recognition error: ${r.error}, attempting restart...`),x=!1,setTimeout(()=>{b&&!x&&U("error-recovery")},2e3))},p.onstart=()=>{x=!0,console.log("ðŸŽ¤ Microphone is listening and ready for speech input");const r=document.getElementById("buttonText");r&&b&&(r.style.color="#10b981",r.textContent="Listening...")},p.onend=()=>{x=!1,console.log("ðŸŽ¤ Speech recognition ended");const r=document.getElementById("buttonText");if(r&&b&&(r.style.color="#f59e0b",r.textContent="Restarting..."),b&&!T&&!x&&b){const c=o?o.getText():"",l=t,a=I;setTimeout(()=>{b&&!x&&(l&&(t=l),a&&(I=a),U("natural-end"),c&&o&&setTimeout(()=>{o&&o.update(c)},150))},100)}},p.start(),p.startTime=Date.now();const i=setInterval(()=>{if(!b){clearInterval(i);return}b&&!x&&!T&&!H&&(console.log("ðŸ¥ Health check: Recognition not active, restarting..."),U("health-check"));const r=Date.now();p&&p.startTime&&r-p.startTime>3*60*1e3&&(console.log("ðŸ”„ Proactive restart to prevent browser timeout"),p.startTime=r,U("proactive-timeout"))},10*1e3)}function xe(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),v){try{v.stop(),v.disconnect()}catch{}v=null}z=[],$=!1}function ve(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),v){try{v.stop(),v.disconnect()}catch{}v=null}z=[],$=!1,N=[],L=!1}function U(e="manual"){if(H||!b){console.log(`â­ï¸ Skipping restart (${e}) - already restarting or not listening`);return}H=!0,console.log(`ðŸ”„ Safe restart triggered: ${e}`);try{p&&x&&p.stop(),setTimeout(()=>{if(b&&!x)try{p==null||p.start(),console.log("âœ… Recognition restarted successfully")}catch(t){console.error("Restart failed, creating new recognition:",t),ne()}H=!1},100)}catch(t){console.error("Error in safe restart:",t),H=!1}}function Se(){if(b=!1,T=!1,x=!1,H=!1,p)try{p.stop()}catch{}if(I.trim()||W.trim()){const t=[];I&&I.trim()&&t.push(I.trim()),W&&W.trim()&&t.push(W.trim());const o=document.querySelector(".transcript-item.you .transcript-content");if(o&&o.textContent&&o.textContent.trim()){const n=o.textContent.trim();n.length>0&&t.push(n)}}W="",I="";const e=document.querySelector(".transcript-item.you .transcript-content");e&&(e.textContent="")}async function le(e){try{const t=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const o=await t.json();await Te(o.audio_data,"pcm_f32le",o.sample_rate)}catch(t){if(console.error("Cartesia TTS error:",t),window.speechSynthesis){const o=new SpeechSynthesisUtterance(e);o.rate=.9,o.pitch=1,window.speechSynthesis.speak(o)}}}async function Te(e,t="pcm_f32le",o=44100){const n=Uint8Array.from(atob(e),i=>i.charCodeAt(0));await ce(n.buffer,o)}async function ce(e,t){if(k||(k=new(window.AudioContext||window.webkitAudioContext)),k.state==="suspended")try{await k.resume()}catch(o){console.error("Failed to resume audio context:",o);return}try{const o=k.createBuffer(1,e.byteLength/4,t),n=o.getChannelData(0),i=new Float32Array(e);n.set(i),v&&(v.stop(),v.disconnect()),v=k.createBufferSource(),v.buffer=o,v.connect(k.destination),D&&q&&v.connect(D),v.start()}catch(o){console.error("Error playing raw PCM audio:",o)}}function ke(e){if(T)return;T=!0,K("You",e);const t=de("AI");let o="",n="";De(e,i=>{if(o+=i,t.update(o),n+=i,Ce(n)){const r=ae(n);r.length>0&&(N.push(...r),n="",L||ie())}}).then(()=>{if(n.trim()){const i=ae(n.trim());N.push(...i),L||ie()}o.trim()&&K("AI",o.trim()),o="",n="",T=!1,setTimeout(()=>{b&&!x&&!T&&U("after-ai-response")},500),ze(),window.gc&&window.gc()}).catch(i=>{t.update("Error: "+i.message),o="",n="",T=!1,setTimeout(()=>{b&&!x&&!T&&U("after-ai-error")},1e3),window.gc&&window.gc()})}function Ce(e){return!!(/[.!?]\s*$/.test(e)||/, \s*$/.test(e)||e.length>150)}function ae(e){const t=e.trim();if(!t)return[];if(/[.!?]\s*$/.test(t))return[t];if(/, \s*$/.test(t))return[t];if(t.length>150){const o=t.match(/.*[.!?]\s*$/);if(o)return[o[0].trim()]}return[]}async function Ie(){if(!(z.length===0||$)){for($=!0;z.length>0;){const e=z.shift();try{await ce(e,44100),v&&await new Promise(t=>{v.onended=()=>t()})}catch(t){console.error("Error playing audio from queue:",t)}}$=!1,setTimeout(()=>{Ae()},500)}}async function ie(){if(!L){for(L=!0;N.length>0;){const e=N.splice(0,2);for(let t=0;t<e.length;t++){const o=e[t];try{const n=await Ee(o);z.push(n),$||Ie()}catch(n){console.error("Cartesia TTS error:",n);try{await le(o)}catch(i){console.error("Fallback TTS error:",i)}}}}L=!1}}function Ae(){!L&&z.length}async function Ee(e){return new Promise((t,o)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(n=>{var s;if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const i=(s=n.body)==null?void 0:s.getReader(),r=new TextDecoder("utf-8");let c="",l=[];async function a(){try{const{done:g,value:y}=await i.read();if(g){if(l.length>0){const u=new Uint8Array(l.reduce((d,m)=>d+m.length,0));let f=0;for(const d of l)u.set(d,f),f+=d.length;l=[],window.gc&&window.gc(),t(u.buffer)}else o(new Error("No audio data received"));return}c+=r.decode(y,{stream:!0});let h=c.split(/\r?\n/);c=h.pop()||"";for(const u of h)if(u.startsWith("data: "))try{const f=JSON.parse(u.slice(6));if(f.audio_chunk){const d=Uint8Array.from(atob(f.audio_chunk),m=>m.charCodeAt(0));l.push(d)}else f.status==="complete"||f.error&&o(new Error(f.error))}catch{}a()}catch(g){o(g)}}a()}).catch(o)})}function de(e){const t=X(F),o=document.createElement("div");o.className="transcript-item "+(e==="AI"?"ai":"you"),o.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"ðŸ¤–":"ðŸ§‘"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${e}  ${t}</div>
    `;const n=o.querySelector(".transcript-content");return oe.appendChild(o),{update:i=>{n.textContent=i},remove:()=>{n.textContent=""},getText:()=>n.textContent||""}}function De(e,t){return new Promise((o,n)=>{const i=new AbortController,r=setTimeout(()=>{i.abort(),n(new Error("Request timeout after 60 seconds"))},6e4),c=localStorage.getItem("selectedAgentType")||"discovery-call",l=localStorage.getItem("currentSessionId")||Pe();localStorage.setItem("currentSessionId",l),console.log("ðŸ” Using session ID:",l),console.log("ðŸ” User input:",e),console.log("ðŸ” Agent type:",c),fetch("/chat_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,agent_type:c,session_id:l}),signal:i.signal}).then(a=>{if(!a.body)throw new Error("No response body");const s=a.body.getReader(),g=new TextDecoder("utf-8");let y="";function h(){s.read().then(({done:u,value:f})=>{if(u){clearTimeout(r),o();return}y+=g.decode(f,{stream:!0});let d=y.split(/\r?\n/);y=d.pop()||"";for(const m of d)if(m.startsWith("data: "))try{const B=JSON.parse(m.slice(6));B.reply&&t(B.reply)}catch{}h()}).catch(u=>{clearTimeout(r),n(u)})}h()}).catch(a=>{clearTimeout(r),n(a)})})}function Re(e){const t=document.getElementById("recordingDot");t&&t.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(e)}function Z(e){ye.querySelectorAll(".voice-wave-bar").forEach(o=>{e?o.classList.add("active"):o.classList.remove("active")})}async function Be(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});Q=e,k||(k=new(window.AudioContext||window.webkitAudioContext)),D=k.createMediaStreamDestination(),M=k.createMediaStreamSource(e),M.connect(D);let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm"),MediaRecorder.isTypeSupported(t)||(t="audio/mp4"),MediaRecorder.isTypeSupported(t)||(t="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(t)||(t="audio/wav"),E=new MediaRecorder(D.stream,{mimeType:t}),R=[],q=!0,G=Date.now();const o=document.getElementById("buttonText");o&&(o.textContent="Stop Recording",o.style.color="#ef4444"),E.ondataavailable=n=>{n.data.size>0&&R.push(n.data)},E.onstop=()=>{if(R.length>0){const n=new Blob(R,{type:t}),i=new FileReader;i.onload=()=>{const r=i.result;window.conversationRecordingData=r,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const c=(Date.now()-G)/1e3;sessionStorage.setItem("recordingDuration",c.toString())},i.readAsDataURL(n)}M&&(M.disconnect(),M=null),D&&(D.disconnect(),D=null),e&&e.getTracks().forEach(n=>n.stop())},E.start(1e3)}catch(e){console.error("Error starting audio recording:",e),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function _e(){return new Promise((e,t)=>{if(!E||!q){e();return}q=!1;const o=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),Y(),t(new Error("Audio recording stop timeout"))},1e4);E.onstop=()=>{if(clearTimeout(o),R.length>0){const n=new Blob(R,{type:(E==null?void 0:E.mimeType)||"audio/webm"}),i=new FileReader;i.onload=()=>{const r=i.result;window.conversationRecordingData=r,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const c=(Date.now()-G)/1e3;sessionStorage.setItem("recordingDuration",c.toString()),Y(),e()},i.readAsDataURL(n)}else Y(),e()};try{E.stop()}catch(n){clearTimeout(o),console.error("Error stopping media recorder:",n),Y(),t(n)}})}function Y(){M&&(M.disconnect(),M=null),D&&(D.disconnect(),D=null),Q&&(Q.getTracks().forEach(t=>t.stop()),Q=null),E=null,R=[];const e=document.getElementById("buttonText");e&&(e.textContent="Start Recording",e.style.color="#1e293b")}async function Me(){try{w.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">save</span>',w.style.background="rgba(34,197,94,0.95)";const e=document.getElementById("buttonText");e&&(e.textContent="Saving...",e.style.color="#059669"),await new Promise(S=>setTimeout(S,100));const t=sessionStorage.getItem("hasRecording"),o=window.conversationRecordingData,n=sessionStorage.getItem("recordingDuration"),i=sessionStorage.getItem("recordingTimestamp");if(!t||t!=="true"||!o){await new Promise(C=>setTimeout(C,500));const S=sessionStorage.getItem("hasRecording"),A=window.conversationRecordingData;(!S||S!=="true"||!A)&&console.error("âŒ Still no audio recording after retry - proceeding with placeholder")}sessionStorage.setItem("chatTranscript",JSON.stringify(P));const r=localStorage.getItem("selectedAgentId"),c=localStorage.getItem("selectedAgentType"),l=localStorage.getItem("selectedAgentTitle"),a=Ne(),s=a.length/1024/1024;let g=null,y=a;if(s>5){console.log(`ðŸ“¤ Uploading large audio file (${s.toFixed(2)}MB) to storage...`);try{const S=await se("/api/db/upload_audio",{method:"POST",body:JSON.stringify({audio_data:a,filename:`conversation_${Date.now()}.webm`})});S.ok?(g=(await S.json()).audio_url,y=btoa(`stored_in_supabase_storage:${g}`),console.log(`âœ… Audio uploaded to storage: ${g}`)):(console.warn("âš ï¸ Audio upload failed, using truncated data"),y=btoa(`upload_failed_${s.toFixed(2)}MB`))}catch(S){console.error("Audio upload error:",S),y=btoa(`upload_error_${s.toFixed(2)}MB`)}}const h={title:`${l}`,agent_id:r,duration_seconds:ee(),total_exchanges:P.length,full_conversation:Le(),transcript:P,audio_data:y,audio_url:g,audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:Oe(),user_agent:navigator.userAgent,ip_address:await We(),status:"completed",tags:["sales_call","training",c||"general"],notes:`Sales training conversation using ${l||"general"} agent `},u=new Promise((S,A)=>setTimeout(()=>A(new Error("Database save timeout after 30 seconds")),3e4)),f=se("/api/db/save_conversation",{method:"POST",body:JSON.stringify(h)}),d=await Promise.race([f,u]);if(!d.ok){const S=await d.text();throw console.error("Conversation save error:",S),new Error(`Failed to save conversation: ${d.status} - ${S}`)}const m=await d.json();if(!m.success)throw new Error(`Failed to save conversation: ${m.error}`);const B=m.conversation_id;sessionStorage.setItem("conversationId",B),await new Promise(S=>setTimeout(S,500)),w.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">check_circle</span>',w.style.background="rgba(34,197,94,0.95)";const O=document.getElementById("buttonText");O&&(O.textContent="Success!",O.style.color="#059669"),window.location.href="/success.html"}catch(e){console.error("Error saving conversation:",e);const t=e.message.toLowerCase();if(t.includes("timeout")||t.includes("too large")){alert("Conversation was too long for database storage. The transcript has been saved locally, but audio recording was not saved due to size limits.");const o={timestamp:new Date().toISOString(),duration:ee(),transcript:P,agent_type:localStorage.getItem("selectedAgentType")};localStorage.setItem("lastConversationBackup",JSON.stringify(o)),window.location.href="/success.html"}else alert("Failed to save conversation. Please try again."),w.innerHTML=te,w.style.background="rgba(229,39,76,0.92)",w.disabled=!1,w.style.cursor="pointer",J=!0}}function Pe(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function ue(){N=[],I="",W="",R=[],window.gc&&window.gc(),console.log("ðŸ§¹ Cleared accumulated data to prevent memory buildup")}function ze(){const e=window.conversationRecordingData?window.conversationRecordingData.length:0,t=N.join("").length;e+t>10*1024*1024&&(console.warn("âš ï¸ Approaching memory limit, clearing accumulated data"),ue()),console.log(`ðŸ“Š Memory usage: Audio: ${(e/1024/1024).toFixed(2)}MB, Text: ${(t/1024).toFixed(2)}KB`)}function $e(){["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(t=>{sessionStorage.getItem(t)&&sessionStorage.removeItem(t)}),R.length>0&&(R=[]),window.conversationRecordingData=null,ue()}function ee(){const e=sessionStorage.getItem("callStartTime");if(!e)return 0;const t=new Date(e).getTime(),o=new Date().getTime();return Math.floor((o-t)/1e3)}function Le(){return P.map((e,t)=>({user:e.sender==="You"?e.text:"",assistant:e.sender==="AI"?e.text:"",timestamp:new Date().toISOString()}))}function Ne(){const e=window.conversationRecordingData,t=sessionStorage.getItem("hasRecording"),o=sessionStorage.getItem("recordingDuration"),n=sessionStorage.getItem("recordingTimestamp");if(e&&t==="true"&&o&&n&&e.length>1e3&&!e.includes("audio_data_placeholder")){const i=parseInt(n);if(Date.now()-i<2*60*60*1e3){const l=e.length/1024/1024;return console.log(`ðŸ“Š Audio size: ${l.toFixed(2)}MB`),e}}return btoa("audio_data_placeholder")}function Oe(){const e=sessionStorage.getItem("recordingDuration"),t=sessionStorage.getItem("hasRecording"),o=window.conversationRecordingData;if(e&&t==="true"&&o){const i=parseFloat(e);if(i>0&&i<7200)return i}return ee()}async function We(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(e){return console.error("Error getting client IP:",e),"127.0.0.1"}}async function pe(){const e=localStorage.getItem("refreshToken");if(!e)return console.error("No refresh token found"),null;try{const t=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(t.ok){const o=await t.json();return localStorage.setItem("accessToken",o.access_token),localStorage.setItem("refreshToken",o.refresh_token),localStorage.setItem("tokenExpiresAt",o.expires_at),o.access_token}else return console.error("Failed to refresh token"),null}catch(t){return console.error("Error refreshing token:",t),null}}function Fe(){const e=localStorage.getItem("tokenExpiresAt");if(!e)return!0;const t=new Date(e).getTime();return new Date().getTime()>=t-5*60*1e3}async function He(){if(Fe()){const t=await pe();return t||(console.error("Failed to refresh token, redirecting to login"),localStorage.clear(),window.location.href="/login.html","")}const e=localStorage.getItem("accessToken");return e||(console.error("No access token found! User must be logged in."),window.location.href="/login.html","")}async function se(e,t={}){const o=await He(),n=await fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(n.status===401){const i=await pe();if(i)return fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return n}let J=!1;const Ue='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic</span>',te='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic_off</span>';w.onclick=async()=>{if(J){w.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">hourglass_empty</span>',w.style.background="rgba(107,114,128,0.95)",w.disabled=!0,w.style.cursor="not-allowed",ve(),Se(),we(),Z(!1);try{q&&await _e(),P.length>0?await Me():window.location.href="/success.html"}catch(e){console.error("âŒ Error during disconnect process:",e),w.innerHTML=te,w.style.background="rgba(229,39,76,0.92)",w.disabled=!1,w.style.cursor="pointer",J=!0,alert("Error disconnecting. Please try again.")}}else{await $e(),be(),he(),Z(!0),Be();const e="Hey, who's this?";K("AI",e),le(e),ne(),w.innerHTML=te,w.style.background="rgba(229,39,76,0.92)",J=!0}};w.innerHTML=Ue;w.style.background="rgba(37,99,235,0.95)";J=!1;Re(!1);let j=0;setInterval(()=>{!L&&z.length===0&&!$&&(T||(j=0)),T&&(j===0?j=Date.now():Date.now()-j>12e4&&(console.error("âš ï¸ isProcessing stuck for 2+ minutes, forcing reset"),T=!1,j=0))},3e3);document.addEventListener("click",async()=>{if(k&&k.state==="suspended")try{await k.resume()}catch(e){console.error("Failed to resume AudioContext:",e)}},{once:!0});
