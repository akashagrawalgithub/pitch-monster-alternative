import"./modulepreload-polyfill-B5Qt9EMX.js";function Ce(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function Ee(){const t=document.createElement("div");t.id="rulesOverlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="10000",t.style.pointerEvents="auto";const e=document.createElement("div");e.style.background="#ffffff",e.style.borderRadius="16px",e.style.padding="32px",e.style.maxWidth="500px",e.style.width="90%",e.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",e.style.border="1px solid #e2e8f0",e.style.position="relative";const n=document.createElement("h2");n.innerHTML="Hey 👋 Please take a look at the rules for role-play done right.",n.style.fontSize="20px",n.style.fontWeight="700",n.style.color="#1e293b",n.style.marginBottom="24px",n.style.lineHeight="1.4";const o=document.createElement("ul");o.style.listStyle="none",o.style.padding="0",o.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile 😊","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(h=>{const p=document.createElement("li");p.style.display="flex",p.style.alignItems="flex-start",p.style.gap="12px",p.style.marginBottom="16px",p.style.fontSize="15px",p.style.lineHeight="1.6",p.style.color="#475569";const f=document.createElement("span");f.innerHTML="•",f.style.color="#8b5cf6",f.style.fontWeight="bold",f.style.fontSize="18px",f.style.lineHeight="1.2";const d=document.createElement("span");d.textContent=h,p.appendChild(f),p.appendChild(d),o.appendChild(p)});const a=document.createElement("p");a.innerHTML="Let's go 🚀",a.style.fontSize="16px",a.style.fontWeight="700",a.style.color="#1e293b",a.style.marginBottom="24px",a.style.marginTop="0";const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.gap="12px",c.style.marginBottom="24px",c.style.padding="16px",c.style.background="#f8fafc",c.style.borderRadius="8px",c.style.border="1px solid #e2e8f0";const l=document.createElement("input");l.type="checkbox",l.id="rulesCheckbox",l.style.width="18px",l.style.height="18px",l.style.cursor="pointer",l.style.accentColor="#8b5cf6";const r=document.createElement("label");r.htmlFor="rulesCheckbox",r.textContent="I have read and understood the rules above",r.style.fontSize="14px",r.style.fontWeight="500",r.style.color="#475569",r.style.cursor="pointer",r.style.flex="1",c.appendChild(l),c.appendChild(r);const i=document.createElement("button");i.textContent="I agree",i.id="agreeButton",i.style.background="#e2e8f0",i.style.color="#64748b",i.style.border="none",i.style.borderRadius="12px",i.style.padding="14px 24px",i.style.fontSize="16px",i.style.fontWeight="600",i.style.cursor="not-allowed",i.style.width="100%",i.style.transition="all 0.2s",i.disabled=!0,e.appendChild(n),e.appendChild(o),e.appendChild(a),e.appendChild(c),e.appendChild(i),t.appendChild(e),document.body.appendChild(t);const u=()=>{l.checked?(i.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",i.style.color="white",i.style.cursor="pointer",i.disabled=!1,i.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(i.style.background="#e2e8f0",i.style.color="#64748b",i.style.cursor="not-allowed",i.disabled=!0,i.style.boxShadow="none")};l.addEventListener("change",u),i.addEventListener("click",()=>{i.disabled||t.remove()}),t.addEventListener("click",h=>{h.target})}function Re(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",Ee();const t=document.createElement("div");t.className="top-bar",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="50px",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="15px",t.style.padding="0 18px",t.style.background="rgba(255,255,255,0.25)",t.style.backdropFilter="blur(12px)",t.style.zIndex="100",t.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",t.style.overflow="visible";const e=document.createElement("button");e.innerHTML="← Back to details",e.style.position="fixed",e.style.top="8px",e.style.left="18px",e.style.background="rgba(255,255,255,0.9)",e.style.border="1px solid rgba(0,0,0,0.1)",e.style.borderRadius="8px",e.style.padding="6px 12px",e.style.fontSize="13px",e.style.fontWeight="500",e.style.color="#374151",e.style.cursor="pointer",e.style.transition="all 0.2s",e.style.zIndex="200",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",e.onclick=()=>window.location.href="/agent-info.html",e.onmouseover=()=>{e.style.background="rgba(255,255,255,0.95)",e.style.transform="translateY(-1px)"},e.onmouseout=()=>{e.style.background="rgba(255,255,255,0.9)",e.style.transform="translateY(0)"};const n=localStorage.getItem("selectedAgentType")||"payment-followup",o={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},s=document.createElement("div");s.textContent=o[n]||"Sales Training",s.style.fontSize="18px",s.style.fontWeight="500",s.style.letterSpacing="0.5px",s.style.color="#23272f",s.style.opacity="0.92",s.style.whiteSpace="nowrap";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="8px",a.style.fontSize="1.1rem",a.style.color="#23272f",a.style.fontWeight="500",a.style.opacity="0.85",a.style.whiteSpace="nowrap";const c=document.createElement("span");c.id="timer",c.textContent="00:00";const l=document.createElement("span");l.id="recordingDot",l.textContent="•",l.style.fontSize="1.5em",l.style.color="#e11d48",l.style.opacity="0",l.style.transition="opacity 0.3s",a.appendChild(c),a.appendChild(l),t.appendChild(e),t.appendChild(s),t.appendChild(a),document.body.appendChild(t);const r=document.createElement("div");r.id="customerName",r.style.position="fixed",r.style.left="50%",r.style.top="50px",r.style.transform="translateX(-50%)",r.style.zIndex="10",r.style.color="#1e293b",r.style.fontSize="16px",r.style.fontWeight="600",r.style.textAlign="center",r.style.whiteSpace="nowrap",r.style.pointerEvents="none",r.style.background="rgba(255, 255, 255, 0.9)",r.style.padding="8px 16px",r.style.marginTop="36px",r.style.borderRadius="20px",r.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",r.style.border="1px solid rgba(226, 232, 240, 0.8)";const i=localStorage.getItem("selectedAgentName")||"Customer";r.textContent=`Customer Name: ${i}`,document.body.appendChild(r);const u=document.createElement("div");u.className="voice-wave-area",u.id="voiceWaveArea",u.style.position="fixed",u.style.top="50px",u.style.left="0",u.style.width="100vw",u.style.height="calc(100vh - 50px)",u.style.display="flex",u.style.flexDirection="column",u.style.justifyContent="center",u.style.alignItems="center",u.style.zIndex="1",u.style.background="transparent";const h=document.createElement("div");h.className="voice-wave-container",h.id="voiceWaveContainer",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.gap="4px",h.style.height="60px";for(let H=0;H<20;H++){const I=document.createElement("div");I.className="voice-wave-bar",I.style.width="3px",I.style.height="4px",I.style.background="rgba(37,99,235,0.3)",I.style.borderRadius="2px",I.style.transition="height 0.1s ease",h.appendChild(I)}u.appendChild(h),document.body.appendChild(u);const p=document.createElement("div");p.id="hiddenTranscript",p.style.display="none",document.body.appendChild(p);const f=document.createElement("div");f.className="mic-wrap",f.style.position="fixed",f.style.left="50%",f.style.bottom="48px",f.style.transform="translateX(-50%)",f.style.zIndex="20",f.style.display="flex",f.style.flexDirection="row",f.style.alignItems="center",f.style.gap="24px";const d=document.createElement("div");d.className="ocean-animation",d.style.position="absolute",d.style.left="50%",d.style.top="50%",d.style.transform="translate(-50%, -50%)",d.style.zIndex="-1",d.style.pointerEvents="none",d.style.width="160px",d.style.height="160px";const y=document.createElement("button");y.className="voice-btn mic-btn",y.id="micBtn",y.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>',y.style.minWidth="180px",y.style.height="50px",y.style.borderRadius="25px",y.style.background="#8b5cf6",y.style.color="#fff",y.style.border="none",y.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.padding="0 24px",y.style.cursor="pointer",y.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",y.style.position="relative",y.style.outline="none",y.style.visibility="visible",f.appendChild(y),f.appendChild(d),document.body.appendChild(f);const R=document.createElement("link");R.rel="stylesheet",R.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(R);const S=document.createElement("style");S.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(S);function U(H){if(d.innerHTML="",H)for(let I=0;I<2;I++){const D=document.createElement("div");D.className="wave"+(I===1?" wave2":""),D.style.width="0px",D.style.height="0px",D.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",D.style.position="absolute",D.style.left="50%",D.style.top="50%",D.style.transform="translate(-50%, -50%)",d.appendChild(D)}}window.showOceanAnimation=U}Ce()?Re():window.location.href="/login.html";let m=null,w=!1,x=!1,ae=null,V=0,_=[],T=!1,G=!1,g=null,ue=!1,L=[],B=!1,v=null,W=[],z=!1,J="",be=null,le=!1,N=!1,xe=!1,C=null,E=[],K=!1,re=null,ce=0,A=null,M=null;const b=document.getElementById("micBtn"),fe=document.getElementById("timer"),De=document.getElementById("voiceWaveContainer"),pe=document.getElementById("hiddenTranscript");let k="";function ie(t){const e=Math.floor(t/60).toString().padStart(2,"0"),n=(t%60).toString().padStart(2,"0");return`${e}:${n}`}function _e(){V=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),fe.textContent=ie(V),ae=window.setInterval(()=>{V++,fe.textContent=ie(V)},1e3)}function me(){ae&&(clearInterval(ae),ae=null)}function $(t,e){const n=ie(V);_.push({sender:t,text:e,time:n});const o=document.createElement("div");o.className="transcript-item "+(t==="AI"?"ai":"you"),o.innerHTML=`
        <div class="transcript-avatar">${t==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content">${e}</div>
        <div class="transcript-meta">${t}  ${n}</div>
    `,pe.appendChild(o)}function Be(){_=[],pe.innerHTML=""}function ve(){if(w||x||T)return;const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t){alert("Your browser does not support Web Speech API.");return}if(m=new t,m.lang="en-US",m.interimResults=!0,m.maxAlternatives=1,m.continuous=!0,"webkitSpeechRecognition"in window){m.continuous=!0,m.interimResults=!0,m.maxAlternatives=1;try{m.serviceURI="https://www.google.com/speech-api/v2/recognize"}catch{}}w=!0,x=!1;let e="";k="";let n=null,o=null;m.onresult=a=>{(N||ue||B)&&ze();let c="",l=!1;for(let r=a.resultIndex;r<a.results.length;r++){const i=a.results[r][0].transcript;a.results[r].isFinal?(e+=i,k+=i,l=!0):c+=i}if(c&&!l){n||(n=Te("You"));const r=(k+" "+c).trim();n.update(r),se(!0),o&&(clearTimeout(o),o=null)}l&&e.trim()&&(o=window.setTimeout(()=>{if(e.trim().length>0){const r=e.trim();if(e="",r.length>=3){typeof performance<"u"?performance.now():Date.now(),Oe(r),k="";const i=document.querySelector(".transcript-item.you .transcript-content");i&&(i.textContent="")}else k+=" "+r}o=null},700))},m.onerror=a=>{console.error("Speech recognition error:",a.error),a.error==="network"?(console.warn("Network error in speech recognition, attempting restart..."),setTimeout(()=>{w&&!T&&(m==null||m.start())},1e3)):a.error==="aborted"?(console.log("Speech recognition was aborted"),w=!1,x=!1,T=!1):a.error==="audio-capture"?(console.error("Audio capture error - microphone issue"),w=!1,x=!1,T=!1,alert("Microphone access error. Please check your microphone permissions and try again.")):a.error==="not-allowed"?(console.error("Speech recognition not allowed"),w=!1,x=!1,T=!1,alert("Speech recognition permission denied. Please allow microphone access and reload the page.")):(console.warn(`Speech recognition error: ${a.error}, attempting restart...`),T=!1,setTimeout(()=>{w&&!T&&O("error-recovery")},2e3))},m.onstart=()=>{T=!0},m.onend=()=>{if(T=!1,w&&!x&&!T&&w){const a=n?n.getText():"",c=e,l=k;setTimeout(()=>{w&&!T&&(c&&(e=c),l&&(k=l),O("natural-end"),a&&n&&setTimeout(()=>{n&&n.update(a)},150))},100)}},m.start(),m.startTime=Date.now();const s=setInterval(()=>{if(!w){clearInterval(s);return}const a=Date.now();if(m&&m.startTime&&a-m.startTime>2*60*1e3){m.startTime=a,O("mandatory-2min-restart");return}if(w&&!T&&!x&&!G){O("critical-restart");return}if(w&&!T&&a-((m==null?void 0:m.startTime)||0)>3e4){O("long-inactive-restart");return}if(w&&!Y&&!F){te().catch(c=>{console.error("Reconnection failed:",c),setTimeout(()=>{w&&te()},1e3)});return}},1e3)}function ze(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),v){try{v.stop(),v.disconnect()}catch{}v=null}L=[],q=[],ue=!1,B=!1,z=!1,W=[],N=!1}function Pe(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),v){try{v.stop(),v.disconnect()}catch{}v=null}L=[],ue=!1,B=!1,W=[],z=!1}function O(t="manual"){if(!(G||!w)){G=!0;try{m&&T&&m.stop(),setTimeout(()=>{if(w&&!T)try{m==null||m.start()}catch(e){console.error("Restart failed:",e),ve()}G=!1},100)}catch(e){console.error("Error in safe restart:",e),G=!1}}}function Me(){if(w=!1,x=!1,T=!1,G=!1,m)try{m.stop()}catch{}if(k.trim()||J.trim()){const e=[];k&&k.trim()&&e.push(k.trim()),J&&J.trim()&&e.push(J.trim());const n=document.querySelector(".transcript-item.you .transcript-content");if(n&&n.textContent&&n.textContent.trim()){const o=n.textContent.trim();o.length>0&&e.push(o)}}J="",k="";const t=document.querySelector(".transcript-item.you .transcript-content");t&&(t.textContent="")}async function Le(t){try{const e=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.json();await We(n.audio_data,"pcm_f32le",n.sample_rate)}catch(e){if(console.error("Cartesia TTS error:",e),window.speechSynthesis){const n=new SpeechSynthesisUtterance(t);n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}}}async function We(t,e="pcm_f32le",n=44100){const o=Uint8Array.from(atob(t),s=>s.charCodeAt(0));await Se(o.buffer,n)}async function Fe(t){try{const e=Ne(t),n=new FormData;n.append("file",e,"ai_response.wav"),n.append("model","whisper-1"),n.append("language","en");const o=await Ie(),s=await fetch("/api/db/transcribe_audio",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:n});if(s.ok){const a=await s.json(),c=a.text||a.transcript||"AI response transcribed";$("AI",c)}else{const a=await s.text();console.error("Audio transcription failed:",s.status,a);const c=_.filter(r=>r.sender==="You").pop();let l="[AI provided audio response]";if(c){const r=c.text.toLowerCase();r.includes("sales skill")||r.includes("practice")?l="I'd be happy to help you practice your sales skills! What specific area would you like to work on?":r.includes("close")||r.includes("deal")?l="Great! Let's work on your closing techniques. What type of deals are you looking to close?":r.includes("name")?l="I'm your AI sales training coach. I'm here to help you improve your sales skills!":l="I understand. Let me help you with that. Can you tell me more about what you'd like to work on?"}$("AI",l)}}catch(e){console.error("Error transcribing AI audio:",e),$("AI","[AI Response - Audio Only]")}}function Ne(t){const e=t.length,n=t.sampleRate,o=new ArrayBuffer(44+e*2),s=new DataView(o),a=(r,i)=>{for(let u=0;u<i.length;u++)s.setUint8(r+u,i.charCodeAt(u))};a(0,"RIFF"),s.setUint32(4,36+e*2,!0),a(8,"WAVE"),a(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,n,!0),s.setUint32(28,n*2,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),a(36,"data"),s.setUint32(40,e*2,!0);const c=t.getChannelData(0);let l=44;for(let r=0;r<e;r++){const i=Math.max(-1,Math.min(1,c[r]));s.setInt16(l,i<0?i*32768:i*32767,!0),l+=2}return new Blob([o],{type:"audio/wav"})}async function Se(t,e){if(g||(g=new(window.AudioContext||window.webkitAudioContext)),g.state==="suspended")try{await g.resume()}catch(n){console.error("Failed to resume audio context:",n);return}try{const n=g.createBuffer(1,t.byteLength/4,e),o=n.getChannelData(0),s=new Float32Array(t);o.set(s),v&&(v.stop(),v.disconnect()),v=g.createBufferSource(),v.buffer=n,v.connect(g.destination),A&&K&&v.connect(A),!le&&be!=null&&(le=!0),v.start()}catch(n){console.error("Error playing raw PCM audio:",n)}}function Oe(t){if(x||N)return;x=!0,N=!0,$("You",t);const e=Te("AI");let n="",o="";be=typeof performance<"u"?performance.now():Date.now(),le=!1,xe=!1;const s=setTimeout(()=>{x&&(x=!1,N=!1)},15e3);Ye(t,a=>{if(n+=a,e.update(n),o+=a,$e(o)){const c=ye(o);c.length>0&&(W.push(...c),o="",z||(typeof performance<"u"?performance.now():Date.now(),ge()))}}).then(()=>{if(o.trim()){const a=ye(o.trim());W.push(...a),z||(typeof performance<"u"?performance.now():Date.now(),ge())}n.trim()&&$("AI",n.trim()),n="",o="",x=!1,N=!1,clearTimeout(s),setTimeout(()=>{w&&!T&&!x&&O("after-ai-response")},500),Xe(),window.gc&&window.gc()}).catch(a=>{console.error("AI response error:",a.message),n="",o="",x=!1,N=!1,clearTimeout(s),setTimeout(()=>{w&&!T&&!x&&O("after-ai-error")},1e3),window.gc&&window.gc()})}function $e(t){return!!(/[.!?]\s*$/.test(t)||/, \s*$/.test(t)||t.length>150)}function ye(t){const e=t.trim();if(!e)return[];if(/[.!?]\s*$/.test(e))return[e];if(/, \s*$/.test(e))return[e];if(e.length>150){const n=e.match(/.*[.!?]\s*$/);if(n)return[n[0].trim()]}return[]}async function Ue(){if(!(L.length===0||B)){for(B=!0;L.length>0;){const t=L.shift();try{await Se(t,44100),v&&await new Promise(e=>{v.onended=()=>e()})}catch(e){console.error("Error playing audio from queue:",e)}}B=!1,setTimeout(()=>{He()},500)}}async function ge(){if(!z){for(z=!0;W.length>0;){const t=W.splice(0,2);for(let e=0;e<t.length;e++){const n=t[e];try{const o=await je(n);L.push(o),B||Ue()}catch(o){console.error("Cartesia TTS error:",o);try{await Le(n)}catch(s){console.error("Fallback TTS error:",s)}}}}z=!1}}function He(){!z&&L.length}async function je(t){return new Promise((e,n)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})}).then(o=>{var i;if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const s=(i=o.body)==null?void 0:i.getReader(),a=new TextDecoder("utf-8");let c="",l=[];async function r(){try{const{done:u,value:h}=await s.read();if(u){if(l.length>0){const f=new Uint8Array(l.reduce((y,R)=>y+R.length,0));let d=0;for(const y of l)f.set(y,d),d+=y.length;l=[],window.gc&&window.gc(),e(f.buffer)}else n(new Error("No audio data received"));return}c+=a.decode(h,{stream:!0});let p=c.split(/\r?\n/);c=p.pop()||"";for(const f of p)if(f.startsWith("data: "))try{const d=JSON.parse(f.slice(6));if(d.audio_chunk){const y=Uint8Array.from(atob(d.audio_chunk),R=>R.charCodeAt(0));l.push(y)}else d.status==="complete"||d.error&&n(new Error(d.error))}catch{}r()}catch(u){n(u)}}r()}).catch(n)})}function Te(t){const e=ie(V),n=document.createElement("div");n.className="transcript-item "+(t==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${t==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${t}  ${e}</div>
    `;const o=n.querySelector(".transcript-content");return pe.appendChild(n),{update:s=>{o.textContent=s},remove:()=>{o.textContent=""},getText:()=>o.textContent||""}}let X=null,Y=!1,F=!1,j=null,q=[],he=24e3,ne="",P=0,Q="";async function Je(){const t=localStorage.getItem("selectedAgentType")||"discovery-call";try{const e=await fetch(`/api/get_agent_prompt?agent_type=${t}`);if(e.ok){const n=await e.json();n.success&&n.prompt?Q=n.prompt:(console.error("Invalid response format:",n),Q="You are a helpful sales training coach. Speak naturally and concisely.")}else{const n=await e.text();console.error("Failed to fetch agent prompt:",e.status,n),Q="You are a helpful sales training coach. Speak naturally and concisely."}}catch(e){console.error("Error fetching agent prompt:",e),Q="You are a helpful sales training coach. Speak naturally and concisely."}}async function te(t){return new Promise(async(e,n)=>{if(Y&&X){j=t||null,e();return}if(F){const s=setInterval(()=>{Y&&(clearInterval(s),j=t||null,e())},100);return}let o;try{const s=await fetch("/api/openai-realtime-token",{method:"GET"});if(!s.ok)throw new Error("Failed to get OpenAI token");const c=(await s.json()).token,r=`wss://api.openai.com/v1/realtime?model=${encodeURIComponent("gpt-4o-realtime-preview-2024-12-17")}`;F=!0,j=t||null;const i=["realtime",`openai-insecure-api-key.${c}`];o=new WebSocket(r,i),X=o}catch(s){n(new Error("Failed to establish connection: "+s.message));return}o.onopen=()=>{Y=!0,F=!1;const a={type:"session.update",session:{type:"realtime",model:"gpt-4o-realtime-preview",instructions:Q||"You are a helpful sales training coach.",voice:"alloy",tools:[],tool_choice:"none"}};o.send(JSON.stringify(a)),setTimeout(()=>{const c={type:"response.create",response:{instructions:"Start the conversation by saying: 'Hey, who's this?'"}};o.send(JSON.stringify(c))},500),e()},o.onerror=s=>{F=!1,console.error("Realtime WebSocket error:",s),n(new Error("Realtime WebSocket error"))},o.onclose=s=>{Y=!1,F=!1,X=null,j=null,q=[],w&&setTimeout(()=>{w&&!Y&&!F&&te()},2e3)},o.onmessage=async s=>{try{const a=JSON.parse(s.data),c=a.type;if(c==="response.output_text.delta"){const l=a.delta;if(l&&l.includes("tool_uses"))return;a.delta&&(ne+=a.delta),j&&a.delta&&j(a.delta)}else if(c!=="response.output_text.done")if(c==="response.output_audio.delta"){xe=!0;const l=a.delta;if(l){const r=atob(l),i=new Int16Array(r.length/2);for(let d=0;d<r.length;d+=2)i[d/2]=r.charCodeAt(d)|r.charCodeAt(d+1)<<8;q.push(i);const u=new Float32Array(i.length);for(let d=0;d<i.length;d++)u[d]=Math.max(-1,Math.min(1,i[d]/32768));g||(g=new(window.AudioContext||window.webkitAudioContext)),g.state==="suspended"&&await g.resume();const h=g.createBuffer(1,u.length,he);h.copyToChannel(u,0);const p=g.createBufferSource();p.buffer=h,p.connect(g.destination),A&&K&&p.connect(A);const f=h.duration;(P===0||P<g.currentTime)&&(P=g.currentTime),p.start(P),P+=f,v=p}}else if(c==="response.output_audio.done"){const l=q.reduce((p,f)=>p+f.length,0),r=new Int16Array(l);let i=0;for(const p of q)r.set(p,i),i+=p.length;const u=new Float32Array(r.length);for(let p=0;p<r.length;p++)u[p]=Math.max(-1,Math.min(1,r[p]/32768));g||(g=new(window.AudioContext||window.webkitAudioContext));const h=g.createBuffer(1,u.length,he);h.copyToChannel(u,0),window.lastAIAudioBuffer=h,window.lastAIAudioTime=Date.now(),q=[],P=0}else if(c==="response.created")ne="",P=0;else if(c==="response.done"){let l=ne.trim();l.includes("tool_uses")&&(l=l.replace(/\{"tool_uses":\[.*?\]\}/g,"").trim()),l?$("AI",l):window.lastAIAudioBuffer?Fe(window.lastAIAudioBuffer):$("AI","[AI provided audio response]"),ne=""}else c==="session.updated"||c==="error"&&(console.error("Realtime error:",a),console.error("Error details:",JSON.stringify(a.error,null,2)))}catch{}}})}async function Ye(t,e){if(await te(e),!X)return;const n={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:t}]}};X.send(JSON.stringify(n));const o={type:"response.create"};X.send(JSON.stringify(o))}function qe(t){const e=document.getElementById("recordingDot");e&&e.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(t)}function se(t){De.querySelectorAll(".voice-wave-bar").forEach(n=>{t?n.classList.add("active"):n.classList.remove("active")})}async function Ve(){try{const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});re=t,g||(g=new(window.AudioContext||window.webkitAudioContext)),A=g.createMediaStreamDestination(),M=g.createMediaStreamSource(t),M.connect(A);let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="audio/webm"),MediaRecorder.isTypeSupported(e)||(e="audio/mp4"),MediaRecorder.isTypeSupported(e)||(e="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(e)||(e="audio/wav"),C=new MediaRecorder(A.stream,{mimeType:e}),E=[],K=!0,ce=Date.now(),C.ondataavailable=n=>{n.data.size>0&&E.push(n.data)},C.onstop=()=>{if(E.length>0){const n=new Blob(E,{type:e}),o=new FileReader;o.onload=()=>{const s=o.result;window.conversationRecordingData=s,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const a=(Date.now()-ce)/1e3;sessionStorage.setItem("recordingDuration",a.toString())},o.readAsDataURL(n)}M&&(M.disconnect(),M=null),A&&(A.disconnect(),A=null),t&&t.getTracks().forEach(n=>n.stop())},C.start(1e3)}catch(t){console.error("Error starting audio recording:",t),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function Ge(){return new Promise((t,e)=>{if(!C||!K){t();return}K=!1;const n=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),oe(),e(new Error("Audio recording stop timeout"))},1e4);C.onstop=()=>{if(clearTimeout(n),E.length>0){const o=new Blob(E,{type:(C==null?void 0:C.mimeType)||"audio/webm"}),s=new FileReader;s.onload=()=>{const a=s.result;window.conversationRecordingData=a,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const c=(Date.now()-ce)/1e3;sessionStorage.setItem("recordingDuration",c.toString()),oe(),t()},s.readAsDataURL(o)}else oe(),t()};try{C.stop()}catch(o){clearTimeout(n),console.error("Error stopping media recorder:",o),oe(),e(o)}})}function oe(){M&&(M.disconnect(),M=null),A&&(A.disconnect(),A=null),re&&(re.getTracks().forEach(t=>t.stop()),re=null),C=null,E=[]}async function Qe(){try{b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">save</span><span style="font-size:15px;font-weight:600;">Saving...</span>',b.style.background="rgba(34,197,94,0.95)",await new Promise(S=>setTimeout(S,100));const t=sessionStorage.getItem("hasRecording"),e=window.conversationRecordingData,n=sessionStorage.getItem("recordingDuration"),o=sessionStorage.getItem("recordingTimestamp");if(!t||t!=="true"||!e){await new Promise(H=>setTimeout(H,500));const S=sessionStorage.getItem("hasRecording"),U=window.conversationRecordingData;(!S||S!=="true"||!U)&&console.error("Still no audio recording after retry")}sessionStorage.setItem("chatTranscript",JSON.stringify(_));const s=localStorage.getItem("selectedAgentId"),a=localStorage.getItem("selectedAgentType"),c=localStorage.getItem("selectedAgentTitle"),l=et(),r=l.length/1024/1024;let i=null,u=l;if(r>5)try{const S=await we("/api/db/upload_audio",{method:"POST",body:JSON.stringify({audio_data:l,filename:`conversation_${Date.now()}.webm`})});S.ok?(i=(await S.json()).audio_url,u=btoa(`stored_in_supabase_storage:${i}`)):u=btoa(`upload_failed_${r.toFixed(2)}MB`)}catch(S){console.error("Audio upload error:",S),u=btoa(`upload_error_${r.toFixed(2)}MB`)}const h={title:`${c}`,agent_id:s,duration_seconds:de(),total_exchanges:_.length,full_conversation:Ze(),transcript:_,audio_data:u,audio_url:i,audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:tt(),user_agent:navigator.userAgent,ip_address:await nt(),status:"completed",tags:["sales_call","training",a||"general"],notes:`Sales training conversation using ${c||"general"} agent `},p=new Promise((S,U)=>setTimeout(()=>U(new Error("Database save timeout after 30 seconds")),3e4)),f=we("/api/db/save_conversation",{method:"POST",body:JSON.stringify(h)}),d=await Promise.race([f,p]);if(!d.ok){const S=await d.text();throw console.error("Conversation save error:",S),new Error(`Failed to save conversation: ${d.status} - ${S}`)}const y=await d.json();if(!y.success)throw new Error(`Failed to save conversation: ${y.error}`);const R=y.conversation_id;sessionStorage.setItem("conversationId",R),await new Promise(S=>setTimeout(S,500)),b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">check_circle</span><span style="font-size:15px;font-weight:600;">Success!</span>',b.style.background="rgba(34,197,94,0.95)",window.location.href="/success.html"}catch(t){console.error("Error saving conversation:",t);const e=t.message.toLowerCase();if(e.includes("timeout")||e.includes("too large")){alert("Conversation was too long for database storage. The transcript has been saved locally, but audio recording was not saved due to size limits.");const n={timestamp:new Date().toISOString(),duration:de(),transcript:_,agent_type:localStorage.getItem("selectedAgentType")};localStorage.setItem("lastConversationBackup",JSON.stringify(n)),window.location.href="/success.html"}else alert("Failed to save conversation. Please try again."),b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',b.style.background="rgba(229,39,76,0.92)",b.disabled=!1,b.style.cursor="pointer",ee=!0}}function ke(){W=[],k="",J="",E=[],window.gc&&window.gc()}function Xe(){const t=window.conversationRecordingData?window.conversationRecordingData.length:0,e=W.join("").length;t+e>10*1024*1024&&ke()}function Ke(){["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(e=>{sessionStorage.getItem(e)&&sessionStorage.removeItem(e)}),E.length>0&&(E=[]),window.conversationRecordingData=null,ke()}function de(){const t=sessionStorage.getItem("callStartTime");if(!t)return 0;const e=new Date(t).getTime(),n=new Date().getTime();return Math.floor((n-e)/1e3)}function Ze(){return _.map((t,e)=>({user:t.sender==="You"?t.text:"",assistant:t.sender==="AI"?t.text:"",timestamp:new Date().toISOString()}))}function et(){const t=window.conversationRecordingData,e=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("recordingDuration"),o=sessionStorage.getItem("recordingTimestamp");if(t&&e==="true"&&n&&o&&t.length>1e3&&!t.includes("audio_data_placeholder")){const s=parseInt(o);if(Date.now()-s<2*60*60*1e3)return t}return btoa("audio_data_placeholder")}function tt(){const t=sessionStorage.getItem("recordingDuration"),e=sessionStorage.getItem("hasRecording"),n=window.conversationRecordingData;if(t&&e==="true"&&n){const s=parseFloat(t);if(s>0&&s<7200)return s}return de()}async function nt(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(t){return console.error("Error getting client IP:",t),"127.0.0.1"}}async function Ae(){const t=localStorage.getItem("refreshToken");if(!t)return console.error("No refresh token found"),null;try{const e=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(e.ok){const n=await e.json();return localStorage.setItem("accessToken",n.access_token),localStorage.setItem("refreshToken",n.refresh_token),localStorage.setItem("tokenExpiresAt",n.expires_at),n.access_token}else return console.error("Failed to refresh token"),null}catch(e){return console.error("Error refreshing token:",e),null}}function ot(){const t=localStorage.getItem("tokenExpiresAt");if(!t)return!0;const e=new Date(t).getTime();return new Date().getTime()>=e-5*60*1e3}async function Ie(){if(ot()){const e=await Ae();return e||(console.error("Failed to refresh token"),localStorage.clear(),window.location.href="/login.html","")}const t=localStorage.getItem("accessToken");return t||(console.error("No access token found"),window.location.href="/login.html","")}async function we(t,e={}){const n=await Ie(),o=await fetch(t,{...e,headers:{...e.headers,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(o.status===401){const s=await Ae();if(s)return fetch(t,{...e,headers:{...e.headers,Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return o}let ee=!1;b.onclick=async()=>{if(ee){b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">hourglass_empty</span><span style="font-size:15px;font-weight:600;">Processing...</span>',b.style.background="rgba(107,114,128,0.95)",b.disabled=!0,b.style.cursor="not-allowed",Pe(),Me(),me(),se(!1);try{K&&await Ge(),_.length>0?await Qe():window.location.href="/success.html"}catch(t){console.error("Error during disconnect process:",t),b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',b.style.background="rgba(229,39,76,0.92)",b.disabled=!1,b.style.cursor="pointer",ee=!0,alert("Error disconnecting. Please try again.")}}else{await Ke(),Q||await Je(),Be(),_e(),se(!0);try{await te()}catch{alert("Failed to establish realtime connection. Please check your network connection and try again."),se(!1),me();return}Ve(),ve(),b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',b.style.background="rgba(229,39,76,0.92)",ee=!0}};b.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>';b.style.background="#8b5cf6";ee=!1;qe(!1);let Z=0;setInterval(()=>{!z&&L.length===0&&!B&&(x||(Z=0)),x&&(Z===0?Z=Date.now():Date.now()-Z>12e4&&(console.error("isProcessing stuck for 2+ minutes"),x=!1,Z=0))},3e3);document.addEventListener("click",async()=>{if(g&&g.state==="suspended")try{await g.resume()}catch(t){console.error("Failed to resume AudioContext:",t)}},{once:!0});
