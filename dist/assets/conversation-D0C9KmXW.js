import"./modulepreload-polyfill-B5Qt9EMX.js";function le(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function de(){const e=document.createElement("div");e.id="rulesOverlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.backgroundColor="rgba(0, 0, 0, 0.7)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10000",e.style.pointerEvents="auto";const t=document.createElement("div");t.style.background="#ffffff",t.style.borderRadius="16px",t.style.padding="32px",t.style.maxWidth="500px",t.style.width="90%",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.border="1px solid #e2e8f0",t.style.position="relative";const n=document.createElement("h2");n.innerHTML="Hey 👋 Please take a look at the rules for role-play done right.",n.style.fontSize="20px",n.style.fontWeight="700",n.style.color="#1e293b",n.style.marginBottom="24px",n.style.lineHeight="1.4";const o=document.createElement("ul");o.style.listStyle="none",o.style.padding="0",o.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile 😊","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(h=>{const f=document.createElement("li");f.style.display="flex",f.style.alignItems="flex-start",f.style.gap="12px",f.style.marginBottom="16px",f.style.fontSize="15px",f.style.lineHeight="1.6",f.style.color="#475569";const a=document.createElement("span");a.innerHTML="•",a.style.color="#8b5cf6",a.style.fontWeight="bold",a.style.fontSize="18px",a.style.lineHeight="1.2";const p=document.createElement("span");p.textContent=h,f.appendChild(a),f.appendChild(p),o.appendChild(f)});const i=document.createElement("p");i.innerHTML="Let's go 🚀",i.style.fontSize="16px",i.style.fontWeight="700",i.style.color="#1e293b",i.style.marginBottom="24px",i.style.marginTop="0";const c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.gap="12px",c.style.marginBottom="24px",c.style.padding="16px",c.style.background="#f8fafc",c.style.borderRadius="8px",c.style.border="1px solid #e2e8f0";const l=document.createElement("input");l.type="checkbox",l.id="rulesCheckbox",l.style.width="18px",l.style.height="18px",l.style.cursor="pointer",l.style.accentColor="#8b5cf6";const r=document.createElement("label");r.htmlFor="rulesCheckbox",r.textContent="I have read and understood the rules above",r.style.fontSize="14px",r.style.fontWeight="500",r.style.color="#475569",r.style.cursor="pointer",r.style.flex="1",c.appendChild(l),c.appendChild(r);const d=document.createElement("button");d.textContent="I agree",d.id="agreeButton",d.style.background="#e2e8f0",d.style.color="#64748b",d.style.border="none",d.style.borderRadius="12px",d.style.padding="14px 24px",d.style.fontSize="16px",d.style.fontWeight="600",d.style.cursor="not-allowed",d.style.width="100%",d.style.transition="all 0.2s",d.disabled=!0,t.appendChild(n),t.appendChild(o),t.appendChild(i),t.appendChild(c),t.appendChild(d),e.appendChild(t),document.body.appendChild(e);const y=()=>{l.checked?(d.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",d.style.color="white",d.style.cursor="pointer",d.disabled=!1,d.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(d.style.background="#e2e8f0",d.style.color="#64748b",d.style.cursor="not-allowed",d.disabled=!0,d.style.boxShadow="none")};l.addEventListener("change",y),d.addEventListener("click",()=>{d.disabled||e.remove()}),e.addEventListener("click",h=>{h.target})}function ue(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",de();const e=document.createElement("div");e.className="top-bar",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="50px",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="15px",e.style.padding="0 18px",e.style.background="rgba(255,255,255,0.25)",e.style.backdropFilter="blur(12px)",e.style.zIndex="100",e.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",e.style.overflow="visible";const t=document.createElement("button");t.innerHTML="← Back to details",t.style.position="fixed",t.style.top="8px",t.style.left="18px",t.style.background="rgba(255,255,255,0.9)",t.style.border="1px solid rgba(0,0,0,0.1)",t.style.borderRadius="8px",t.style.padding="6px 12px",t.style.fontSize="13px",t.style.fontWeight="500",t.style.color="#374151",t.style.cursor="pointer",t.style.transition="all 0.2s",t.style.zIndex="200",t.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",t.onclick=()=>window.location.href="/agent-info.html",t.onmouseover=()=>{t.style.background="rgba(255,255,255,0.95)",t.style.transform="translateY(-1px)"},t.onmouseout=()=>{t.style.background="rgba(255,255,255,0.9)",t.style.transform="translateY(0)"};const n=localStorage.getItem("selectedAgentType")||"payment-followup",o={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},s=document.createElement("div");s.textContent=o[n]||"Sales Training",s.style.fontSize="18px",s.style.fontWeight="500",s.style.letterSpacing="0.5px",s.style.color="#23272f",s.style.opacity="0.92",s.style.whiteSpace="nowrap";const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="8px",i.style.fontSize="1.1rem",i.style.color="#23272f",i.style.fontWeight="500",i.style.opacity="0.85",i.style.whiteSpace="nowrap";const c=document.createElement("span");c.id="timer",c.textContent="00:00";const l=document.createElement("span");l.id="recordingDot",l.textContent="•",l.style.fontSize="1.5em",l.style.color="#e11d48",l.style.opacity="0",l.style.transition="opacity 0.3s",i.appendChild(c),i.appendChild(l),e.appendChild(t),e.appendChild(s),e.appendChild(i),document.body.appendChild(e);const r=document.createElement("div");r.id="customerName",r.style.position="fixed",r.style.left="50%",r.style.top="50px",r.style.transform="translateX(-50%)",r.style.zIndex="10",r.style.color="#1e293b",r.style.fontSize="16px",r.style.fontWeight="600",r.style.textAlign="center",r.style.whiteSpace="nowrap",r.style.pointerEvents="none",r.style.background="rgba(255, 255, 255, 0.9)",r.style.padding="8px 16px",r.style.marginTop="36px",r.style.borderRadius="20px",r.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",r.style.border="1px solid rgba(226, 232, 240, 0.8)";const d=localStorage.getItem("selectedAgentName")||"Customer";r.textContent=`Customer Name: ${d}`,document.body.appendChild(r);const y=document.createElement("div");y.className="voice-wave-area",y.id="voiceWaveArea",y.style.position="fixed",y.style.top="50px",y.style.left="0",y.style.width="100vw",y.style.height="calc(100vh - 50px)",y.style.display="flex",y.style.flexDirection="column",y.style.justifyContent="center",y.style.alignItems="center",y.style.zIndex="1",y.style.background="transparent";const h=document.createElement("div");h.className="voice-wave-container",h.id="voiceWaveContainer",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.gap="4px",h.style.height="60px";for(let O=0;O<20;O++){const v=document.createElement("div");v.className="voice-wave-bar",v.style.width="3px",v.style.height="4px",v.style.background="rgba(37,99,235,0.3)",v.style.borderRadius="2px",v.style.transition="height 0.1s ease",h.appendChild(v)}y.appendChild(h),document.body.appendChild(y);const f=document.createElement("div");f.id="hiddenTranscript",f.style.display="none",document.body.appendChild(f);const a=document.createElement("div");a.className="mic-wrap",a.style.position="fixed",a.style.left="50%",a.style.bottom="48px",a.style.transform="translateX(-50%)",a.style.zIndex="20",a.style.display="flex",a.style.flexDirection="row",a.style.alignItems="center",a.style.gap="24px";const p=document.createElement("div");p.className="ocean-animation",p.style.position="absolute",p.style.left="50%",p.style.top="50%",p.style.transform="translate(-50%, -50%)",p.style.zIndex="-1",p.style.pointerEvents="none",p.style.width="160px",p.style.height="160px";const u=document.createElement("button");u.className="voice-btn mic-btn",u.id="micBtn",u.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;">mic</span>',u.style.width="50px",u.style.height="50px",u.style.borderRadius="50%",u.style.background="rgba(37,99,235,0.95)",u.style.color="#fff",u.style.border="none",u.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.fontWeight="700",u.style.fontSize="1.3rem",u.style.cursor="pointer",u.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",u.style.position="relative",u.style.outline="none",u.style.visibility="visible";const m=document.createElement("div");m.id="buttonText",m.textContent="Start Recording",m.style.position="absolute",m.style.top="-40px",m.style.left="50%",m.style.transform="translateX(-50%)",m.style.color="#1e293b",m.style.fontSize="14px",m.style.fontWeight="600",m.style.whiteSpace="nowrap",m.style.pointerEvents="none",m.style.transition="color 0.2s",a.appendChild(m),a.appendChild(u),a.appendChild(p),document.body.appendChild(a);const q=document.createElement("link");q.rel="stylesheet",q.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(q);const X=document.createElement("style");X.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(X);function ce(O){if(p.innerHTML="",O)for(let v=0;v<2;v++){const k=document.createElement("div");k.className="wave"+(v===1?" wave2":""),k.style.width="0px",k.style.height="0px",k.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",k.style.position="absolute",k.style.left="50%",k.style.top="50%",k.style.transform="translate(-50%, -50%)",p.appendChild(k)}}window.showOceanAnimation=ce}le()?ue():window.location.href="/login.html";let g=null,_=!1,C=!1,$=null,z=0,L=[],P=!1,x=null,R=[],D=!1,w=null,W=[],B=!1,N="",S=null,A=[],M=!1,F=null,J=0,T=null,E=null;const b=document.getElementById("micBtn"),G=document.getElementById("timer"),pe=document.getElementById("voiceWaveContainer"),Q=document.getElementById("hiddenTranscript");let I="";function U(e){const t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");return`${t}:${n}`}function ye(){z=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),G.textContent=U(z),$=window.setInterval(()=>{z++,G.textContent=U(z)},1e3)}function fe(){$&&(clearInterval($),$=null)}function Y(e,t){const n=U(z);L.push({sender:e,text:t,time:n});const o=document.createElement("div");o.className="transcript-item "+(e==="AI"?"ai":"you"),o.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content">${t}</div>
        <div class="transcript-meta">${e}  ${n}</div>
    `,Q.appendChild(o)}function me(){L=[],Q.innerHTML=""}function ge(){if(_||C||P)return;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){alert("Your browser does not support Web Speech API.");return}g=new e,g.lang="en-US",g.interimResults=!0,g.maxAlternatives=1,g.continuous=!0,"webkitSpeechRecognition"in window&&(g.continuous=!0,g.interimResults=!0,g.maxAlternatives=1),_=!0,C=!1;let t="";I="";let n=null,o=null;g.onresult=s=>{he();let i="",c=!1;for(let l=s.resultIndex;l<s.results.length;l++){const r=s.results[l][0].transcript;s.results[l].isFinal?(t+=r,I+=r,c=!0):i+=r}if(i&&!c){n||(n=se("You"));const l=(I+" "+i).trim();n.update(l),V(!0),o&&(clearTimeout(o),o=null)}c&&t.trim()&&(o=window.setTimeout(()=>{if(t.trim().length>0){const l=t.trim();if(t="",l.length>0){oe(l),I="";const r=document.querySelector(".transcript-item.you .transcript-content");r&&(r.textContent="")}}o=null},300))},g.onerror=s=>{_=!1,C=!1,P=!1,g==null||g.stop(),alert("Speech recognition error: "+s.error)},g.onstart=()=>{P=!0},g.onend=()=>{if(P=!1,_&&!C&&!P&&_){const s=n?n.getText():"",i=t,c=I;setTimeout(()=>{_&&!P&&(g==null||g.start(),s&&n&&setTimeout(()=>{n&&n.update(s)},50),i&&(t=i),c&&(I=c))},50)}},g.start()}function he(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),w){try{w.stop(),w.disconnect()}catch{}w=null}R=[],D=!1}function we(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),w){try{w.stop(),w.disconnect()}catch{}w=null}R=[],D=!1,W=[],B=!1}function be(){if(_=!1,C=!1,P=!1,g)try{g.stop()}catch{}let e="";if(I.trim()||N.trim()){const n=[];I&&I.trim()&&n.push(I.trim()),N&&N.trim()&&n.push(N.trim());const o=document.querySelector(".transcript-item.you .transcript-content");if(o&&o.textContent&&o.textContent.trim()){const s=o.textContent.trim();s.length>0&&n.push(s)}n.length>0&&(e=n.filter((i,c)=>n.indexOf(i)===c).join(" ").replace(/\s+/g," ").trim(),e.length>0&&oe(e))}N="",I="";const t=document.querySelector(".transcript-item.you .transcript-content");t&&(t.textContent="")}async function te(e){try{const t=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const n=await t.json();await xe(n.audio_data,"pcm_f32le",n.sample_rate)}catch(t){if(console.error("Cartesia TTS error:",t),window.speechSynthesis){const n=new SpeechSynthesisUtterance(e);n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}}}async function xe(e,t="pcm_f32le",n=44100){const o=Uint8Array.from(atob(e),s=>s.charCodeAt(0));await ne(o.buffer,n)}async function ne(e,t){if(x||(x=new(window.AudioContext||window.webkitAudioContext)),x.state==="suspended")try{await x.resume()}catch(n){console.error("Failed to resume audio context:",n);return}try{const n=x.createBuffer(1,e.byteLength/4,t),o=n.getChannelData(0),s=new Float32Array(e);o.set(s),w&&(w.stop(),w.disconnect()),w=x.createBufferSource(),w.buffer=n,w.connect(x.destination),T&&M&&w.connect(T),w.start()}catch(n){console.error("Error playing raw PCM audio:",n)}}function oe(e){if(C)return;C=!0,Y("You",e);const t=se("AI");let n="",o="";ke(e,s=>{if(n+=s,t.update(n),o+=s,ve(o)){const i=K(o);i.length>0&&(W.push(...i),o="",B||Z())}}).then(()=>{if(o.trim()){const s=K(o.trim());W.push(...s),B||Z()}n.trim()&&Y("AI",n.trim()),C=!1}).catch(s=>{t.update("Error: "+s.message),C=!1})}function ve(e){return!!(/[.!?]\s*$/.test(e)||/, \s*$/.test(e)||e.length>150)}function K(e){const t=e.trim();if(!t)return[];if(/[.!?]\s*$/.test(t))return[t];if(/, \s*$/.test(t))return[t];if(t.length>150){const n=t.match(/.*[.!?]\s*$/);if(n)return[n[0].trim()]}return[]}async function Se(){if(!(R.length===0||D)){for(D=!0;R.length>0;){const e=R.shift();try{await ne(e,44100),w&&await new Promise(t=>{w.onended=()=>t()})}catch(t){console.error("Error playing audio from queue:",t)}}D=!1,setTimeout(()=>{Te()},500)}}async function Z(){if(!B){for(B=!0;W.length>0;){const e=W.splice(0,2);for(let t=0;t<e.length;t++){const n=e[t];try{const o=await Ie(n);R.push(o),D||Se()}catch(o){console.error("Cartesia TTS error:",o);try{await te(n)}catch(s){console.error("Fallback TTS error:",s)}}}}B=!1}}function Te(){!B&&R.length}async function Ie(e){return new Promise((t,n)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}).then(o=>{var d;if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const s=(d=o.body)==null?void 0:d.getReader(),i=new TextDecoder("utf-8");let c="",l=[];async function r(){try{const{done:y,value:h}=await s.read();if(y){if(l.length>0){const a=new Uint8Array(l.reduce((u,m)=>u+m.length,0));let p=0;for(const u of l)a.set(u,p),p+=u.length;t(a.buffer)}else n(new Error("No audio data received"));return}c+=i.decode(h,{stream:!0});let f=c.split(/\r?\n/);c=f.pop()||"";for(const a of f)if(a.startsWith("data: "))try{const p=JSON.parse(a.slice(6));if(p.audio_chunk){const u=Uint8Array.from(atob(p.audio_chunk),m=>m.charCodeAt(0));l.push(u)}else p.status==="complete"||p.error&&n(new Error(p.error))}catch{}r()}catch(y){n(y)}}r()}).catch(n)})}function se(e){const t=U(z),n=document.createElement("div");n.className="transcript-item "+(e==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${e==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${e}  ${t}</div>
    `;const o=n.querySelector(".transcript-content");return Q.appendChild(n),{update:s=>{o.textContent=s},remove:()=>{o.textContent=""},getText:()=>o.textContent||""}}function ke(e,t){return new Promise((n,o)=>{const s=new AbortController,i=localStorage.getItem("selectedAgentType")||"discovery-call",c=localStorage.getItem("currentSessionId")||re();localStorage.setItem("currentSessionId",c),fetch("/chat_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,agent_type:i,session_id:c}),signal:s.signal}).then(l=>{if(!l.body)throw new Error("No response body");const r=l.body.getReader(),d=new TextDecoder("utf-8");let y="";function h(){r.read().then(({done:f,value:a})=>{if(f){n();return}y+=d.decode(a,{stream:!0});let p=y.split(/\r?\n/);y=p.pop()||"";for(const u of p)if(u.startsWith("data: "))try{const m=JSON.parse(u.slice(6));m.reply&&t(m.reply)}catch{}h()}).catch(o)}h()}).catch(o)})}function Ce(e){const t=document.getElementById("recordingDot");t&&t.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(e)}function V(e){pe.querySelectorAll(".voice-wave-bar").forEach(n=>{e?n.classList.add("active"):n.classList.remove("active")})}async function Ae(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});F=e,x||(x=new(window.AudioContext||window.webkitAudioContext)),T=x.createMediaStreamDestination(),E=x.createMediaStreamSource(e),E.connect(T);let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="audio/webm"),MediaRecorder.isTypeSupported(t)||(t="audio/mp4"),MediaRecorder.isTypeSupported(t)||(t="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(t)||(t="audio/wav"),S=new MediaRecorder(T.stream,{mimeType:t}),A=[],M=!0,J=Date.now();const n=document.getElementById("buttonText");n&&(n.textContent="Stop Recording",n.style.color="#ef4444"),S.ondataavailable=o=>{o.data.size>0&&A.push(o.data)},S.onstop=()=>{if(A.length>0){const o=new Blob(A,{type:t}),s=new FileReader;s.onload=()=>{const i=s.result;sessionStorage.setItem("conversationRecording",i),sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const c=(Date.now()-J)/1e3;sessionStorage.setItem("recordingDuration",c.toString())},s.readAsDataURL(o)}E&&(E.disconnect(),E=null),T&&(T.disconnect(),T=null),e&&e.getTracks().forEach(o=>o.stop())},S.start(1e3)}catch(e){console.error("Error starting audio recording:",e),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function Ee(){return new Promise((e,t)=>{if(!S||!M){e();return}M=!1;const n=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),H(),t(new Error("Audio recording stop timeout"))},1e4);S.onstop=()=>{if(clearTimeout(n),A.length>0){const o=new Blob(A,{type:(S==null?void 0:S.mimeType)||"audio/webm"}),s=new FileReader;s.onload=()=>{const i=s.result;sessionStorage.setItem("conversationRecording",i),sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const c=(Date.now()-J)/1e3;sessionStorage.setItem("recordingDuration",c.toString()),H(),e()},s.readAsDataURL(o)}else H(),e()};try{S.stop()}catch(o){clearTimeout(n),console.error("Error stopping media recorder:",o),H(),t(o)}})}function H(){E&&(E.disconnect(),E=null),T&&(T.disconnect(),T=null),F&&(F.getTracks().forEach(t=>t.stop()),F=null),S=null,A=[];const e=document.getElementById("buttonText");e&&(e.textContent="Start Recording",e.style.color="#1e293b")}async function Re(){try{b.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">save</span>',b.style.background="rgba(34,197,94,0.95)";const e=document.getElementById("buttonText");e&&(e.textContent="Saving...",e.style.color="#059669"),await new Promise(a=>setTimeout(a,100));const t=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("conversationRecording"),o=sessionStorage.getItem("recordingDuration"),s=sessionStorage.getItem("recordingTimestamp");if(!t||t!=="true"||!n){await new Promise(u=>setTimeout(u,500));const a=sessionStorage.getItem("hasRecording"),p=sessionStorage.getItem("conversationRecording");(!a||a!=="true"||!p)&&console.error("❌ Still no audio recording after retry - proceeding with placeholder")}sessionStorage.setItem("chatTranscript",JSON.stringify(L));const i=localStorage.getItem("selectedAgentId"),c=localStorage.getItem("selectedAgentType"),l=localStorage.getItem("selectedAgentTitle"),r={title:`${l}`,agent_id:i,duration_seconds:ie(),total_exchanges:L.length,full_conversation:_e(),transcript:L,audio_data:Pe(),audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:Le(),user_agent:navigator.userAgent,ip_address:await ze(),status:"completed",tags:["sales_call","training",c||"general"],notes:`Sales training conversation using ${l||"general"} agent `},d=await Me("/api/db/save_conversation",{method:"POST",body:JSON.stringify(r)});if(!d.ok){const a=await d.text();throw console.error("Conversation save error:",a),new Error(`Failed to save conversation: ${d.status} - ${a}`)}const y=await d.json();if(!y.success)throw new Error(`Failed to save conversation: ${y.error}`);const h=y.conversation_id;sessionStorage.setItem("conversationId",h),await new Promise(a=>setTimeout(a,500)),b.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">check_circle</span>',b.style.background="rgba(34,197,94,0.95)";const f=document.getElementById("buttonText");f&&(f.textContent="Success!",f.style.color="#059669"),window.location.href="/success.html"}catch(e){console.error("Error saving conversation:",e),alert("Failed to save conversation. Please try again.")}}function re(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}async function De(){try{const e=localStorage.getItem("currentSessionId");e&&await fetch("/clear_conversation_history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e})})}catch(e){console.error("❌ Failed to clear conversation history:",e)}}async function Be(){await De(),["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","conversationRecording","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(n=>{sessionStorage.getItem(n)&&sessionStorage.removeItem(n)}),A.length>0&&(A=[]);const t=re();localStorage.setItem("currentSessionId",t)}function ie(){const e=sessionStorage.getItem("callStartTime");if(!e)return 0;const t=new Date(e).getTime(),n=new Date().getTime();return Math.floor((n-t)/1e3)}function _e(){return L.map((e,t)=>({user:e.sender==="You"?e.text:"",assistant:e.sender==="AI"?e.text:"",timestamp:new Date().toISOString()}))}function Pe(){const e=sessionStorage.getItem("conversationRecording"),t=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("recordingDuration"),o=sessionStorage.getItem("recordingTimestamp");if(e&&t==="true"&&n&&o&&e.length>1e3&&!e.includes("audio_data_placeholder")){const s=parseInt(o);if(Date.now()-s<2*60*60*1e3)return e}return btoa("audio_data_placeholder")}function Le(){const e=sessionStorage.getItem("recordingDuration"),t=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("conversationRecording");if(e&&t==="true"&&n){const s=parseFloat(e);if(s>0&&s<7200)return s}return ie()}async function ze(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(e){return console.error("Error getting client IP:",e),"127.0.0.1"}}async function ae(){const e=localStorage.getItem("refreshToken");if(!e)return console.error("No refresh token found"),null;try{const t=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(t.ok){const n=await t.json();return localStorage.setItem("accessToken",n.access_token),localStorage.setItem("refreshToken",n.refresh_token),localStorage.setItem("tokenExpiresAt",n.expires_at),n.access_token}else return console.error("Failed to refresh token"),null}catch(t){return console.error("Error refreshing token:",t),null}}function Ne(){const e=localStorage.getItem("tokenExpiresAt");if(!e)return!0;const t=new Date(e).getTime();return new Date().getTime()>=t-5*60*1e3}async function We(){if(Ne()){const t=await ae();return t||(console.error("Failed to refresh token, redirecting to login"),localStorage.clear(),window.location.href="/login.html","")}const e=localStorage.getItem("accessToken");return e||(console.error("No access token found! User must be logged in."),window.location.href="/login.html","")}async function Me(e,t={}){const n=await We(),o=await fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(o.status===401){const s=await ae();if(s)return fetch(e,{...t,headers:{...t.headers,Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return o}let j=!1;const Oe='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic</span>',ee='<span class="material-icons" style="font-size:1.3em;color:#fff;">mic_off</span>';b.onclick=async()=>{if(j){b.innerHTML='<span class="material-icons" style="font-size:1.3em;color:#fff;">hourglass_empty</span>',b.style.background="rgba(107,114,128,0.95)",b.disabled=!0,b.style.cursor="not-allowed",we(),be(),fe(),V(!1);try{M&&await Ee(),L.length>0?await Re():window.location.href="/success.html"}catch(e){console.error("❌ Error during disconnect process:",e),b.innerHTML=ee,b.style.background="rgba(229,39,76,0.92)",b.disabled=!1,b.style.cursor="pointer",j=!0,alert("Error disconnecting. Please try again.")}}else{await Be(),me(),ye(),V(!0),Ae();const e="Hey, who's this?";Y("AI",e),te(e),ge(),b.innerHTML=ee,b.style.background="rgba(229,39,76,0.92)",j=!0}};b.innerHTML=Oe;b.style.background="rgba(37,99,235,0.95)";j=!1;Ce(!1);setInterval(()=>{!B&&R.length},3e3);document.addEventListener("click",async()=>{if(x&&x.state==="suspended")try{await x.resume()}catch(e){console.error("Failed to resume AudioContext:",e)}},{once:!0});
