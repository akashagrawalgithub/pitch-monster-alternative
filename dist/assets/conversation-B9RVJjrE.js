import"./modulepreload-polyfill-B5Qt9EMX.js";function Ce(){return localStorage.getItem("authenticated")==="true"?!0:(window.location.href="/login.html",!1)}function Re(){const t=document.createElement("div");t.id="rulesOverlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.backgroundColor="rgba(0, 0, 0, 0.7)",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.zIndex="10000",t.style.pointerEvents="auto";const e=document.createElement("div");e.style.background="#ffffff",e.style.borderRadius="16px",e.style.padding="32px",e.style.maxWidth="500px",e.style.width="90%",e.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",e.style.border="1px solid #e2e8f0",e.style.position="relative";const n=document.createElement("h2");n.innerHTML="Hey 👋 Please take a look at the rules for role-play done right.",n.style.fontSize="20px",n.style.fontWeight="700",n.style.color="#1e293b",n.style.marginBottom="24px",n.style.lineHeight="1.4";const r=document.createElement("ul");r.style.listStyle="none",r.style.padding="0",r.style.margin="0 0 24px 0",["Wear headphones and speak clearly. Don't forget smile 😊","First response can be bit delayed, please wait for AI to respond.","As soon as you finish recording, it will be sent for analysis and feedback. Take this attempt seriously!","Find a quiet place and ensure that your microphone works properly.",'Speak confidently and avoid rushing. When you finish talking, click the "Stop" icon to end the role-play'].forEach(h=>{const g=document.createElement("li");g.style.display="flex",g.style.alignItems="flex-start",g.style.gap="12px",g.style.marginBottom="16px",g.style.fontSize="15px",g.style.lineHeight="1.6",g.style.color="#475569";const f=document.createElement("span");f.innerHTML="•",f.style.color="#8b5cf6",f.style.fontWeight="bold",f.style.fontSize="18px",f.style.lineHeight="1.2";const p=document.createElement("span");p.textContent=h,g.appendChild(f),g.appendChild(p),r.appendChild(g)});const a=document.createElement("p");a.innerHTML="Let's go 🚀",a.style.fontSize="16px",a.style.fontWeight="700",a.style.color="#1e293b",a.style.marginBottom="24px",a.style.marginTop="0";const l=document.createElement("div");l.style.display="flex",l.style.alignItems="center",l.style.gap="12px",l.style.marginBottom="24px",l.style.padding="16px",l.style.background="#f8fafc",l.style.borderRadius="8px",l.style.border="1px solid #e2e8f0";const c=document.createElement("input");c.type="checkbox",c.id="rulesCheckbox",c.style.width="18px",c.style.height="18px",c.style.cursor="pointer",c.style.accentColor="#8b5cf6";const o=document.createElement("label");o.htmlFor="rulesCheckbox",o.textContent="I have read and understood the rules above",o.style.fontSize="14px",o.style.fontWeight="500",o.style.color="#475569",o.style.cursor="pointer",o.style.flex="1",l.appendChild(c),l.appendChild(o);const i=document.createElement("button");i.textContent="I agree",i.id="agreeButton",i.style.background="#e2e8f0",i.style.color="#64748b",i.style.border="none",i.style.borderRadius="12px",i.style.padding="14px 24px",i.style.fontSize="16px",i.style.fontWeight="600",i.style.cursor="not-allowed",i.style.width="100%",i.style.transition="all 0.2s",i.disabled=!0,e.appendChild(n),e.appendChild(r),e.appendChild(a),e.appendChild(l),e.appendChild(i),t.appendChild(e),document.body.appendChild(t);const u=()=>{c.checked?(i.style.background="linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)",i.style.color="white",i.style.cursor="pointer",i.disabled=!1,i.style.boxShadow="0 4px 12px rgba(139, 92, 246, 0.3)"):(i.style.background="#e2e8f0",i.style.color="#64748b",i.style.cursor="not-allowed",i.disabled=!0,i.style.boxShadow="none")};c.addEventListener("change",u),i.addEventListener("click",()=>{i.disabled||t.remove()}),t.addEventListener("click",h=>{h.target})}function Ee(){document.body.style.background="linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%)",document.body.style.fontFamily="'Inter', 'Segoe UI', Arial, sans-serif",document.body.style.margin="0",document.body.style.padding="0",document.body.style.minHeight="100vh",document.body.style.overflow="hidden",Re();const t=document.createElement("div");t.className="top-bar",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="50px",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="15px",t.style.padding="0 18px",t.style.background="rgba(255,255,255,0.25)",t.style.backdropFilter="blur(12px)",t.style.zIndex="100",t.style.boxShadow="0 2px 16px rgba(44,62,80,0.07)",t.style.overflow="visible";const e=document.createElement("button");e.innerHTML="← Back to details",e.style.position="fixed",e.style.top="8px",e.style.left="18px",e.style.background="rgba(255,255,255,0.9)",e.style.border="1px solid rgba(0,0,0,0.1)",e.style.borderRadius="8px",e.style.padding="6px 12px",e.style.fontSize="13px",e.style.fontWeight="500",e.style.color="#374151",e.style.cursor="pointer",e.style.transition="all 0.2s",e.style.zIndex="200",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",e.onclick=()=>window.location.href="/agent-info.html",e.onmouseover=()=>{e.style.background="rgba(255,255,255,0.95)",e.style.transform="translateY(-1px)"},e.onmouseout=()=>{e.style.background="rgba(255,255,255,0.9)",e.style.transform="translateY(0)"};const n=localStorage.getItem("selectedAgentType")||"payment-followup",r={"payment-followup":"Payment Follow-up Training","competitor-objection":"Competitor Objection Training","lead-to-demo":"Lead to Demo Training","closing-skills":"Closing Skills Training","cold-calling":"Cold Calling Training","discovery-call":"Discovery Call Training"},s=document.createElement("div");s.textContent=r[n]||"Sales Training",s.style.fontSize="18px",s.style.fontWeight="500",s.style.letterSpacing="0.5px",s.style.color="#23272f",s.style.opacity="0.92",s.style.whiteSpace="nowrap";const a=document.createElement("div");a.style.display="flex",a.style.alignItems="center",a.style.gap="8px",a.style.fontSize="1.1rem",a.style.color="#23272f",a.style.fontWeight="500",a.style.opacity="0.85",a.style.whiteSpace="nowrap";const l=document.createElement("span");l.id="timer",l.textContent="00:00";const c=document.createElement("span");c.id="recordingDot",c.textContent="•",c.style.fontSize="1.5em",c.style.color="#e11d48",c.style.opacity="0",c.style.transition="opacity 0.3s",a.appendChild(l),a.appendChild(c),t.appendChild(e),t.appendChild(s),t.appendChild(a),document.body.appendChild(t);const o=document.createElement("div");o.id="customerName",o.style.position="fixed",o.style.left="50%",o.style.top="50px",o.style.transform="translateX(-50%)",o.style.zIndex="10",o.style.color="#1e293b",o.style.fontSize="16px",o.style.fontWeight="600",o.style.textAlign="center",o.style.whiteSpace="nowrap",o.style.pointerEvents="none",o.style.background="rgba(255, 255, 255, 0.9)",o.style.padding="8px 16px",o.style.marginTop="36px",o.style.borderRadius="20px",o.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.1)",o.style.border="1px solid rgba(226, 232, 240, 0.8)";const i=localStorage.getItem("selectedAgentName")||"Customer";o.textContent=`Customer Name: ${i}`,document.body.appendChild(o);const u=document.createElement("div");u.className="voice-wave-area",u.id="voiceWaveArea",u.style.position="fixed",u.style.top="50px",u.style.left="0",u.style.width="100vw",u.style.height="calc(100vh - 50px)",u.style.display="flex",u.style.flexDirection="column",u.style.justifyContent="center",u.style.alignItems="center",u.style.zIndex="1",u.style.background="transparent";const h=document.createElement("div");h.className="voice-wave-container",h.id="voiceWaveContainer",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.gap="4px",h.style.height="60px";for(let H=0;H<20;H++){const C=document.createElement("div");C.className="voice-wave-bar",C.style.width="3px",C.style.height="4px",C.style.background="rgba(37,99,235,0.3)",C.style.borderRadius="2px",C.style.transition="height 0.1s ease",h.appendChild(C)}u.appendChild(h),document.body.appendChild(u);const g=document.createElement("div");g.id="hiddenTranscript",g.style.display="none",document.body.appendChild(g);const f=document.createElement("div");f.className="mic-wrap",f.style.position="fixed",f.style.left="50%",f.style.bottom="48px",f.style.transform="translateX(-50%)",f.style.zIndex="20",f.style.display="flex",f.style.flexDirection="row",f.style.alignItems="center",f.style.gap="24px";const p=document.createElement("div");p.className="ocean-animation",p.style.position="absolute",p.style.left="50%",p.style.top="50%",p.style.transform="translate(-50%, -50%)",p.style.zIndex="-1",p.style.pointerEvents="none",p.style.width="160px",p.style.height="160px";const d=document.createElement("button");d.className="voice-btn mic-btn",d.id="micBtn",d.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>',d.style.minWidth="180px",d.style.height="50px",d.style.borderRadius="25px",d.style.background="#8b5cf6",d.style.color="#fff",d.style.border="none",d.style.boxShadow="0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08)",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.style.padding="0 24px",d.style.cursor="pointer",d.style.transition="background 0.2s, box-shadow 0.2s, transform 0.2s",d.style.position="relative",d.style.outline="none",d.style.visibility="visible",f.appendChild(d),f.appendChild(p),document.body.appendChild(f);const k=document.createElement("link");k.rel="stylesheet",k.href="https://fonts.googleapis.com/icon?family=Material+Icons",document.head.appendChild(k);const y=document.createElement("style");y.textContent=`
        html, body {
            height: 100%;
            width: 100vw;
            overflow: hidden;
        }
        .top-bar {
            user-select: none;
            overflow: visible;
        }
        /* Voice wave animation */
        .voice-wave-bar {
            animation: voiceWave 1.5s ease-in-out infinite;
        }
        .voice-wave-bar:nth-child(odd) {
            animation-delay: 0.1s;
        }
        .voice-wave-bar:nth-child(even) {
            animation-delay: 0.2s;
        }
        .voice-wave-bar:nth-child(3n) {
            animation-delay: 0.3s;
        }
        .voice-wave-bar:nth-child(4n) {
            animation-delay: 0.4s;
        }
        .voice-wave-bar:nth-child(5n) {
            animation-delay: 0.5s;
        }
        @keyframes voiceWave {
            0%, 100% { height: 4px; opacity: 0.3; }
            50% { height: 40px; opacity: 0.8; }
        }
        /* Active voice wave when speaking */
        .voice-wave-bar.active {
            animation: activeVoiceWave 0.8s ease-in-out infinite;
        }
        @keyframes activeVoiceWave {
            0%, 100% { height: 8px; opacity: 0.4; }
            50% { height: 50px; opacity: 1; }
        }
        .mic-btn {
            box-shadow: 0 8px 32px rgba(37,99,235,0.18), 0 2px 8px rgba(44,62,80,0.08);
        }
        .mic-btn:active {
            transform: scale(0.96);
        }
        .mic-btn:not(:disabled):hover {
            background: #174bbd;
            box-shadow: 0 12px 36px rgba(37,99,235,0.22);
        }
        .end-btn {
            margin-left: 24px;
            box-shadow: 0 4px 16px rgba(229,39,76,0.13);
        }
        .end-btn:active {
            transform: scale(0.96);
        }
        .end-btn:not(:disabled):hover {
            background: #c81d4a;
            box-shadow: 0 8px 24px rgba(229,39,76,0.18);
        }
        .voice-btn:disabled, .end-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #recordingDot.active {
            opacity: 1 !important;
            animation: pulse 1.2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        /* Ocean animation */
        .ocean-animation {
            pointer-events: none;
        }
        .ocean-animation .wave {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            opacity: 0.45;
            background: radial-gradient(circle, #a8edea 0%, #2563eb 100%);
            animation: waveAnim 2.5s infinite cubic-bezier(.23,1.01,.32,1);
        }
        .ocean-animation .wave.wave2 {
            opacity: 0.25;
            animation-delay: 1.2s;
        }
        @keyframes waveAnim {
            0% { width: 0; height: 0; opacity: 0.45; }
            70% { opacity: 0.18; }
            100% { width: 160px; height: 160px; opacity: 0; }
        }
        @media (max-width: 700px) {
            .top-bar { padding: 0 6px; height: 48px; }
            .transcript-bg { top: 48px; height: calc(100vh - 48px); }
            .mic-wrap { bottom: 18px; }
            .transcript-list { max-width: 98vw; padding: 0 2vw; }
        }
    `,document.head.appendChild(y);function U(H){if(p.innerHTML="",H)for(let C=0;C<2;C++){const D=document.createElement("div");D.className="wave"+(C===1?" wave2":""),D.style.width="0px",D.style.height="0px",D.style.background="radial-gradient(circle, #a8edea 0%, #2563eb 100%)",D.style.position="absolute",D.style.left="50%",D.style.top="50%",D.style.transform="translate(-50%, -50%)",p.appendChild(D)}}window.showOceanAnimation=U}Ce()?Ee():window.location.href="/login.html";let m=null,b=!1,v=!1,re=null,V=0,_=[],T=!1,Q=!1,w=null,ue=!1,L=[],B=!1,S=null,W=[],z=!1,J="",be=null,le=!1,$=!1,xe=!1,R=null,E=[],K=!1,ae=null,ce=0,I=null,M=null;const x=document.getElementById("micBtn"),fe=document.getElementById("timer"),De=document.getElementById("voiceWaveContainer"),pe=document.getElementById("hiddenTranscript");let A="";function ie(t){const e=Math.floor(t/60).toString().padStart(2,"0"),n=(t%60).toString().padStart(2,"0");return`${e}:${n}`}function _e(){V=0,sessionStorage.setItem("callStartTime",new Date().toISOString()),fe.textContent=ie(V),re=window.setInterval(()=>{V++,fe.textContent=ie(V)},1e3)}function me(){re&&(clearInterval(re),re=null)}function F(t,e){const n=ie(V);_.push({sender:t,text:e,time:n});const r=document.createElement("div");r.className="transcript-item "+(t==="AI"?"ai":"you"),r.innerHTML=`
        <div class="transcript-avatar">${t==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content">${e}</div>
        <div class="transcript-meta">${t}  ${n}</div>
    `,pe.appendChild(r)}function Be(){_=[],pe.innerHTML=""}function ve(){if(b||v||T)return;const t=window.SpeechRecognition||window.webkitSpeechRecognition;if(!t){alert("Your browser does not support Web Speech API.");return}if(m=new t,m.lang="en-US",m.interimResults=!0,m.maxAlternatives=1,m.continuous=!0,"webkitSpeechRecognition"in window){m.continuous=!0,m.interimResults=!0,m.maxAlternatives=1;try{m.serviceURI="https://www.google.com/speech-api/v2/recognize"}catch{}}b=!0,v=!1;let e="";A="";let n=null,r=null;m.onresult=a=>{($||ue||B)&&ze();let l="",c=!1;for(let o=a.resultIndex;o<a.results.length;o++){const i=a.results[o][0].transcript;a.results[o].isFinal?(e+=i,A+=i,c=!0):l+=i}if(l&&!c){n||(n=Te("You"));const o=(A+" "+l).trim();n.update(o),se(!0),r&&(clearTimeout(r),r=null)}c&&e.trim()&&(r=window.setTimeout(()=>{if(e.trim().length>0){const o=e.trim();if(e="",o.length>=3){typeof performance<"u"?performance.now():Date.now(),Oe(o),A="";const i=document.querySelector(".transcript-item.you .transcript-content");i&&(i.textContent="")}else A+=" "+o}r=null},700))},m.onerror=a=>{console.error("Speech recognition error:",a.error),a.error==="network"?(console.warn("Network error in speech recognition, attempting restart..."),setTimeout(()=>{b&&!T&&(m==null||m.start())},1e3)):a.error==="aborted"?(console.log("Speech recognition was aborted"),b=!1,v=!1,T=!1):a.error==="audio-capture"?(console.error("Audio capture error - microphone issue"),b=!1,v=!1,T=!1,alert("Microphone access error. Please check your microphone permissions and try again.")):a.error==="not-allowed"?(console.error("Speech recognition not allowed"),b=!1,v=!1,T=!1,alert("Speech recognition permission denied. Please allow microphone access and reload the page.")):(console.warn(`Speech recognition error: ${a.error}, attempting restart...`),T=!1,setTimeout(()=>{b&&!T&&O("error-recovery")},2e3))},m.onstart=()=>{T=!0},m.onend=()=>{if(T=!1,b&&!v&&!T&&b){const a=n?n.getText():"",l=e,c=A;setTimeout(()=>{b&&!T&&(l&&(e=l),c&&(A=c),O("natural-end"),a&&n&&setTimeout(()=>{n&&n.update(a)},150))},100)}},m.start(),m.startTime=Date.now();const s=setInterval(()=>{if(!b){clearInterval(s);return}const a=Date.now();if(m&&m.startTime&&a-m.startTime>2*60*1e3){m.startTime=a,O("mandatory-2min-restart");return}if(b&&!T&&!v&&!Q){O("critical-restart");return}if(b&&!T&&a-((m==null?void 0:m.startTime)||0)>3e4){O("long-inactive-restart");return}if(b&&!Y&&!N){te().catch(l=>{console.error("Reconnection failed:",l),setTimeout(()=>{b&&te()},1e3)});return}},1e3)}function ze(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),S){try{S.stop(),S.disconnect()}catch{}S=null}L=[],q=[],ue=!1,B=!1,z=!1,W=[],$=!1}function Pe(){if(window.speechSynthesis&&window.speechSynthesis.cancel(),S){try{S.stop(),S.disconnect()}catch{}S=null}L=[],ue=!1,B=!1,W=[],z=!1}function O(t="manual"){if(!(Q||!b)){Q=!0;try{m&&T&&m.stop(),setTimeout(()=>{if(b&&!T)try{m==null||m.start()}catch(e){console.error("Restart failed:",e),ve()}Q=!1},100)}catch(e){console.error("Error in safe restart:",e),Q=!1}}}function Me(){if(b=!1,v=!1,T=!1,Q=!1,m)try{m.stop()}catch{}if(A.trim()||J.trim()){const e=[];A&&A.trim()&&e.push(A.trim()),J&&J.trim()&&e.push(J.trim());const n=document.querySelector(".transcript-item.you .transcript-content");if(n&&n.textContent&&n.textContent.trim()){const r=n.textContent.trim();r.length>0&&e.push(r)}}J="",A="";const t=document.querySelector(".transcript-item.you .transcript-content");t&&(t.textContent="")}async function Le(t){try{const e=await fetch("/tts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const n=await e.json();await We(n.audio_data,"pcm_f32le",n.sample_rate)}catch(e){if(console.error("Cartesia TTS error:",e),window.speechSynthesis){const n=new SpeechSynthesisUtterance(t);n.rate=.9,n.pitch=1,window.speechSynthesis.speak(n)}}}async function We(t,e="pcm_f32le",n=44100){const r=Uint8Array.from(atob(t),s=>s.charCodeAt(0));await Se(r.buffer,n)}async function Ne(t){try{const e=$e(t),n=new FormData;n.append("file",e,"ai_response.wav"),n.append("model","whisper-1"),n.append("language","en");const r=await Ie(),s=await fetch("/api/db/transcribe_audio",{method:"POST",headers:{Authorization:`Bearer ${r}`},body:n});if(s.ok){const a=await s.json(),l=a.text||a.transcript||"AI response transcribed";F("AI",l)}else{const a=await s.text();console.error("Audio transcription failed:",s.status,a);const l=_.filter(o=>o.sender==="You").pop();let c="[AI provided audio response]";if(l){const o=l.text.toLowerCase();o.includes("sales skill")||o.includes("practice")?c="I'd be happy to help you practice your sales skills! What specific area would you like to work on?":o.includes("close")||o.includes("deal")?c="Great! Let's work on your closing techniques. What type of deals are you looking to close?":o.includes("name")?c="I'm your AI sales training coach. I'm here to help you improve your sales skills!":c="I understand. Let me help you with that. Can you tell me more about what you'd like to work on?"}F("AI",c)}}catch(e){console.error("Error transcribing AI audio:",e),F("AI","[AI Response - Audio Only]")}}function $e(t){const e=t.length,n=t.sampleRate,r=new ArrayBuffer(44+e*2),s=new DataView(r),a=(o,i)=>{for(let u=0;u<i.length;u++)s.setUint8(o+u,i.charCodeAt(u))};a(0,"RIFF"),s.setUint32(4,36+e*2,!0),a(8,"WAVE"),a(12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,1,!0),s.setUint32(24,n,!0),s.setUint32(28,n*2,!0),s.setUint16(32,2,!0),s.setUint16(34,16,!0),a(36,"data"),s.setUint32(40,e*2,!0);const l=t.getChannelData(0);let c=44;for(let o=0;o<e;o++){const i=Math.max(-1,Math.min(1,l[o]));s.setInt16(c,i<0?i*32768:i*32767,!0),c+=2}return new Blob([r],{type:"audio/wav"})}async function Se(t,e){if(w||(w=new(window.AudioContext||window.webkitAudioContext)),w.state==="suspended")try{await w.resume()}catch(n){console.error("Failed to resume audio context:",n);return}try{const n=w.createBuffer(1,t.byteLength/4,e),r=n.getChannelData(0),s=new Float32Array(t);r.set(s),S&&(S.stop(),S.disconnect()),S=w.createBufferSource(),S.buffer=n,S.connect(w.destination),I&&K&&S.connect(I),!le&&be!=null&&(le=!0),S.start()}catch(n){console.error("Error playing raw PCM audio:",n)}}function Oe(t){if(v||$)return;v=!0,$=!0,F("You",t);const e=Te("AI");let n="",r="";be=typeof performance<"u"?performance.now():Date.now(),le=!1,xe=!1;const s=setTimeout(()=>{v&&(v=!1,$=!1)},15e3);Ye(t,a=>{if(n+=a,e.update(n),r+=a,Fe(r)){const l=ye(r);l.length>0&&(W.push(...l),r="",z||(typeof performance<"u"?performance.now():Date.now(),ge()))}}).then(()=>{if(r.trim()){const a=ye(r.trim());W.push(...a),z||(typeof performance<"u"?performance.now():Date.now(),ge())}n.trim()&&F("AI",n.trim()),n="",r="",v=!1,$=!1,clearTimeout(s),setTimeout(()=>{b&&!T&&!v&&O("after-ai-response")},500),Xe(),window.gc&&window.gc()}).catch(a=>{console.error("AI response error:",a.message),n="",r="",v=!1,$=!1,clearTimeout(s),setTimeout(()=>{b&&!T&&!v&&O("after-ai-error")},1e3),window.gc&&window.gc()})}function Fe(t){return!!(/[.!?]\s*$/.test(t)||/, \s*$/.test(t)||t.length>150)}function ye(t){const e=t.trim();if(!e)return[];if(/[.!?]\s*$/.test(e))return[e];if(/, \s*$/.test(e))return[e];if(e.length>150){const n=e.match(/.*[.!?]\s*$/);if(n)return[n[0].trim()]}return[]}async function Ue(){if(!(L.length===0||B)){for(B=!0;L.length>0;){const t=L.shift();try{await Se(t,44100),S&&await new Promise(e=>{S.onended=()=>e()})}catch(e){console.error("Error playing audio from queue:",e)}}B=!1,setTimeout(()=>{He()},500)}}async function ge(){if(!z){for(z=!0;W.length>0;){const t=W.splice(0,2);for(let e=0;e<t.length;e++){const n=t[e];try{const r=await je(n);L.push(r),B||Ue()}catch(r){console.error("Cartesia TTS error:",r);try{await Le(n)}catch(s){console.error("Fallback TTS error:",s)}}}}z=!1}}function He(){!z&&L.length}async function je(t){return new Promise((e,n)=>{fetch("/tts_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t})}).then(r=>{var i;if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const s=(i=r.body)==null?void 0:i.getReader(),a=new TextDecoder("utf-8");let l="",c=[];async function o(){try{const{done:u,value:h}=await s.read();if(u){if(c.length>0){const f=new Uint8Array(c.reduce((d,k)=>d+k.length,0));let p=0;for(const d of c)f.set(d,p),p+=d.length;c=[],window.gc&&window.gc(),e(f.buffer)}else n(new Error("No audio data received"));return}l+=a.decode(h,{stream:!0});let g=l.split(/\r?\n/);l=g.pop()||"";for(const f of g)if(f.startsWith("data: "))try{const p=JSON.parse(f.slice(6));if(p.audio_chunk){const d=Uint8Array.from(atob(p.audio_chunk),k=>k.charCodeAt(0));c.push(d)}else p.status==="complete"||p.error&&n(new Error(p.error))}catch{}o()}catch(u){n(u)}}o()}).catch(n)})}function Te(t){const e=ie(V),n=document.createElement("div");n.className="transcript-item "+(t==="AI"?"ai":"you"),n.innerHTML=`
        <div class="transcript-avatar">${t==="AI"?"🤖":"🧑"}</div>
        <div class="transcript-content"></div>
        <div class="transcript-meta">${t}  ${e}</div>
    `;const r=n.querySelector(".transcript-content");return pe.appendChild(n),{update:s=>{r.textContent=s},remove:()=>{r.textContent=""},getText:()=>r.textContent||""}}let X=null,Y=!1,N=!1,j=null,q=[],he=24e3,ne="",P=0,G="";async function Je(){const t=localStorage.getItem("selectedAgentType")||"discovery-call";try{const e=await fetch(`/api/get_agent_prompt?agent_type=${t}`);if(e.ok){const n=await e.json();n.success&&n.prompt?G=n.prompt:(console.error("Invalid response format:",n),G="You are a helpful sales training coach. Speak naturally and concisely.")}else{const n=await e.text();console.error("Failed to fetch agent prompt:",e.status,n),G="You are a helpful sales training coach. Speak naturally and concisely."}}catch(e){console.error("Error fetching agent prompt:",e),G="You are a helpful sales training coach. Speak naturally and concisely."}}function te(t){return new Promise((e,n)=>{if(Y&&X){j=t||null,e();return}if(N){const c=setInterval(()=>{Y&&(clearInterval(c),j=t||null,e())},100);return}const r=window.location.protocol==="https:"?"wss:":"ws:",s=window.location.host,a=`${r}//${s}/ws/openai-realtime`;N=!0,j=t||null;const l=new WebSocket(a);X=l,l.onopen=()=>{Y=!0,N=!1;const o={type:"session.update",session:{type:"realtime",model:"gpt-4o-realtime-preview",instructions:G||"You are a helpful sales training coach.",voice:"alloy",tools:[],tool_choice:"none"}};l.send(JSON.stringify(o)),setTimeout(()=>{const i={type:"response.create",response:{instructions:"Start the conversation by saying: 'Hey, who's this?'"}};l.send(JSON.stringify(i))},500),e()},l.onerror=c=>{N=!1,console.error("Realtime WebSocket error:",c),n(new Error("Realtime WebSocket error"))},l.onclose=c=>{Y=!1,N=!1,X=null,j=null,q=[],b&&setTimeout(()=>{b&&!Y&&!N&&te()},2e3)},l.onmessage=async c=>{try{const o=JSON.parse(c.data),i=o.type;if(i==="response.output_text.delta"){const u=o.delta;if(u&&u.includes("tool_uses"))return;o.delta&&(ne+=o.delta),j&&o.delta&&j(o.delta)}else if(i!=="response.output_text.done")if(i==="response.output_audio.delta"){xe=!0;const u=o.delta;if(u){const h=atob(u),g=new Int16Array(h.length/2);for(let y=0;y<h.length;y+=2)g[y/2]=h.charCodeAt(y)|h.charCodeAt(y+1)<<8;q.push(g);const f=new Float32Array(g.length);for(let y=0;y<g.length;y++)f[y]=Math.max(-1,Math.min(1,g[y]/32768));w||(w=new(window.AudioContext||window.webkitAudioContext)),w.state==="suspended"&&await w.resume();const p=w.createBuffer(1,f.length,he);p.copyToChannel(f,0);const d=w.createBufferSource();d.buffer=p,d.connect(w.destination),I&&K&&d.connect(I);const k=p.duration;(P===0||P<w.currentTime)&&(P=w.currentTime),d.start(P),P+=k,S=d}}else if(i==="response.output_audio.done"){const u=q.reduce((d,k)=>d+k.length,0),h=new Int16Array(u);let g=0;for(const d of q)h.set(d,g),g+=d.length;const f=new Float32Array(h.length);for(let d=0;d<h.length;d++)f[d]=Math.max(-1,Math.min(1,h[d]/32768));w||(w=new(window.AudioContext||window.webkitAudioContext));const p=w.createBuffer(1,f.length,he);p.copyToChannel(f,0),window.lastAIAudioBuffer=p,window.lastAIAudioTime=Date.now(),q=[],P=0}else if(i==="response.created")ne="",P=0;else if(i==="response.done"){let u=ne.trim();u.includes("tool_uses")&&(u=u.replace(/\{"tool_uses":\[.*?\]\}/g,"").trim()),u?F("AI",u):window.lastAIAudioBuffer?Ne(window.lastAIAudioBuffer):F("AI","[AI provided audio response]"),ne=""}else i==="session.updated"||i==="error"&&(console.error("Realtime error:",o),console.error("Error details:",JSON.stringify(o.error,null,2)))}catch{}}})}async function Ye(t,e){if(await te(e),!X)return;const n={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:t}]}};X.send(JSON.stringify(n));const r={type:"response.create"};X.send(JSON.stringify(r))}function qe(t){const e=document.getElementById("recordingDot");e&&e.classList.remove("active"),window.showOceanAnimation&&window.showOceanAnimation(t)}function se(t){De.querySelectorAll(".voice-wave-bar").forEach(n=>{t?n.classList.add("active"):n.classList.remove("active")})}async function Ve(){try{const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});ae=t,w||(w=new(window.AudioContext||window.webkitAudioContext)),I=w.createMediaStreamDestination(),M=w.createMediaStreamSource(t),M.connect(I);let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="audio/webm"),MediaRecorder.isTypeSupported(e)||(e="audio/mp4"),MediaRecorder.isTypeSupported(e)||(e="audio/ogg;codecs=opus"),MediaRecorder.isTypeSupported(e)||(e="audio/wav"),R=new MediaRecorder(I.stream,{mimeType:e}),E=[],K=!0,ce=Date.now(),R.ondataavailable=n=>{n.data.size>0&&E.push(n.data)},R.onstop=()=>{if(E.length>0){const n=new Blob(E,{type:e}),r=new FileReader;r.onload=()=>{const s=r.result;window.conversationRecordingData=s,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const a=(Date.now()-ce)/1e3;sessionStorage.setItem("recordingDuration",a.toString())},r.readAsDataURL(n)}M&&(M.disconnect(),M=null),I&&(I.disconnect(),I=null),t&&t.getTracks().forEach(n=>n.stop())},R.start(1e3)}catch(t){console.error("Error starting audio recording:",t),alert("Could not access microphone for recording. Please allow microphone access and try again.")}}async function Qe(){return new Promise((t,e)=>{if(!R||!K){t();return}K=!1;const n=setTimeout(()=>{console.error("Audio recording stop timeout - forcing cleanup"),oe(),e(new Error("Audio recording stop timeout"))},1e4);R.onstop=()=>{if(clearTimeout(n),E.length>0){const r=new Blob(E,{type:(R==null?void 0:R.mimeType)||"audio/webm"}),s=new FileReader;s.onload=()=>{const a=s.result;window.conversationRecordingData=a,sessionStorage.setItem("hasRecording","true"),sessionStorage.setItem("recordingTimestamp",Date.now().toString());const l=(Date.now()-ce)/1e3;sessionStorage.setItem("recordingDuration",l.toString()),oe(),t()},s.readAsDataURL(r)}else oe(),t()};try{R.stop()}catch(r){clearTimeout(n),console.error("Error stopping media recorder:",r),oe(),e(r)}})}function oe(){M&&(M.disconnect(),M=null),I&&(I.disconnect(),I=null),ae&&(ae.getTracks().forEach(t=>t.stop()),ae=null),R=null,E=[]}async function Ge(){try{x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">save</span><span style="font-size:15px;font-weight:600;">Saving...</span>',x.style.background="rgba(34,197,94,0.95)",await new Promise(y=>setTimeout(y,100));const t=sessionStorage.getItem("hasRecording"),e=window.conversationRecordingData,n=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(!t||t!=="true"||!e){await new Promise(H=>setTimeout(H,500));const y=sessionStorage.getItem("hasRecording"),U=window.conversationRecordingData;(!y||y!=="true"||!U)&&console.error("Still no audio recording after retry")}sessionStorage.setItem("chatTranscript",JSON.stringify(_));const s=localStorage.getItem("selectedAgentId"),a=localStorage.getItem("selectedAgentType"),l=localStorage.getItem("selectedAgentTitle"),c=et(),o=c.length/1024/1024;let i=null,u=c;if(o>5)try{const y=await we("/api/db/upload_audio",{method:"POST",body:JSON.stringify({audio_data:c,filename:`conversation_${Date.now()}.webm`})});y.ok?(i=(await y.json()).audio_url,u=btoa(`stored_in_supabase_storage:${i}`)):u=btoa(`upload_failed_${o.toFixed(2)}MB`)}catch(y){console.error("Audio upload error:",y),u=btoa(`upload_error_${o.toFixed(2)}MB`)}const h={title:`${l}`,agent_id:s,duration_seconds:de(),total_exchanges:_.length,full_conversation:Ze(),transcript:_,audio_data:u,audio_url:i,audio_format:"pcm_f32le",sample_rate:44100,audio_duration_seconds:tt(),user_agent:navigator.userAgent,ip_address:await nt(),status:"completed",tags:["sales_call","training",a||"general"],notes:`Sales training conversation using ${l||"general"} agent `},g=new Promise((y,U)=>setTimeout(()=>U(new Error("Database save timeout after 30 seconds")),3e4)),f=we("/api/db/save_conversation",{method:"POST",body:JSON.stringify(h)}),p=await Promise.race([f,g]);if(!p.ok){const y=await p.text();throw console.error("Conversation save error:",y),new Error(`Failed to save conversation: ${p.status} - ${y}`)}const d=await p.json();if(!d.success)throw new Error(`Failed to save conversation: ${d.error}`);const k=d.conversation_id;sessionStorage.setItem("conversationId",k),await new Promise(y=>setTimeout(y,500)),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">check_circle</span><span style="font-size:15px;font-weight:600;">Success!</span>',x.style.background="rgba(34,197,94,0.95)",window.location.href="/success.html"}catch(t){console.error("Error saving conversation:",t);const e=t.message.toLowerCase();if(e.includes("timeout")||e.includes("too large")){alert("Conversation was too long for database storage. The transcript has been saved locally, but audio recording was not saved due to size limits.");const n={timestamp:new Date().toISOString(),duration:de(),transcript:_,agent_type:localStorage.getItem("selectedAgentType")};localStorage.setItem("lastConversationBackup",JSON.stringify(n)),window.location.href="/success.html"}else alert("Failed to save conversation. Please try again."),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",ee=!0}}function ke(){W=[],A="",J="",E=[],window.gc&&window.gc()}function Xe(){const t=window.conversationRecordingData?window.conversationRecordingData.length:0,e=W.join("").length;t+e>10*1024*1024&&ke()}function Ke(){["analysisData","currentAnalysisData","analysisId","conversationId","chatTranscript","recordingDuration","hasRecording","recordingTimestamp","callStartTime"].forEach(e=>{sessionStorage.getItem(e)&&sessionStorage.removeItem(e)}),E.length>0&&(E=[]),window.conversationRecordingData=null,ke()}function de(){const t=sessionStorage.getItem("callStartTime");if(!t)return 0;const e=new Date(t).getTime(),n=new Date().getTime();return Math.floor((n-e)/1e3)}function Ze(){return _.map((t,e)=>({user:t.sender==="You"?t.text:"",assistant:t.sender==="AI"?t.text:"",timestamp:new Date().toISOString()}))}function et(){const t=window.conversationRecordingData,e=sessionStorage.getItem("hasRecording"),n=sessionStorage.getItem("recordingDuration"),r=sessionStorage.getItem("recordingTimestamp");if(t&&e==="true"&&n&&r&&t.length>1e3&&!t.includes("audio_data_placeholder")){const s=parseInt(r);if(Date.now()-s<2*60*60*1e3)return t}return btoa("audio_data_placeholder")}function tt(){const t=sessionStorage.getItem("recordingDuration"),e=sessionStorage.getItem("hasRecording"),n=window.conversationRecordingData;if(t&&e==="true"&&n){const s=parseFloat(t);if(s>0&&s<7200)return s}return de()}async function nt(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip}catch(t){return console.error("Error getting client IP:",t),"127.0.0.1"}}async function Ae(){const t=localStorage.getItem("refreshToken");if(!t)return console.error("No refresh token found"),null;try{const e=await fetch("/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:t})});if(e.ok){const n=await e.json();return localStorage.setItem("accessToken",n.access_token),localStorage.setItem("refreshToken",n.refresh_token),localStorage.setItem("tokenExpiresAt",n.expires_at),n.access_token}else return console.error("Failed to refresh token"),null}catch(e){return console.error("Error refreshing token:",e),null}}function ot(){const t=localStorage.getItem("tokenExpiresAt");if(!t)return!0;const e=new Date(t).getTime();return new Date().getTime()>=e-5*60*1e3}async function Ie(){if(ot()){const e=await Ae();return e||(console.error("Failed to refresh token"),localStorage.clear(),window.location.href="/login.html","")}const t=localStorage.getItem("accessToken");return t||(console.error("No access token found"),window.location.href="/login.html","")}async function we(t,e={}){const n=await Ie(),r=await fetch(t,{...e,headers:{...e.headers,Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(r.status===401){const s=await Ae();if(s)return fetch(t,{...e,headers:{...e.headers,Authorization:`Bearer ${s}`,"Content-Type":"application/json"}});throw localStorage.clear(),window.location.href="/login.html",new Error("Authentication failed")}return r}let ee=!1;x.onclick=async()=>{if(ee){x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">hourglass_empty</span><span style="font-size:15px;font-weight:600;">Processing...</span>',x.style.background="rgba(107,114,128,0.95)",x.disabled=!0,x.style.cursor="not-allowed",Pe(),Me(),me(),se(!1);try{K&&await Qe(),_.length>0?await Ge():window.location.href="/success.html"}catch(t){console.error("Error during disconnect process:",t),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",x.disabled=!1,x.style.cursor="pointer",ee=!0,alert("Error disconnecting. Please try again.")}}else{await Ke(),G||await Je(),Be(),_e(),se(!0);try{await te()}catch{alert("Failed to establish realtime connection. Please check your network connection and try again."),se(!1),me();return}Ve(),ve(),x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic_off</span><span style="font-size:15px;font-weight:600;">Stop Recording</span>',x.style.background="rgba(229,39,76,0.92)",ee=!0}};x.innerHTML='<span class="material-icons" style="font-size:20px;color:#fff;margin-right:8px;">mic</span><span style="font-size:15px;font-weight:600;">Start Recording</span>';x.style.background="#8b5cf6";ee=!1;qe(!1);let Z=0;setInterval(()=>{!z&&L.length===0&&!B&&(v||(Z=0)),v&&(Z===0?Z=Date.now():Date.now()-Z>12e4&&(console.error("isProcessing stuck for 2+ minutes"),v=!1,Z=0))},3e3);document.addEventListener("click",async()=>{if(w&&w.state==="suspended")try{await w.resume()}catch(t){console.error("Failed to resume AudioContext:",t)}},{once:!0});
